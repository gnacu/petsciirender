<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>
            C64 PETSCII Art Generator v7
        </title>
        <style type='text/css'>
            .button {
                background-color: #000000; /* Black */
                border: 1px solid black;
                border-color: #000000;
                color: white;
                padding: 2px 4px;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 16px;
            }
            .button:hover {
                background-color: #FFFFFF; /* White */
                color: black;
            }
        </style>
    </head>
    <body onload='Init();'>
        <script type='text/javascript'>
            // v1: Originally written by Gregory Nacu.
            //     Add black/white support, dithering, and color matching algorithm.
            //     Visit https://c64os.com and https://c64os.com/post/petsciiartrenderer
            //     for more information.
            //
            // v2: Enhancement by Warren Wilbur.
            //     Add grayscale working image support (when dithering is disabled) and
            //     render using addition of absolute color differences (better results
            //     for photographic source images).
            //
            // v3: Enhancement by Warren Wilbur.
            //     Add grayscale (multiple color support) and render character sets
            //     (in each selected color) to support grayscale PETSCII output.
            //     Cleanup interface to support incremental processing (top-to-bottom).
            //     Add contrast and brightness adjustment.
            //
            // v4: Enhancement by Warren Wilbur.
            //     Add support for all sixteen C64 colors. Add support for changing
            //     background color.
            //
            // v5: Enhancement by Warren Wilbur.
            //     Add color negative support. Add shortcut buttons for black/white,
            //     grayscale, blues, greens, browns, and reds color sets. Add support
            //     for custom character sets. Add support for C64 extended (background)
            //     color mode (implement multiple background color register values for
            //     VIC-II and color ram, to accurately represent the color limitations
            //     of the VIC-II standard and extended modes). Add C64 US upper-case
            //     character set. Add C64OS output format. Add auto-rendering option
            //     for easier tuning of working image changes. Re-order page to allow
            //     working image changes to be visible together with PETSCII output.
            //
            // v6: Enhancement by Warren Wilbur.
            //     Add new binary and assembly save/export formats to output PETSCII
            //     codes and colors to facilitate import into external PETSCII
            //     editors. Cleanup file save/export format descriptions.
            //
            // v7: Enhancement by Warren Wilbur.
            //     Add exponential color difference algorithm (so character colors that
            //     miss by a single large amount won't compete with character colors that
            //     miss by multiple small amounts). Add project save/load file (JSON).
            //     Provide color substitutions in output (to minimize PETSCII editor
            //     time in post-processing).
            //
            //TODO v8: Planned enhancement. Add additional rendering improvements (see
            //     findMatch). Characters that are the wrong shape but the right color
            //     will match perfectly (i.e. black '@' will match blank). Characters
            //     that contain pixels that miss (the ideal) by 1 or more pixels are
            //     treated equally (a miss by a bit is the same as a miss by alot).
            //     It would be nice to score shape (from grayscale image) and color
            //     (from color image) separately and let the user balance shape v.s.
            //     color accuracy in the rendering output. Define color averaging
            //     for specific characters (which are dithered, single color score).
            //     
            //TODO v9: Planned enhancement. 
            //     Add support for either web service or command line usage (for
            //     build toolchain use) for automatically converting image files.
            var CHARACTERS = 256;
            var WIDTH      = 320;
            var HEIGHT     = 200;
            var CWIDTH     = 8;
            var CHEIGHT    = 8;

            var C64_COLOR_CODE_BLACK =       0;
            var C64_COLOR_CODE_WHITE =       1;
            var C64_COLOR_CODE_RED =         2;
            var C64_COLOR_CODE_CYAN =        3;
            var C64_COLOR_CODE_PURPLE =      4;
            var C64_COLOR_CODE_GREEN =       5;
            var C64_COLOR_CODE_BLUE =        6;
            var C64_COLOR_CODE_YELLOW =      7;
            var C64_COLOR_CODE_ORANGE =      8;
            var C64_COLOR_CODE_BROWN =       9;
            var C64_COLOR_CODE_LIGHTRED =   10;
            var C64_COLOR_CODE_DARKGREY =   11;
            var C64_COLOR_CODE_GREY =       12;
            var C64_COLOR_CODE_LIGHTGREEN = 13;
            var C64_COLOR_CODE_LIGHTBLUE =  14;
            var C64_COLOR_CODE_LIGHTGREY =  15;

            // refer to https://www.c64-wiki.com/wiki/Color
            var C64_RGB_COLOR_BLACK =      [  0,  0,  0];
            var C64_RGB_COLOR_WHITE =      [255,255,255];
            var C64_RGB_COLOR_RED =        [136,  0,  0];
            var C64_RGB_COLOR_CYAN =       [170,255,238];
            var C64_RGB_COLOR_PURPLE =     [204, 68,204];
            var C64_RGB_COLOR_GREEN =      [  0,204, 85];
            var C64_RGB_COLOR_BLUE =       [  0,  0,170];
            var C64_RGB_COLOR_YELLOW =     [238,238,119];
            var C64_RGB_COLOR_ORANGE =     [221,136, 85];
            var C64_RGB_COLOR_BROWN =      [102, 68,  0];
            var C64_RGB_COLOR_LIGHTRED =   [255,119,119];
            var C64_RGB_COLOR_DARKGREY =   [ 51, 51, 51];
            var C64_RGB_COLOR_GREY =       [119,119,119];
            var C64_RGB_COLOR_LIGHTGREEN = [170,255,102];
            var C64_RGB_COLOR_LIGHTBLUE =  [  0,136,255];
            var C64_RGB_COLOR_LIGHTGREY =  [187,187,187];

            var C64_SELECTED_FOREGROUND_RGB_COLORS = [];
            var C64_SELECTED_BACKGROUND_RGB_COLORS = [];
 
            var contrast = 0;
            var brightness = 0;
            
            // compares each color component of RGB color and returns TRUE on match, FALSE otherwise.
            function MatchRgbColors(rgbColor1, rgbColor2) {
                match = false;
                if ( (rgbColor1[0] == rgbColor2[0]) &&
                     (rgbColor1[1] == rgbColor2[1]) &&
                     (rgbColor1[2] == rgbColor2[2]) ) {
                    match = true;
                }
                return match;
            }

            // find specified RGB color in C64_SELECTED_RGB_COLORS array and return it's index, return undefined if not found.
            function FindIndexOfSelectedRgbColor(rgbColor, C64_SELECTED_RGB_COLORS) {
                var colorIndex = -1;
                for (var i=0; i<C64_SELECTED_RGB_COLORS.length; i++) {
                    if (MatchRgbColors(C64_SELECTED_RGB_COLORS[i], rgbColor)) {
                        colorIndex = i;
                        break;
                    }
                }
                return colorIndex;
            }

            // Find matching C64 RGB color and return VIC-II (C64) color code, undefined if no match
            function GetC64ColorCode(rgbColor) {
                var colorCode = undefined;
                if (MatchRgbColors(rgbColor, C64_RGB_COLOR_BLACK)) {
                    colorCode = C64_COLOR_CODE_BLACK;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_WHITE)) {
                    colorCode = C64_COLOR_CODE_WHITE;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_RED)) {
                    colorCode = C64_COLOR_CODE_RED;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_CYAN)) {
                    colorCode = C64_COLOR_CODE_CYAN;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_PURPLE)) {
                    colorCode = C64_COLOR_CODE_PURPLE;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_GREEN)) {
                    colorCode = C64_COLOR_CODE_GREEN;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_BLUE)) {
                    colorCode = C64_COLOR_CODE_BLUE;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_YELLOW)) {
                    colorCode = C64_COLOR_CODE_YELLOW;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_ORANGE)) {
                    colorCode = C64_COLOR_CODE_ORANGE;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_BROWN)) {
                    colorCode = C64_COLOR_CODE_BROWN;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_LIGHTRED)) {
                    colorCode = C64_COLOR_CODE_LIGHTRED;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_DARKGREY)) {
                    colorCode = C64_COLOR_CODE_DARKGREY;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_GREY)) {
                    colorCode = C64_COLOR_CODE_GREY;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_LIGHTGREEN)) {
                    colorCode = C64_COLOR_CODE_LIGHTGREEN;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_LIGHTBLUE)) {
                    colorCode = C64_COLOR_CODE_LIGHTBLUE;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_LIGHTGREY)) {
                    colorCode = C64_COLOR_CODE_LIGHTGREY;
                }
                return colorCode;
            }

            // Find matching C64 color code and return matching RGB color ([r, g, b]), undefined if no match
            function GetRgbColor(c64ColorCode) {
                var rgbColor = undefined;
                switch (c64ColorCode) {
                    case C64_COLOR_CODE_BLACK:
                        rgbColor = C64_RGB_COLOR_BLACK;
                        break;
                    case C64_COLOR_CODE_WHITE:
                        rgbColor = C64_RGB_COLOR_WHITE;
                        break;
                    case C64_COLOR_CODE_RED:
                        rgbColor = C64_RGB_COLOR_RED;
                        break;
                    case C64_COLOR_CODE_CYAN:
                        rgbColor = C64_RGB_COLOR_CYAN;
                        break;
                    case C64_COLOR_CODE_PURPLE:
                        rgbColor = C64_RGB_COLOR_PURPLE;
                        break;
                    case C64_COLOR_CODE_GREEN:
                        rgbColor = C64_RGB_COLOR_GREEN;
                        break;
                    case C64_COLOR_CODE_BLUE:
                        rgbColor = C64_RGB_COLOR_BLUE;
                        break;
                    case C64_COLOR_CODE_YELLOW:
                        rgbColor = C64_RGB_COLOR_YELLOW;
                        break;
                    case C64_COLOR_CODE_ORANGE:
                        rgbColor = C64_RGB_COLOR_ORANGE;
                        break;
                    case C64_COLOR_CODE_BROWN:
                        rgbColor = C64_RGB_COLOR_BROWN;
                        break;
                    case C64_COLOR_CODE_LIGHTRED:
                        rgbColor = C64_RGB_COLOR_LIGHTRED;
                        break;
                    case C64_COLOR_CODE_DARKGREY:
                        rgbColor = C64_RGB_COLOR_DARKGREY;
                        break;
                    case C64_COLOR_CODE_GREY:
                        rgbColor = C64_RGB_COLOR_GREY;
                        break;
                    case C64_COLOR_CODE_LIGHTGREEN:
                        rgbColor = C64_RGB_COLOR_LIGHTGREEN;
                        break;
                    case C64_COLOR_CODE_LIGHTBLUE:
                        rgbColor = C64_RGB_COLOR_LIGHTBLUE;
                        break;
                    case C64_COLOR_CODE_LIGHTGREY:
                        rgbColor = C64_RGB_COLOR_LIGHTGREY;
                        break;
                }
                return rgbColor;
            }

            var chardata = [];
            var srcdata  = [];
            var petsciiCharacterCodes        = new Uint8Array((WIDTH/CWIDTH) * (HEIGHT/CHEIGHT));
            var c64CharacterForegroundColors = new Uint8Array((WIDTH/CWIDTH) * (HEIGHT/CHEIGHT));
            var c64CharacterBackgroundColors = new Uint8Array((WIDTH/CWIDTH) * (HEIGHT/CHEIGHT));
            var c64CustomCharacterSetBytes   = new Uint8Array(CHARACTERS*8);
            
            var characterContainer;
            var characterCanvas = [];

            // format number between 0-255 into a formatLength column string (padding with leading zeros as necessary, i.e. 1 -> 001)
            function FormatNumberStr(colorCode, formatLength) {
                var colorCodeStr = colorCode.toString();
                while (colorCodeStr.length < formatLength) {
                    colorCodeStr = "0" + colorCodeStr;
                }
                return colorCodeStr;
            }

            // format string into a formatLength column string (padding with leading zeros as necessary, i.e. 1 -> 001)
            function FormatStr(colorCodeStr, formatLength) {
                while (colorCodeStr.length < formatLength) {
                    colorCodeStr = "0" + colorCodeStr;
                }
                return colorCodeStr;
            }

            function GetUint8Array(inputArray) {
                var outputArray = new Uint8Array(inputArray.length);
                for (var i=0; i<inputArray.length; i++) {
                    outputArray[i] = inputArray[i];
                }
                return outputArray;
            }

            // convert A-Z and 0-9 into array of hex PETSCII character codes
            function ConvertAsciiStrToPetsciiBytes(asciiStr) {
                var petsciiBytes = [];
                var upperCaseAsciiStr = asciiStr.toUpperCase();
                for (var i=0; i<upperCaseAsciiStr.length; i++) {
                    var asciiCode = upperCaseAsciiStr.charCodeAt(i);
                    var petsciiCode = undefined;
                    if ( (asciiCode >= 65) && (asciiCode <= 90) ) {
                        petsciiCode = asciiCode - 65 + 1; // ASCII 'A' = 65, PETSCII 'A' (or 'a') = 01
                    } else if ( (asciiCode >= 48) && (asciiCode <= 57) ) {
                        // ASCII '0' = 48, PETSCII '0' = 48. Do nothing for 0-9
                        petsciiCode = asciiCode;
                    } else {
                        console.log("no match - replace with ' '. char:" + upperCaseAsciiStr.charAt(i) + " ascii:" + upperCaseAsciiStr.charCodeAt(i));
                        petsciiCode = 32; // replace anything not in A-Z0-9 with blank
                    }
                    petsciiBytes.push(petsciiCode);
                }
                return petsciiBytes;
            }

            function PadBytes(inputBytes, maximumLength) {
                while (inputBytes.length < maximumLength) {
                    inputBytes.push(0);
                }
                return inputBytes;
            }

            // convert to PETSCII, truncate to maximumLength, terminate with 0x00, pad with 0x00;
            function PrepareTextField(asciiStr, maximumLength) {
                var petsciiBytes = ConvertAsciiStrToPetsciiBytes(asciiStr);
                petsciiBytes = PadBytes(petsciiBytes, maximumLength);
                if (petsciiBytes.length > maximumLength) {
                    petsciiBytes = petsciiBytes.slice(0, maximumLength-1);
                }
                petsciiBytes[maximumLength-1] = 0x00;
                return petsciiBytes;
            }

            function EncodeExtendedColorModeCharacter(inputChar, backgroundColorIndex) {
                var encodedChar = inputChar & 0b00111111;
                switch (backgroundColorIndex) {
                    case 0:
                        encodedChar |= 0b00000000;
                        break;
                    case 1:
                        encodedChar |= 0b01000000;
                        break;
                    case 2:
                        encodedChar |= 0b10000000;
                        break;
                    case 3:
                        encodedChar |= 0b11000000;
                        break;
                }
                return encodedChar;
            }

            function SetInputEnabled(elementId, enable) {
                var element = document.getElementById(elementId);
                element.disabled = enable ? false:true;
            }

            function GetInputValue(inputId) {
                var inputElement = document.getElementById(inputId);
                return inputElement.value;
            }

            function SetInputValue(inputId, value) {
                var inputElement = document.getElementById(inputId);
                inputElement.value = value;
            }

            function SetCheckboxSelected(checkboxId, select) {
                var checkboxElement = document.getElementById(checkboxId);
                checkboxElement.checked = select ? true:false;
            }

            function GetCheckboxSetting(checkboxId) {
                var checkboxElement = document.getElementById(checkboxId);
                return checkboxElement.checked ? true:false;
            }

			var SaveByteArray = (function () {
                var a = document.createElement("a");
                document.body.appendChild(a);
                a.style = "display: none";
                
                return function (characterCodes, characterForegroundColors, characterBackgroundColors, inputFileName, outputFileName, projectJsonOutput_checkbox_enabled, binaryCharactersOnlyOutput_enabled, binaryCharactersAndColorsOutput_enabled, cLanguageTextOutput_enabled, asmLanguageTextOutput_enabled, c64OsOutput_enabled) {
                    var vic2ExtendedMode_enabled = GetCheckboxSetting('vic2ExtendedMode_checkbox');

                    var characterSetUpper256_enabled = GetCheckboxSetting('characterSetUpper256_checkbox');
                    var characterSetUpperLower256_enabled = GetCheckboxSetting('characterSetUpper256_checkbox');
                    var characterSetExtendedGraphic64_enabled = GetCheckboxSetting('characterSetExtendedGraphic64_checkbox');
                    var characterSetExtendedAlphaNum64_enabled = GetCheckboxSetting('characterSetExtendedAlphaNum64_checkbox');
                    var characterSetCustom_enabled = GetCheckboxSetting('characterSetCustom_checkbox');
                    var characterSetDirectory_text = GetInputValue('characterSetDirectory_text');
                    var characterSetSize_number = GetInputValue('characterSetSize_number');

                    var matchExactColorAlgorithm_enabled = GetCheckboxSetting('matchExactColorAlgorithm_checkbox');
                    var minimizeColorDifferencesLinearAlgorithm_enabled = GetCheckboxSetting('minimizeColorDifferencesLinearAlgorithm_checkbox');
                    var minimizeColorDifferencesExponentialAlgorithm_enabled = GetCheckboxSetting('minimizeColorDifferencesExponentialAlgorithm_checkbox');

                    var blackAndWhiteDither_enabled = GetCheckboxSetting('blackAndWhiteDither_checkbox');
                    var greyscaleConversion_enabled = GetCheckboxSetting('greyscaleConversion_checkbox');
                    var selectedColorDither_enabled = GetCheckboxSetting('selectedColorDither_checkbox');
                    var propogateDitheringError_enabled = GetCheckboxSetting('propogateDitheringError_checkbox');
                    var imageNegative_enabled = GetCheckboxSetting('imageNegative_checkbox');
                    var imageContrast_number = GetInputValue('imageContrast_number');
                    var imageBrightness_number = GetInputValue('imageBrightness_number');

                    var useGraphicsCharactersOnly_enabled = GetCheckboxSetting('useGraphicsCharactersOnly_checkbox');
                    var colorSubstitutions = null;
                    var colorSubstitutions_text = GetInputValue('colorSubstitutions_text');
                    if (colorSubstitutions_text.length > 0) {
                        colorSubstitutions = colorSubstitutions_text.split(/\s+/);
                    }

                    var processedCharacterForegroundColors = new Uint8Array((WIDTH/CWIDTH) * (HEIGHT/CHEIGHT));
                    for (var i=0; i<characterForegroundColors.length; i++) {
                        processedCharacterForegroundColors[i] = ProcessColorSubstitutions(characterForegroundColors[i], true, colorSubstitutions);
                    }
                    var processedCharacterBackgroundColors = new Uint8Array((WIDTH/CWIDTH) * (HEIGHT/CHEIGHT));
                    for (var i=0; i<characterBackgroundColors.length; i++) {
                        processedCharacterBackgroundColors[i] = ProcessColorSubstitutions(characterBackgroundColors[i], false, colorSubstitutions);
                    }

                    var saveFields = [];
                    var blob = undefined;
                    if (projectJsonOutput_checkbox_enabled) {
                        //output format is JSON text format, provided for saving and loading project settings into petscii_converter.html
                        var bufStr = "{\n";
                        bufStr = bufStr + '  "inputFileName":' + JSON.stringify(inputFileName) + ",\n";
                        bufStr = bufStr + '  "vic2ExtendedMode":' + JSON.stringify(vic2ExtendedMode_enabled) + ",\n";
                        bufStr = bufStr + '  "selectedForegroundColors":[';
                        for (var i=0; i<C64_SELECTED_FOREGROUND_RGB_COLORS.length; i++) {
                            bufStr = bufStr + GetC64ColorCode(C64_SELECTED_FOREGROUND_RGB_COLORS[i]);
                            if (i < C64_SELECTED_FOREGROUND_RGB_COLORS.length - 1) {
                                bufStr = bufStr + ",";
                            }
                        }
                        bufStr = bufStr + "],\n";
                        bufStr = bufStr + '  "selectedBackgroundColors":[';
                        for (var i=0; i<C64_SELECTED_BACKGROUND_RGB_COLORS.length; i++) {
                            bufStr = bufStr + GetC64ColorCode(C64_SELECTED_BACKGROUND_RGB_COLORS[i]);
                            if (i < C64_SELECTED_BACKGROUND_RGB_COLORS.length - 1) {
                                bufStr = bufStr + ",";
                            }
                        }
                        bufStr = bufStr + "],\n";
                        bufStr = bufStr + '  "characterSetUpper256":' + JSON.stringify(characterSetUpper256_enabled) + ",\n";
                        bufStr = bufStr + '  "characterSetUpperLower256":' + JSON.stringify(characterSetUpperLower256_enabled) + ",\n";
                        bufStr = bufStr + '  "characterSetExtendedGraphic64":' + JSON.stringify(characterSetExtendedGraphic64_enabled) + ",\n";
                        bufStr = bufStr + '  "characterSetExtendedAlphaNum64":' + JSON.stringify(characterSetExtendedAlphaNum64_enabled) + ",\n";
                        bufStr = bufStr + '  "characterSetCustom":' + JSON.stringify(characterSetCustom_enabled) + ",\n";
                        bufStr = bufStr + '  "characterSetDirectory":' + JSON.stringify(characterSetDirectory_text) + ",\n";
                        bufStr = bufStr + '  "characterSetSize":' + JSON.stringify(Number(characterSetSize_number)) + ",\n";

                        bufStr = bufStr + '  "matchExactColorAlgorithm":' + JSON.stringify(matchExactColorAlgorithm_enabled) + ",\n";
                        bufStr = bufStr + '  "minimizeColorDifferencesLinearAlgorithm":' + JSON.stringify(minimizeColorDifferencesLinearAlgorithm_enabled) + ",\n";
                        bufStr = bufStr + '  "minimizeColorDifferencesExponentialAlgorithm":' + JSON.stringify(minimizeColorDifferencesExponentialAlgorithm_enabled) + ",\n";

                        bufStr = bufStr + '  "blackAndWhiteDither":' + JSON.stringify(blackAndWhiteDither_enabled) + ",\n";
                        bufStr = bufStr + '  "greyscaleConversion":' + JSON.stringify(greyscaleConversion_enabled) + ",\n";
                        bufStr = bufStr + '  "selectedColorDither":' + JSON.stringify(selectedColorDither_enabled) + ",\n";
                        bufStr = bufStr + '  "propogateDitheringError":' + JSON.stringify(propogateDitheringError_enabled) + ",\n";
                        bufStr = bufStr + '  "imageNegative":' + JSON.stringify(imageNegative_enabled) + ",\n";
                        bufStr = bufStr + '  "imageContrast":' + JSON.stringify(Number(imageContrast_number)) + ",\n";
                        bufStr = bufStr + '  "imageBrightness":' + JSON.stringify(Number(imageBrightness_number)) + ",\n";

                        bufStr = bufStr + '  "useGraphicsCharactersOnly":' + JSON.stringify(useGraphicsCharactersOnly_enabled) + ",\n";
                        bufStr = bufStr + '  "colorSubstitutions":' + JSON.stringify(colorSubstitutions_text) + "\n";

                        bufStr = bufStr + "}\n";
                        blob = new Blob([bufStr], {type: "text/plain"});
                    } else if (binaryCharactersOnlyOutput_enabled) {
                        // output format is binary stream of 1000 PETSCII character codes
                        if (vic2ExtendedMode_enabled) {
                            var extendedCharacterCodes = new Uint8Array(characterCodes.length);
                            for (var i=0; i<characterCodes.length; i++) {
                                var backgroundColorIndex = FindIndexOfSelectedRgbColor(GetRgbColor(characterBackgroundColors[i]), C64_SELECTED_BACKGROUND_RGB_COLORS);
                                extendedCharacterCodes[i] = EncodeExtendedColorModeCharacter(characterCodes[i], backgroundColorIndex);
                            }
                            blob = new Blob([extendedCharacterCodes], {type: "application/octet-stream"});
                        } else {
                            blob = new Blob([characterCodes], {type: "application/octet-stream"});
                        }
                    } else if (binaryCharactersAndColorsOutput_enabled) {
                        // output format is binary stream of 1000 PETSCII character codes followed by 1000 character foreground color codes, provided for import into C64 Studio for editing
                        if (vic2ExtendedMode_enabled) {
                            var extendedCharacterCodes = new Uint8Array(characterCodes.length);
                            for (var i=0; i<characterCodes.length; i++) {
                                var backgroundColorIndex = FindIndexOfSelectedRgbColor(GetRgbColor(characterBackgroundColors[i]), C64_SELECTED_BACKGROUND_RGB_COLORS);
                                extendedCharacterCodes[i] = EncodeExtendedColorModeCharacter(characterCodes[i], backgroundColorIndex);
                            }
                            saveFields.push(extendedCharacterCodes);
                            saveFields.push(GetUint8Array(processedCharacterForegroundColors));
                            blob = new Blob(saveFields, {type: "application/octet-stream"});
                        } else {
                            saveFields.push(characterCodes);
                            saveFields.push(GetUint8Array(processedCharacterForegroundColors));
                            blob = new Blob(saveFields, {type: "application/octet-stream"});
                        }
                    } else if (cLanguageTextOutput_enabled) {
                        //output format is text .C language format, provided for import into Marq's PETSCII editor (not compatible when Extended Background Color Mode is selected as three extra background color codes are saved)
                        var bufStr = "unsigned char frame0000[]={";

                        if (vic2ExtendedMode_enabled) {
                            bufStr = bufStr + "// border,bg,bg2,bg3,bg4,chars,colors\n" +
                                              ProcessColorSubstitutions(GetC64ColorCode(C64_SELECTED_BACKGROUND_RGB_COLORS[0]), false, colorSubstitutions) + "," +
                                              ProcessColorSubstitutions(GetC64ColorCode(C64_SELECTED_BACKGROUND_RGB_COLORS[0]), false, colorSubstitutions) + "," +
                                              ProcessColorSubstitutions(GetC64ColorCode(C64_SELECTED_BACKGROUND_RGB_COLORS[1]), false, colorSubstitutions) + "," +
                                              ProcessColorSubstitutions(GetC64ColorCode(C64_SELECTED_BACKGROUND_RGB_COLORS[2]), false, colorSubstitutions) + "," +
                                              ProcessColorSubstitutions(GetC64ColorCode(C64_SELECTED_BACKGROUND_RGB_COLORS[3]), false, colorSubstitutions) + ",\n";
                        } else {
                            bufStr = bufStr + "// border,bg,chars,colors\n" +
                                              ProcessColorSubstitutions(GetC64ColorCode(C64_SELECTED_BACKGROUND_RGB_COLORS[0]), false, colorSubstitutions) + "," +
                                              ProcessColorSubstitutions(GetC64ColorCode(C64_SELECTED_BACKGROUND_RGB_COLORS[0]), false, colorSubstitutions) + ",\n";
                        }

                        for (var i=0;i<characterCodes.length;i++) {
                            characterCode = characterCodes[i];
                            if (vic2ExtendedMode_enabled) {
                                var backgroundColorIndex = FindIndexOfSelectedRgbColor(GetRgbColor(characterBackgroundColors[i]), C64_SELECTED_BACKGROUND_RGB_COLORS);
                                characterCode = EncodeExtendedColorModeCharacter(characterCode, backgroundColorIndex);
                            }
                            bufStr = bufStr + characterCode + ",";
                            if ((i+1) % (WIDTH/CWIDTH) == 0) {
                                bufStr = bufStr + "\n";
                            }
                        }

                        for (var i=0; i<processedCharacterForegroundColors.length; i++) {
                            bufStr = bufStr + processedCharacterForegroundColors[i];
                            if ((i+1) < processedCharacterForegroundColors.length) { //skip comma on last array entry
                                bufStr = bufStr + ",";
                            }
                            if ((i+1) % (WIDTH/CWIDTH) == 0) {
                                bufStr = bufStr + "\n";
                            }
                        }

                        bufStr = bufStr + "};\n";
                        if (characterSetUpper256_enabled) {
                            bufStr = bufStr + "// META: 40 25 C64 upper";
                        } else if (characterSetUpperLower256_enabled) {
                            bufStr = bufStr + "// META: 40 25 C64 lower";
                        } else if (characterSetCustom_enabled) {
                            bufStr = bufStr + "// META: 40 25 C64 custom"; //not compatible when custom character set used
                        }
                        blob = new Blob([bufStr], {type: "text/plain"});
                    } else if (asmLanguageTextOutput_enabled) {
                        // output format is assembly language, provided for import into C64 Studio for editing
                        var bufStr = ";size 40,25\n" +
                                     ";screen char data\n";

                        for (var i=0;i<characterCodes.length;i++) {
                            characterCode = characterCodes[i];
                            if (vic2ExtendedMode_enabled) {
                                var backgroundColorIndex = FindIndexOfSelectedRgbColor(GetRgbColor(characterBackgroundColors[i]), C64_SELECTED_BACKGROUND_RGB_COLORS);
                                characterCode = EncodeExtendedColorModeCharacter(characterCode, backgroundColorIndex);
                            }
                            if (i % (WIDTH/CWIDTH) == 0) {
                                bufStr = bufStr + "!byte ";
                            }
                            bufStr = bufStr + "$" + FormatStr(characterCode.toString(16), 2);
                            if ((i+1) % (WIDTH/CWIDTH) == 0) {
                                bufStr = bufStr + "\n";
                            } else {
                                bufStr = bufStr + ",";
                            }
                        }

                        bufStr = bufStr + "\n;screen color data\n";
                        for (var i=0; i<processedCharacterForegroundColors.length; i++) {
                            if (i % (WIDTH/CWIDTH) == 0) {
                                bufStr = bufStr + "!byte ";
                            }
                            bufStr = bufStr + "$" + FormatStr(processedCharacterForegroundColors[i].toString(16), 2);
                            if ((i+1) % (WIDTH/CWIDTH) == 0) {
                                bufStr = bufStr + "\n";
                            } else {
                                bufStr = bufStr + ",";
                            }
                        }

                        blob = new Blob([bufStr], {type: "text/plain"});
                    } else if (c64OsOutput_enabled) {
                        //output format is provided to be used with C64OS
                        var c64OsOutputTitle_text = document.getElementById('c64OsOutputTitle_text');
                        var title_value = c64OsOutputTitle_text.value;
                        if (title_value == undefined) {
                            title_value = "";
                        }
                        var c64OsOutputArtist_text = document.getElementById('c64OsOutputArtist_text');
                        var artist_value = c64OsOutputArtist_text.value;
                        if (artist_value == undefined) {
                            artist_value = "";
                        }
                        var c64OsOutputCopyright_text = document.getElementById('c64OsOutputCopyright_text');
                        var copyright_value = c64OsOutputCopyright_text.value;
                        if (copyright_value == undefined) {
                            copyright_value = "";
                        }

                        if (characterSetUpper256_enabled) {
                            //refer to https://c64os.com/post/imageformats
                            //
                            // Version 0 implies the Uppercase/Graphics character set (from the standard C64 Char ROM.)
                            //
                            // The Version 0 Format:
                            //
                            // MAGIC         3 ("PET", $D0 $C5 $D4)
                            // VERSION       1 ("0", $30)
                            // SOURCE       17 (Title,     String in PETSCII, $00 padded and terminated)
                            // AUTHOR       17 (Artist,    String in PETSCII, $00 padded and terminated)
                            // RELEASE      17 (Copyright, String in PETSCII, $00 padded and terminated)
                            // SCREEN     1000 (Screencodes for screen matrix memory, not PETSCII codes.)
                            // COLOR      1000 (VIC-II colorcodes for color memory, not PETSCII codes.)
                            // BORDER        1 (Border color, value stored to VIC+$20)
                            // BACKGRND      1 (Background color, value stored to VIC+$21)

                            saveFields.push(GetUint8Array([0xD0, 0xC5, 0xD4, 0x30]));
                            saveFields.push(GetUint8Array(PrepareTextField(title_value, 17)));
                            saveFields.push(GetUint8Array(PrepareTextField(artist_value, 17)));
                            saveFields.push(GetUint8Array(PrepareTextField(copyright_value, 17)));
                            saveFields.push(characterCodes);
                            saveFields.push(processedCharacterForegroundColors);
                            saveFields.push(GetUint8Array([ProcessColorSubstitutions(characterBackgroundColors[0], false, colorSubstitutions)]));
                            saveFields.push(GetUint8Array([ProcessColorSubstitutions(characterBackgroundColors[0], false, colorSubstitutions)]));
                        } else if (characterSetUpperLower256_enabled) {
                            //refer to https://c64os.com/post/imageformats
                            //
                            // Version 1 is identical to Version 0, but implies the Lowercase/Uppercase character set.
                            //
                            // The Version 1 Format:
                            //
                            // MAGIC         3 ("PET", $D0 $C5 $D4)
                            // VERSION       1 ("1", $31)
                            // SOURCE       17 (Title,     String in PETSCII, $00 padded and terminated)
                            // AUTHOR       17 (Artist,    String in PETSCII, $00 padded and terminated)
                            // RELEASE      17 (Copyright, String in PETSCII, $00 padded and terminated)
                            // SCREEN     1000 (Screencodes for screen matrix memory, not PETSCII codes.)
                            // COLOR      1000 (VIC-II colorcodes for color memory, not PETSCII codes.)
                            // BORDER        1 (Border color, value stored to VIC+$20)
                            // BACKGRND      1 (Background color, value stored to VIC+$21)

                            saveFields.push(GetUint8Array([0xD0, 0xC5, 0xD4, 0x31]));
                            saveFields.push(GetUint8Array(PrepareTextField(title_value, 17)));
                            saveFields.push(GetUint8Array(PrepareTextField(artist_value, 17)));
                            saveFields.push(GetUint8Array(PrepareTextField(copyright_value, 17)));
                            saveFields.push(characterCodes);
                            saveFields.push(processedCharacterForegroundColors);
                            saveFields.push(GetUint8Array([ProcessColorSubstitutions(characterBackgroundColors[0], false, colorSubstitutions)]));
                            saveFields.push(GetUint8Array([ProcessColorSubstitutions(characterBackgroundColors[0], false, colorSubstitutions)]));
                        } else if (characterSetCustom_enabled) {
                            //refer to https://c64os.com/post/imageformats
                            //
                            // version 2 adds the 2KB character set at the end. The character set is in the same format as a 2KB charset in the ROM. 
                            //
                            // The Version 2 Format:
                            //
                            // MAGIC         3 ("PET", $D0 $C5 $D4)
                            // VERSION       1 ("2", $32)
                            // SOURCE       17 (Title,     String in PETSCII, $00 padded and terminated)
                            // AUTHOR       17 (Artist,    String in PETSCII, $00 padded and terminated)
                            // RELEASE      17 (Copyright, String in PETSCII, $00 padded and terminated)
                            // SCREEN     1000 (Screencodes for screen matrix memory, not PETSCII codes.)
                            // COLOR      1000 (VIC-II colorcodes for color memory, not PETSCII codes.)
                            // BORDER        1 (Border color, value stored to VIC+$20)
                            // BACKGRND      1 (Background color, value stored to VIC+$21)
                            // CHARSET    2048 (2KB character set)

                            saveFields.push(GetUint8Array([0xD0, 0xC5, 0xD4, 0x32]));
                            saveFields.push(GetUint8Array(PrepareTextField(title_value, 17)));
                            saveFields.push(GetUint8Array(PrepareTextField(artist_value, 17)));
                            saveFields.push(GetUint8Array(PrepareTextField(copyright_value, 17)));
                            saveFields.push(characterCodes);
                            saveFields.push(processedCharacterForegroundColors);
                            saveFields.push(GetUint8Array([ProcessColorSubstitutions(characterBackgroundColors[0], false, colorSubstitutions)]));
                            saveFields.push(GetUint8Array([ProcessColorSubstitutions(characterBackgroundColors[0], false, colorSubstitutions)]));
                            saveFields.push(c64CustomCharacterSetBytes);
                        }
                        blob = new Blob(saveFields, {type: "application/octet-stream"});
                    }
                    var url  = window.URL.createObjectURL(blob);
                    
                    a.href = url;
                    a.download = outputFileName;
                    a.click();
                    
                    window.URL.revokeObjectURL(url);
                };
			}());

            // read the value of the color checkbox and update the selected colors array accordingly
            function SetSelectedColorsCheckbox(checkboxId, rgbColor, C64_SELECTED_RGB_COLORS) {
                var color_checkbox = document.getElementById(checkboxId);
                var color_enabled = color_checkbox.checked ? true:false;
                var color_index = FindIndexOfSelectedRgbColor(rgbColor, C64_SELECTED_RGB_COLORS);
                if (color_enabled) {
                    if (color_index == -1) {
                        C64_SELECTED_RGB_COLORS.push(rgbColor);
                    }
                }
            }

            // read the value of the color number and update the selected colors array accordingly
            function SetSelectedColorsNumber(numberId, C64_SELECTED_RGB_COLORS) {
                var color_number = document.getElementById(numberId);
                var colorCode = parseInt(color_number.value);
                var rgbColor = GetRgbColor(colorCode);
                var color_index = FindIndexOfSelectedRgbColor(rgbColor, C64_SELECTED_RGB_COLORS);
                if (color_index == -1) {
                    C64_SELECTED_RGB_COLORS.push(rgbColor);
                }
            }

            function UpdateOutputFileName(loadingNewFile) {
                var projectJsonOutput_checkbox = document.getElementById('projectJsonOutput_checkbox');
                var projectJsonOutput_checkbox_enabled = projectJsonOutput_checkbox.checked ? true:false;

                var binaryCharactersOnlyOutput_checkbox = document.getElementById('binaryCharactersOnlyOutput_checkbox');
                var binaryCharactersOnlyOutput_enabled = binaryCharactersOnlyOutput_checkbox.checked ? true:false;

                var binaryCharactersAndColorsOutput_checkbox = document.getElementById('binaryCharactersAndColorsOutput_checkbox');
                var binaryCharactersAndColorsOutput_enabled = binaryCharactersAndColorsOutput_checkbox.checked ? true:false;

                var cLanguageTextOutput_checkbox = document.getElementById('cLanguageTextOutput_checkbox');
                var cLanguageTextOutput_enabled = cLanguageTextOutput_checkbox.checked ? true:false;

                var asmLanguageTextOutput_checkbox = document.getElementById('asmLanguageTextOutput_checkbox');
                var asmLanguageTextOutput_enabled = asmLanguageTextOutput_checkbox.checked ? true:false;

                var c64OsOutput_checkbox = document.getElementById('c64OsOutput_checkbox');
                var c64OsOutput_enabled = c64OsOutput_checkbox.checked ? true:false;

                var saveFileName_element = document.getElementById('saveFileName');
                var saveFileName = saveFileName_element.value;
                if ( (saveFileName.length == 0) || (loadingNewFile) ) {
                    saveFileName = GetFileNameFromPath(document.getElementById('loadFileName_file').value);
                }
                if (saveFileName.length == 0) {
                    saveFileName = "petsciiart";
                }

                if (cLanguageTextOutput_enabled) {
                    saveFileName_element.value = saveFileName.split('.')[0] + ".c"
                } else if (asmLanguageTextOutput_enabled) {
                    saveFileName_element.value = saveFileName.split('.')[0] + ".asm"
                } else if (binaryCharactersOnlyOutput_enabled) {
                    saveFileName_element.value = saveFileName.split('.')[0] + ".pet"
                } else if (projectJsonOutput_checkbox_enabled) {
                    saveFileName_element.value = saveFileName.split('.')[0] + ".project"
                } else {
                    saveFileName_element.value = saveFileName.split('.')[0] + ".bin"
                }
            }

            function Click_vic2StandardMode_checkbox() {
                SetCheckboxSelected('vic2StandardMode_checkbox', true);
                SetCheckboxSelected('vic2ExtendedMode_checkbox', false);
                SetInputEnabled('backgroundColor2_number', false);
                SetInputEnabled('backgroundColor3_number', false);
                SetInputEnabled('backgroundColor4_number', false);

                SetInputEnabled('characterSetExtendedGraphic64_checkbox', false);
                SetCheckboxSelected('characterSetExtendedGraphic64_checkbox', false);
                SetInputEnabled('characterSetExtendedAlphaNum64_checkbox', false);
                SetCheckboxSelected('characterSetExtendedAlphaNum64_checkbox', false);

                SetInputEnabled('characterSetUpper256_checkbox', true);
                SetInputEnabled('characterSetUpperLower256_checkbox', true);
                SetInputEnabled('c64OsOutput_checkbox', true);
            }

            function Click_vic2ExtendedMode_checkbox() {
                SetCheckboxSelected('vic2StandardMode_checkbox', false);
                SetCheckboxSelected('vic2ExtendedMode_checkbox', true);
                SetInputEnabled('backgroundColor2_number', true);
                SetInputEnabled('backgroundColor3_number', true);
                SetInputEnabled('backgroundColor4_number', true);

                SetInputEnabled('characterSetUpper256_checkbox', false);
                SetCheckboxSelected('characterSetUpper256_checkbox', false);
                SetInputEnabled('characterSetUpperLower256_checkbox', false);
                SetCheckboxSelected('characterSetUpperLower256_checkbox', false);

                SetInputEnabled('characterSetExtendedGraphic64_checkbox', true);
                SetInputEnabled('characterSetExtendedAlphaNum64_checkbox', true);
                SetInputEnabled('c64OsOutput_checkbox', false);
                if (GetCheckboxSetting('c64OsOutput_checkbox')) {
                    document.getElementById('cLanguageTextOutput_checkbox').click();
                }
                SetCheckboxSelected('c64OsOutput_checkbox', false);
            }

            function Click_characterSetUpper256_checkbox() {
                SetCheckboxSelected('characterSetUpper256_checkbox', true);
                SetCheckboxSelected('characterSetUpperLower256_checkbox', false);
                SetCheckboxSelected('characterSetExtendedGraphic64_checkbox', false);
                SetCheckboxSelected('characterSetExtendedAlphaNum64_checkbox', false);
                SetCheckboxSelected('characterSetCustom_checkbox', false);
                SetInputEnabled('characterSetDirectory_text', false);
                SetInputEnabled('characterSetSize_number', false);
                SetInputValue('characterSetDirectory_text', "standard256-upper");
                SetInputValue('characterSetSize_number', 256);
            }

            function Click_characterSetUpperLower256_checkbox() {
                SetCheckboxSelected('characterSetUpper256_checkbox', false);
                SetCheckboxSelected('characterSetUpperLower256_checkbox', true);
                SetCheckboxSelected('characterSetExtendedGraphic64_checkbox', false);
                SetCheckboxSelected('characterSetExtendedAlphaNum64_checkbox', false);
                SetCheckboxSelected('characterSetCustom_checkbox', false);
                SetInputEnabled('characterSetDirectory_text', false);
                SetInputEnabled('characterSetSize_number', false);
                SetInputValue('characterSetDirectory_text', "standard256-upperlower");
                SetInputValue('characterSetSize_number', 256);
            }

            function Click_characterSetExtendedGraphic64_checkbox() {
                SetCheckboxSelected('characterSetUpper256_checkbox', false);
                SetCheckboxSelected('characterSetUpperLower256_checkbox', false);
                SetCheckboxSelected('characterSetExtendedGraphic64_checkbox', true);
                SetCheckboxSelected('characterSetExtendedAlphaNum64_checkbox', false);
                SetCheckboxSelected('characterSetCustom_checkbox', false);
                SetInputEnabled('characterSetDirectory_text', false);
                SetInputEnabled('characterSetSize_number', false);
                SetInputValue('characterSetDirectory_text', "extended64-graphic");
                SetInputValue('characterSetSize_number', 64);
            }

            function Click_characterSetExtendedAlphaNum64_checkbox() {
                SetCheckboxSelected('characterSetUpper256_checkbox', false);
                SetCheckboxSelected('characterSetUpperLower256_checkbox', false);
                SetCheckboxSelected('characterSetExtendedGraphic64_checkbox', false);
                SetCheckboxSelected('characterSetExtendedAlphaNum64_checkbox', true);
                SetCheckboxSelected('characterSetCustom_checkbox', false);
                SetInputEnabled('characterSetDirectory_text', false);
                SetInputEnabled('characterSetSize_number', false);
                SetInputValue('characterSetDirectory_text', "extended64-alphanum");
                SetInputValue('characterSetSize_number', 64);
            }

            function Click_characterSetCustom_checkbox() {
                SetCheckboxSelected('characterSetUpper256_checkbox', false);
                SetCheckboxSelected('characterSetUpperLower256_checkbox', false);
                SetCheckboxSelected('characterSetExtendedGraphic64_checkbox', false);
                SetCheckboxSelected('characterSetExtendedAlphaNum64_checkbox', false);
                SetCheckboxSelected('characterSetCustom_checkbox', true);
                SetInputEnabled('characterSetDirectory_text', true);
                SetInputEnabled('characterSetSize_number', true);
            }

            function SetupMatchExactColorAlgorithm() {
                var matchExactColorAlgorithm_checkbox = document.getElementById('matchExactColorAlgorithm_checkbox');
                var matchExactColorAlgorithm_enabled = matchExactColorAlgorithm_checkbox.checked ? true:false;
                if (matchExactColorAlgorithm_enabled) {
                    SetInputEnabled('blackAndWhiteDither_checkbox', false);
                    SetCheckboxSelected('blackAndWhiteDither_checkbox', true);
                    SetInputEnabled('selectedColorDither_checkbox', false);
                    SetCheckboxSelected('selectedColorDither_checkbox', false);
                    SetupBlackAndWhiteDithering();

                    SetInputEnabled('colorBlack_checkbox', false);
                    SetCheckboxSelected('colorBlack_checkbox', false);
                    SetInputEnabled('colorWhite_checkbox', false);
                    SetCheckboxSelected('colorWhite_checkbox', true);
                    SetInputEnabled('colorRed_checkbox', false);
                    SetCheckboxSelected('colorRed_checkbox', false);
                    SetInputEnabled('colorCyan_checkbox', false);
                    SetCheckboxSelected('colorCyan_checkbox', false);
                    SetInputEnabled('colorPurple_checkbox', false);
                    SetCheckboxSelected('colorPurple_checkbox', false);
                    SetInputEnabled('colorGreen_checkbox', false);
                    SetCheckboxSelected('colorGreen_checkbox', false);
                    SetInputEnabled('colorBlue_checkbox', false);
                    SetCheckboxSelected('colorBlue_checkbox', false);
                    SetInputEnabled('colorYellow_checkbox', false);
                    SetCheckboxSelected('colorYellow_checkbox', false);
                    SetInputEnabled('colorOrange_checkbox', false);
                    SetCheckboxSelected('colorOrange_checkbox', false);
                    SetInputEnabled('colorBrown_checkbox', false);
                    SetCheckboxSelected('colorBrown_checkbox', false);
                    SetInputEnabled('colorLightRed_checkbox', false);
                    SetCheckboxSelected('colorLightRed_checkbox', false);
                    SetInputEnabled('colorDarkGrey_checkbox', false);
                    SetCheckboxSelected('colorDarkGrey_checkbox', false);
                    SetInputEnabled('colorGrey_checkbox', false);
                    SetCheckboxSelected('colorGrey_checkbox', false);
                    SetInputEnabled('colorLightGreen_checkbox', false);
                    SetCheckboxSelected('colorLightGreen_checkbox', false);
                    SetInputEnabled('colorLightBlue_checkbox', false);
                    SetCheckboxSelected('colorLightBlue_checkbox', false);
                    SetInputEnabled('colorLightGrey_checkbox', false);
                    SetCheckboxSelected('colorLightGrey_checkbox', false);

                    SetInputEnabled('backgroundColor1_number', false);
                    SetInputValue('backgroundColor1_number', 0);
                } else {
                    SetInputEnabled('blackAndWhiteDither_checkbox', true);
                    SetInputEnabled('selectedColorDither_checkbox', true);

                    SetInputEnabled('colorBlack_checkbox', true);
                    SetInputEnabled('colorWhite_checkbox', true);
                    SetInputEnabled('colorRed_checkbox', true);
                    SetInputEnabled('colorCyan_checkbox', true);
                    SetInputEnabled('colorPurple_checkbox', true);
                    SetInputEnabled('colorGreen_checkbox', true);
                    SetInputEnabled('colorBlue_checkbox', true);
                    SetInputEnabled('colorYellow_checkbox', true);
                    SetInputEnabled('colorOrange_checkbox', true);
                    SetInputEnabled('colorBrown_checkbox', true);
                    SetInputEnabled('colorLightRed_checkbox', true);
                    SetInputEnabled('colorDarkGrey_checkbox', true);
                    SetInputEnabled('colorGrey_checkbox', true);
                    SetInputEnabled('colorLightGreen_checkbox', true);
                    SetInputEnabled('colorLightBlue_checkbox', true);
                    SetInputEnabled('colorLightGrey_checkbox', true);

                    SetInputEnabled('backgroundColor1_number', true);
                }
            }

            function Click_matchExactColorAlgorithm_checkbox() {
                if (GetCheckboxSetting('matchExactColorAlgorithm_checkbox')) {
                    SetCheckboxSelected('minimizeColorDifferencesLinearAlgorithm_checkbox', false);
                    SetCheckboxSelected('minimizeColorDifferencesExponentialAlgorithm_checkbox', false);
                } else {
                    SetCheckboxSelected('matchExactColorAlgorithm_checkbox', true);
                }
                SetupMatchExactColorAlgorithm();
            }

            function Click_minimizeColorDifferencesLinearAlgorithm_checkbox() {
                if (GetCheckboxSetting('minimizeColorDifferencesLinearAlgorithm_checkbox')) {
                    SetCheckboxSelected('matchExactColorAlgorithm_checkbox', false);
                    SetCheckboxSelected('minimizeColorDifferencesExponentialAlgorithm_checkbox', false);
                } else {
                    SetCheckboxSelected('minimizeColorDifferencesLinearAlgorithm_checkbox', true);
                }
                SetupMatchExactColorAlgorithm();
            }

            function Click_minimizeColorDifferencesExponentialAlgorithm_checkbox() {
                if (GetCheckboxSetting('minimizeColorDifferencesExponentialAlgorithm_checkbox')) {
                    SetCheckboxSelected('matchExactColorAlgorithm_checkbox', false);
                    SetCheckboxSelected('minimizeColorDifferencesLinearAlgorithm_checkbox', false);
                } else {
                    SetCheckboxSelected('minimizeColorDifferencesExponentialAlgorithm_checkbox', true);
                }
                SetupMatchExactColorAlgorithm();
            }

            function SetupBlackAndWhiteDithering() {
                if (GetCheckboxSetting('blackAndWhiteDither_checkbox')) {
                    // when dithering also perform greyscale conversion
                    SetInputEnabled('greyscaleConversion_checkbox', false);
                    SetCheckboxSelected('greyscaleConversion_checkbox', true);
                } else {
                    SetInputEnabled('greyscaleConversion_checkbox', true);
                }
            }

            function Click_blackAndWhiteDither_checkbox() {
                SetupBlackAndWhiteDithering();
            }

            function Click_greyscaleConversion_checkbox() {
            }

            function Click_selectedColorDither_checkbox() {
            }

            function Click_propogateDitheringError_checkbox() {
            }

            function Click_useGraphicsCharactersOnly_checkbox() {
            }

            function Click_imageNegative_checkbox() {
            }

            function Click_imageContrast_number() {
                var imageContrast_number = document.getElementById('imageContrast_number');
                if (imageContrast_number.value > 200) {
                    imageContrast_number.value = 200;
                }
                if (imageContrast_number.value < -100) {
                    imageContrast_number.value = -100;
                }
                var imageContrast_range = document.getElementById('imageContrast_range');
                imageContrast_range.value = imageContrast_number.value;

                if (GetCheckboxSetting('lockImage_checkbox')) {
                    RenderWorkingImage();
                    RenderPetsciiImage();
                }
            }

            function Click_imageBrightness_number() {
                var imageBrightness_number = document.getElementById('imageBrightness_number');
                if (imageBrightness_number.value > 400) {
                    imageBrightness_number.value = 400;
                }
                if (imageBrightness_number.value < -100) {
                    imageBrightness_number.value = -100;
                }
                var imageBrightness_range = document.getElementById('imageBrightness_range');
                imageBrightness_range.value = imageBrightness_number.value;

                if (GetCheckboxSetting('lockImage_checkbox')) {
                    RenderWorkingImage();
                    RenderPetsciiImage();
                }
            }

            function Init() {
                document.getElementById('loadFile_button').onclick = function() {
                    LoadFile(document.getElementById('loadFileName_file').value);
                };

                document.getElementById('renderWorkingImage_button').onclick = function() {
                    RenderWorkingImage();

                    if (GetCheckboxSetting('lockImage_checkbox')) {
                        RenderPetsciiImage();
                    }
                };
                
                document.getElementById('matchExactColorAlgorithm_checkbox').onclick = function(){Click_matchExactColorAlgorithm_checkbox()};
                document.getElementById('minimizeColorDifferencesLinearAlgorithm_checkbox').onclick = function(){Click_minimizeColorDifferencesLinearAlgorithm_checkbox()};
                document.getElementById('minimizeColorDifferencesExponentialAlgorithm_checkbox').onclick = function(){Click_minimizeColorDifferencesExponentialAlgorithm_checkbox()};
                document.getElementById('blackAndWhiteDither_checkbox').onclick = function(){Click_blackAndWhiteDither_checkbox()};
                document.getElementById('greyscaleConversion_checkbox').onclick = function(){Click_greyscaleConversion_checkbox()};
                document.getElementById('selectedColorDither_checkbox').onclick = function(){Click_selectedColorDither_checkbox()};
                document.getElementById('propogateDitheringError_checkbox').onclick = function(){Click_propogateDitheringError_checkbox()};
                document.getElementById('imageNegative_checkbox').onclick = function(){Click_imageNegative_checkbox()};

                document.getElementById('imageContrast_range').onclick = function() {
                    var imageContrast_range = document.getElementById('imageContrast_range');
                    var imageContrast_number = document.getElementById('imageContrast_number');
                    imageContrast_number.value = imageContrast_range.value;

                    if (GetCheckboxSetting('lockImage_checkbox')) {
                        RenderWorkingImage();
                        RenderPetsciiImage();
                    }
                };

                document.getElementById('imageContrast_number').onchange = function(){Click_imageContrast_number()};

                document.getElementById('imageBrightness_range').onclick = function() {
                    var imageBrightness_range = document.getElementById('imageBrightness_range');
                    var imageBrightness_number = document.getElementById('imageBrightness_number');
                    imageBrightness_number.value = imageBrightness_range.value;

                    if (GetCheckboxSetting('lockImage_checkbox')) {
                        RenderWorkingImage();
                        RenderPetsciiImage();
                    }
                };

                document.getElementById('imageBrightness_number').onchange = function(){Click_imageBrightness_number()};
                document.getElementById('vic2StandardMode_checkbox').onclick = function(){Click_vic2StandardMode_checkbox()};
                document.getElementById('vic2ExtendedMode_checkbox').onclick = function(){Click_vic2ExtendedMode_checkbox()};

                document.getElementById('colorPresetBlackAndWhite_button').onclick = function() {
                    SetCheckboxSelected('colorBlack_checkbox', false);
                    SetCheckboxSelected('colorWhite_checkbox', true);
                    SetCheckboxSelected('colorRed_checkbox', false);
                    SetCheckboxSelected('colorCyan_checkbox', false);
                    SetCheckboxSelected('colorPurple_checkbox', false);
                    SetCheckboxSelected('colorGreen_checkbox', false);
                    SetCheckboxSelected('colorBlue_checkbox', false);
                    SetCheckboxSelected('colorYellow_checkbox', false);
                    SetCheckboxSelected('colorOrange_checkbox', false);
                    SetCheckboxSelected('colorBrown_checkbox', false);
                    SetCheckboxSelected('colorLightRed_checkbox', false);
                    SetCheckboxSelected('colorDarkGrey_checkbox', false);
                    SetCheckboxSelected('colorGrey_checkbox', false);
                    SetCheckboxSelected('colorLightGreen_checkbox', false);
                    SetCheckboxSelected('colorLightBlue_checkbox', false);
                    SetCheckboxSelected('colorLightGrey_checkbox', false);

                    var backgroundColor1_number = document.getElementById('backgroundColor1_number');
                    backgroundColor1_number.value = 0;
                    var vic2ExtendedMode_checkbox = document.getElementById('vic2ExtendedMode_checkbox');
                    var vic2ExtendedMode_enabled = vic2ExtendedMode_checkbox.checked;
                    if (vic2ExtendedMode_enabled) {
                        SetCheckboxSelected('colorBlack_checkbox', true);
                        var backgroundColor2_number = document.getElementById('backgroundColor2_number');
                        backgroundColor2_number.value = 1;
                        var backgroundColor3_number = document.getElementById('backgroundColor3_number');
                        backgroundColor3_number.value = 0;
                        var backgroundColor4_number = document.getElementById('backgroundColor4_number');
                        backgroundColor4_number.value = 0;
                    }
                }

                document.getElementById('colorPresetGreyscale_button').onclick = function() {
                    SetCheckboxSelected('colorBlack_checkbox', true);
                    SetCheckboxSelected('colorWhite_checkbox', true);
                    SetCheckboxSelected('colorRed_checkbox', false);
                    SetCheckboxSelected('colorCyan_checkbox', false);
                    SetCheckboxSelected('colorPurple_checkbox', false);
                    SetCheckboxSelected('colorGreen_checkbox', false);
                    SetCheckboxSelected('colorBlue_checkbox', false);
                    SetCheckboxSelected('colorYellow_checkbox', false);
                    SetCheckboxSelected('colorOrange_checkbox', false);
                    SetCheckboxSelected('colorBrown_checkbox', false);
                    SetCheckboxSelected('colorLightRed_checkbox', false);
                    SetCheckboxSelected('colorDarkGrey_checkbox', true);
                    SetCheckboxSelected('colorGrey_checkbox', true);
                    SetCheckboxSelected('colorLightGreen_checkbox', false);
                    SetCheckboxSelected('colorLightBlue_checkbox', false);
                    SetCheckboxSelected('colorLightGrey_checkbox', true);

                    var backgroundColor1_number = document.getElementById('backgroundColor1_number');
                    backgroundColor1_number.value = 12;
                    var vic2ExtendedMode_checkbox = document.getElementById('vic2ExtendedMode_checkbox');
                    var vic2ExtendedMode_enabled = vic2ExtendedMode_checkbox.checked;
                    if (vic2ExtendedMode_enabled) {
                        var backgroundColor2_number = document.getElementById('backgroundColor2_number');
                        backgroundColor2_number.value = 11;
                        var backgroundColor3_number = document.getElementById('backgroundColor3_number');
                        backgroundColor3_number.value = 15;
                        var backgroundColor4_number = document.getElementById('backgroundColor4_number');
                        backgroundColor4_number.value = 0;
                    }
                }

                document.getElementById('colorPresetBlues_button').onclick = function() {
                    SetCheckboxSelected('colorBlack_checkbox', false);
                    SetCheckboxSelected('colorWhite_checkbox', true);
                    SetCheckboxSelected('colorRed_checkbox', false);
                    SetCheckboxSelected('colorCyan_checkbox', true);
                    SetCheckboxSelected('colorPurple_checkbox', false);
                    SetCheckboxSelected('colorGreen_checkbox', false);
                    SetCheckboxSelected('colorBlue_checkbox', true);
                    SetCheckboxSelected('colorYellow_checkbox', false);
                    SetCheckboxSelected('colorOrange_checkbox', false);
                    SetCheckboxSelected('colorBrown_checkbox', false);
                    SetCheckboxSelected('colorLightRed_checkbox', false);
                    SetCheckboxSelected('colorDarkGrey_checkbox', false);
                    SetCheckboxSelected('colorGrey_checkbox', false);
                    SetCheckboxSelected('colorLightGreen_checkbox', false);
                    SetCheckboxSelected('colorLightBlue_checkbox', true);
                    SetCheckboxSelected('colorLightGrey_checkbox', false);

                    var backgroundColor1_number = document.getElementById('backgroundColor1_number');
                    backgroundColor1_number.value = 3;
                    var vic2ExtendedMode_checkbox = document.getElementById('vic2ExtendedMode_checkbox');
                    var vic2ExtendedMode_enabled = vic2ExtendedMode_checkbox.checked;
                    if (vic2ExtendedMode_enabled) {
                        var backgroundColor2_number = document.getElementById('backgroundColor2_number');
                        backgroundColor2_number.value = 6;
                        var backgroundColor3_number = document.getElementById('backgroundColor3_number');
                        backgroundColor3_number.value = 14;
                        var backgroundColor4_number = document.getElementById('backgroundColor4_number');
                        backgroundColor4_number.value = 1;
                    }
                };

                document.getElementById('colorPresetBrowns_button').onclick = function() {
                    SetCheckboxSelected('colorBlack_checkbox', true);
                    SetCheckboxSelected('colorWhite_checkbox', false);
                    SetCheckboxSelected('colorRed_checkbox', false);
                    SetCheckboxSelected('colorCyan_checkbox', false);
                    SetCheckboxSelected('colorPurple_checkbox', false);
                    SetCheckboxSelected('colorGreen_checkbox', false);
                    SetCheckboxSelected('colorBlue_checkbox', false);
                    SetCheckboxSelected('colorYellow_checkbox', false);
                    SetCheckboxSelected('colorOrange_checkbox', true);
                    SetCheckboxSelected('colorBrown_checkbox', true);
                    SetCheckboxSelected('colorLightRed_checkbox', false);
                    SetCheckboxSelected('colorDarkGrey_checkbox', true);
                    SetCheckboxSelected('colorGrey_checkbox', false);
                    SetCheckboxSelected('colorLightGreen_checkbox', false);
                    SetCheckboxSelected('colorLightBlue_checkbox', false);
                    SetCheckboxSelected('colorLightGrey_checkbox', false);

                    var backgroundColor1_number = document.getElementById('backgroundColor1_number');
                    backgroundColor1_number.value = 9;
                    var vic2ExtendedMode_checkbox = document.getElementById('vic2ExtendedMode_checkbox');
                    var vic2ExtendedMode_enabled = vic2ExtendedMode_checkbox.checked;
                    if (vic2ExtendedMode_enabled) {
                        var backgroundColor2_number = document.getElementById('backgroundColor2_number');
                        backgroundColor2_number.value = 8;
                        var backgroundColor3_number = document.getElementById('backgroundColor3_number');
                        backgroundColor3_number.value = 11;
                        var backgroundColor4_number = document.getElementById('backgroundColor4_number');
                        backgroundColor4_number.value = 0;
                    }
                };

                document.getElementById('colorPresetReds_button').onclick = function() {
                    SetCheckboxSelected('colorBlack_checkbox', false);
                    SetCheckboxSelected('colorWhite_checkbox', false);
                    SetCheckboxSelected('colorRed_checkbox', true);
                    SetCheckboxSelected('colorCyan_checkbox', false);
                    SetCheckboxSelected('colorPurple_checkbox', false);
                    SetCheckboxSelected('colorGreen_checkbox', false);
                    SetCheckboxSelected('colorBlue_checkbox', false);
                    SetCheckboxSelected('colorYellow_checkbox', false);
                    SetCheckboxSelected('colorOrange_checkbox', true);
                    SetCheckboxSelected('colorBrown_checkbox', true);
                    SetCheckboxSelected('colorLightRed_checkbox', true);
                    SetCheckboxSelected('colorDarkGrey_checkbox', false);
                    SetCheckboxSelected('colorGrey_checkbox', false);
                    SetCheckboxSelected('colorLightGreen_checkbox', false);
                    SetCheckboxSelected('colorLightBlue_checkbox', false);
                    SetCheckboxSelected('colorLightGrey_checkbox', false);

                    var backgroundColor1_number = document.getElementById('backgroundColor1_number');
                    backgroundColor1_number.value = 2;
                    var vic2ExtendedMode_checkbox = document.getElementById('vic2ExtendedMode_checkbox');
                    var vic2ExtendedMode_enabled = vic2ExtendedMode_checkbox.checked;
                    if (vic2ExtendedMode_enabled) {
                        var backgroundColor2_number = document.getElementById('backgroundColor2_number');
                        backgroundColor2_number.value = 9;
                        var backgroundColor3_number = document.getElementById('backgroundColor3_number');
                        backgroundColor3_number.value = 8;
                        var backgroundColor4_number = document.getElementById('backgroundColor4_number');
                        backgroundColor4_number.value = 10;
                    }
                };

                document.getElementById('colorPresetGreens_button').onclick = function() {
                    SetCheckboxSelected('colorBlack_checkbox', false);
                    SetCheckboxSelected('colorWhite_checkbox', false);
                    SetCheckboxSelected('colorRed_checkbox', false);
                    SetCheckboxSelected('colorCyan_checkbox', true);
                    SetCheckboxSelected('colorPurple_checkbox', false);
                    SetCheckboxSelected('colorGreen_checkbox', true);
                    SetCheckboxSelected('colorBlue_checkbox', false);
                    SetCheckboxSelected('colorYellow_checkbox', true);
                    SetCheckboxSelected('colorOrange_checkbox', false);
                    SetCheckboxSelected('colorBrown_checkbox', false);
                    SetCheckboxSelected('colorLightRed_checkbox', false);
                    SetCheckboxSelected('colorDarkGrey_checkbox', false);
                    SetCheckboxSelected('colorGrey_checkbox', false);
                    SetCheckboxSelected('colorLightGreen_checkbox', true);
                    SetCheckboxSelected('colorLightBlue_checkbox', false);
                    SetCheckboxSelected('colorLightGrey_checkbox', false);

                    var backgroundColor1_number = document.getElementById('backgroundColor1_number');
                    backgroundColor1_number.value = 5;
                    var vic2ExtendedMode_checkbox = document.getElementById('vic2ExtendedMode_checkbox');
                    var vic2ExtendedMode_enabled = vic2ExtendedMode_checkbox.checked;
                    if (vic2ExtendedMode_enabled) {
                        var backgroundColor2_number = document.getElementById('backgroundColor2_number');
                        backgroundColor2_number.value = 13;
                        var backgroundColor3_number = document.getElementById('backgroundColor3_number');
                        backgroundColor3_number.value = 3;
                        var backgroundColor4_number = document.getElementById('backgroundColor4_number');
                        backgroundColor4_number.value = 7;
                    }
                };

                document.getElementById('characterSetUpper256_checkbox').onclick = function(){Click_characterSetUpper256_checkbox()};
                document.getElementById('characterSetUpperLower256_checkbox').onclick = function(){Click_characterSetUpperLower256_checkbox()};
                document.getElementById('characterSetExtendedGraphic64_checkbox').onclick = function(){Click_characterSetExtendedGraphic64_checkbox()};
                document.getElementById('characterSetExtendedAlphaNum64_checkbox').onclick = function(){Click_characterSetExtendedAlphaNum64_checkbox()};
                document.getElementById('characterSetCustom_checkbox').onclick = function(){Click_characterSetCustom_checkbox()};

                document.getElementById('renderCharacterSets_button').onclick = function() {
                    C64_SELECTED_FOREGROUND_RGB_COLORS = [];
                    SetSelectedColorsCheckbox('colorBlack_checkbox', C64_RGB_COLOR_BLACK, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    SetSelectedColorsCheckbox('colorWhite_checkbox',  C64_RGB_COLOR_WHITE, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    SetSelectedColorsCheckbox('colorRed_checkbox', C64_RGB_COLOR_RED, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    SetSelectedColorsCheckbox('colorCyan_checkbox', C64_RGB_COLOR_CYAN, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    SetSelectedColorsCheckbox('colorPurple_checkbox', C64_RGB_COLOR_PURPLE, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    SetSelectedColorsCheckbox('colorGreen_checkbox', C64_RGB_COLOR_GREEN, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    SetSelectedColorsCheckbox('colorBlue_checkbox', C64_RGB_COLOR_BLUE, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    SetSelectedColorsCheckbox('colorYellow_checkbox', C64_RGB_COLOR_YELLOW, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    SetSelectedColorsCheckbox('colorOrange_checkbox', C64_RGB_COLOR_ORANGE, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    SetSelectedColorsCheckbox('colorBrown_checkbox', C64_RGB_COLOR_BROWN, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    SetSelectedColorsCheckbox('colorLightRed_checkbox', C64_RGB_COLOR_LIGHTRED, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    SetSelectedColorsCheckbox('colorDarkGrey_checkbox', C64_RGB_COLOR_DARKGREY, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    SetSelectedColorsCheckbox('colorGrey_checkbox', C64_RGB_COLOR_GREY, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    SetSelectedColorsCheckbox('colorLightGreen_checkbox', C64_RGB_COLOR_LIGHTGREEN, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    SetSelectedColorsCheckbox('colorLightBlue_checkbox', C64_RGB_COLOR_LIGHTBLUE, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    SetSelectedColorsCheckbox('colorLightGrey_checkbox', C64_RGB_COLOR_LIGHTGREY, C64_SELECTED_FOREGROUND_RGB_COLORS);

                    C64_SELECTED_BACKGROUND_RGB_COLORS = [];
                    SetSelectedColorsNumber('backgroundColor1_number', C64_SELECTED_BACKGROUND_RGB_COLORS);

                    // The C64 standard character mode limits accuracy of color
                    // transitions because the background color is always set to a
                    // single color (thus color transitions cannot be accurate unless
                    // they are a transition TO the background color). i.e. the
                    // white character set cannot smoothly transition to lightgrey
                    // because the background cannot be lightgrey (if it is already
                    // set to black for the screen). Thus the characters cannot share
                    // both white and lightgrey and thus be used to smooth a transition
                    // from white to lightgrey. Supporting extended (background) color
                    // mode will provide some relief as 4 separate background colors
                    // would then be supported per character. In standard character mode
                    // using monochrome (i.e. a single foreground color) will result in
                    // the most accurate transitions to/from the background color.
                    var vic2ExtendedMode_checkbox = document.getElementById('vic2ExtendedMode_checkbox');
                    var vic2ExtendedMode_enabled = vic2ExtendedMode_checkbox.checked;
                    if (vic2ExtendedMode_enabled) {
                        SetSelectedColorsNumber('backgroundColor2_number', C64_SELECTED_BACKGROUND_RGB_COLORS);
                        SetSelectedColorsNumber('backgroundColor3_number', C64_SELECTED_BACKGROUND_RGB_COLORS);
                        SetSelectedColorsNumber('backgroundColor4_number', C64_SELECTED_BACKGROUND_RGB_COLORS);
                    }

                    RenderCharacterSets();
                };

                document.getElementById('renderPetscii_button').onclick = function() {
                    RenderPetsciiImage();
                };

                document.getElementById('saveFile_button').onclick = function() {
                    var projectJsonOutput_checkbox = document.getElementById('projectJsonOutput_checkbox');
                    var projectJsonOutput_checkbox_enabled = projectJsonOutput_checkbox.checked ? true:false;

                    var binaryCharactersOnlyOutput_checkbox = document.getElementById('binaryCharactersOnlyOutput_checkbox');
                    var binaryCharactersOnlyOutput_enabled = binaryCharactersOnlyOutput_checkbox.checked ? true:false;

                    var binaryCharactersAndColorsOutput_checkbox = document.getElementById('binaryCharactersAndColorsOutput_checkbox');
                    var binaryCharactersAndColorsOutput_enabled = binaryCharactersAndColorsOutput_checkbox.checked ? true:false;

                    var cLanguageTextOutput_checkbox = document.getElementById('cLanguageTextOutput_checkbox');
                    var cLanguageTextOutput_enabled = cLanguageTextOutput_checkbox.checked ? true:false;

                    var asmLanguageTextOutput_checkbox = document.getElementById('asmLanguageTextOutput_checkbox');
                    var asmLanguageTextOutput_enabled = asmLanguageTextOutput_checkbox.checked ? true:false;

                    var c64OsOutput_checkbox = document.getElementById('c64OsOutput_checkbox');
                    var c64OsOutput_enabled = c64OsOutput_checkbox.checked ? true:false;

                    var inputFileName_file = document.getElementById('loadFileName_file');
                    var inputFileName = inputFileName_file.value.split('\\').pop().split('/').pop();
                    SaveByteArray(petsciiCharacterCodes, c64CharacterForegroundColors, c64CharacterBackgroundColors, inputFileName, document.getElementById('saveFileName').value,
                                  projectJsonOutput_checkbox_enabled, binaryCharactersOnlyOutput_enabled, binaryCharactersAndColorsOutput_enabled, cLanguageTextOutput_enabled, asmLanguageTextOutput_enabled, c64OsOutput_enabled);
                };

                document.getElementById('projectJsonOutput_checkbox').onclick = function() {
                    SetCheckboxSelected('projectJsonOutput_checkbox', true);
                    SetCheckboxSelected('binaryCharactersOnlyOutput_checkbox', false);
                    SetCheckboxSelected('binaryCharactersAndColorsOutput_checkbox', false);
                    SetCheckboxSelected('cLanguageTextOutput_checkbox', false);
                    SetCheckboxSelected('asmLanguageTextOutput_checkbox', false);
                    SetCheckboxSelected('c64OsOutput_checkbox', false);
                    UpdateOutputFileName(false);
                    SetInputEnabled('c64OsOutputTitle_text', false);
                    SetInputEnabled('c64OsOutputArtist_text', false);
                    SetInputEnabled('c64OsOutputCopyright_text', false);
                };

                document.getElementById('binaryCharactersOnlyOutput_checkbox').onclick = function() {
                    SetCheckboxSelected('projectJsonOutput_checkbox', false);
                    SetCheckboxSelected('binaryCharactersOnlyOutput_checkbox', true);
                    SetCheckboxSelected('binaryCharactersAndColorsOutput_checkbox', false);
                    SetCheckboxSelected('cLanguageTextOutput_checkbox', false);
                    SetCheckboxSelected('asmLanguageTextOutput_checkbox', false);
                    SetCheckboxSelected('c64OsOutput_checkbox', false);
                    UpdateOutputFileName(false);
                    SetInputEnabled('c64OsOutputTitle_text', false);
                    SetInputEnabled('c64OsOutputArtist_text', false);
                    SetInputEnabled('c64OsOutputCopyright_text', false);
                };

                document.getElementById('binaryCharactersAndColorsOutput_checkbox').onclick = function() {
                    SetCheckboxSelected('projectJsonOutput_checkbox', false);
                    SetCheckboxSelected('binaryCharactersOnlyOutput_checkbox', false);
                    SetCheckboxSelected('binaryCharactersAndColorsOutput_checkbox', true);
                    SetCheckboxSelected('cLanguageTextOutput_checkbox', false);
                    SetCheckboxSelected('asmLanguageTextOutput_checkbox', false);
                    SetCheckboxSelected('c64OsOutput_checkbox', false);
                    UpdateOutputFileName(false);
                    SetInputEnabled('c64OsOutputTitle_text', false);
                    SetInputEnabled('c64OsOutputArtist_text', false);
                    SetInputEnabled('c64OsOutputCopyright_text', false);
                };

                document.getElementById('cLanguageTextOutput_checkbox').onclick = function() {
                    SetCheckboxSelected('projectJsonOutput_checkbox', false);
                    SetCheckboxSelected('binaryCharactersOnlyOutput_checkbox', false);
                    SetCheckboxSelected('binaryCharactersAndColorsOutput_checkbox', false);
                    SetCheckboxSelected('cLanguageTextOutput_checkbox', true);
                    SetCheckboxSelected('asmLanguageTextOutput_checkbox', false);
                    SetCheckboxSelected('c64OsOutput_checkbox', false);
                    UpdateOutputFileName(false);
                    SetInputEnabled('c64OsOutputTitle_text', false);
                    SetInputEnabled('c64OsOutputArtist_text', false);
                    SetInputEnabled('c64OsOutputCopyright_text', false);
                };

                document.getElementById('asmLanguageTextOutput_checkbox').onclick = function() {
                    SetCheckboxSelected('projectJsonOutput_checkbox', false);
                    SetCheckboxSelected('binaryCharactersOnlyOutput_checkbox', false);
                    SetCheckboxSelected('binaryCharactersAndColorsOutput_checkbox', false);
                    SetCheckboxSelected('cLanguageTextOutput_checkbox', false);
                    SetCheckboxSelected('asmLanguageTextOutput_checkbox', true);
                    SetCheckboxSelected('c64OsOutput_checkbox', false);
                    UpdateOutputFileName(false);
                    SetInputEnabled('c64OsOutputTitle_text', false);
                    SetInputEnabled('c64OsOutputArtist_text', false);
                    SetInputEnabled('c64OsOutputCopyright_text', false);
                };

                document.getElementById('c64OsOutput_checkbox').onclick = function() {
                    SetCheckboxSelected('projectJsonOutput_checkbox', false);
                    SetCheckboxSelected('binaryCharactersOnlyOutput_checkbox', false);
                    SetCheckboxSelected('binaryCharactersAndColorsOutput_checkbox', false);
                    SetCheckboxSelected('cLanguageTextOutput_checkbox', false);
                    SetCheckboxSelected('asmLanguageTextOutput_checkbox', false);
                    SetCheckboxSelected('c64OsOutput_checkbox', true);
                    UpdateOutputFileName(false);
                    SetInputEnabled('c64OsOutputTitle_text', true);
                    SetInputEnabled('c64OsOutputArtist_text', true);
                    SetInputEnabled('c64OsOutputCopyright_text', true);
                };
            }

            function GetFileNameFromPath(filePath) {
                var separator = '/';
                // check which separator character our browser is using
                if (filePath.includes("\\")) {
                    separator = '\\';
                }
                var fileName = filePath.split(separator).pop();
                return fileName;
            }

            function LoadFile(inputFilePath) {
                var inputFileName = GetFileNameFromPath(inputFilePath);
                var fileSplits = inputFileName.split('.');
                var fileExtension = fileSplits[fileSplits.length-1];
                if (fileExtension == "project") {
                    LoadProjectFile("Sample Images/" + inputFileName);
                } else {
                    LoadImageFile(inputFileName);
                }
            }

            function LoadImageFile(inputFileName) {
                var sourceImage = document.getElementById('sourceImage');
                sourceImage.src = "Sample Images/" + inputFileName;
                //sourceImage.crossOrigin = null;
                //sourceImage.crossOrigin = "Anonymous";
                sourceImage.title = inputFileName;

                var c64OsOutputTitle_text = document.getElementById('c64OsOutputTitle_text');
                c64OsOutputTitle_text.value = inputFileName.split('.')[0]
                UpdateOutputFileName(true);
            }

            function LoadProjectFile(inputFilePath) {
                fetch(inputFilePath).then(response => response.json()).then(data => {
                    LoadImageFile(data["inputFileName"]);
                    if (data["vic2ExtendedMode"]) {
                        Click_vic2ExtendedMode_checkbox();
                        SetInputValue('backgroundColor1_number', data["selectedBackgroundColors"][0]);
                        SetInputValue('backgroundColor2_number', data["selectedBackgroundColors"][1]);
                        SetInputValue('backgroundColor3_number', data["selectedBackgroundColors"][2]);
                        SetInputValue('backgroundColor4_number', data["selectedBackgroundColors"][3]);
                    } else {
                        Click_vic2StandardMode_checkbox();
                        SetInputValue('backgroundColor1_number', data["selectedBackgroundColors"][0]);
                    }

                    SetCheckboxSelected('colorBlack_checkbox', false);
                    SetCheckboxSelected('colorWhite_checkbox', false);
                    SetCheckboxSelected('colorRed_checkbox', false);
                    SetCheckboxSelected('colorCyan_checkbox', false);
                    SetCheckboxSelected('colorPurple_checkbox', false);
                    SetCheckboxSelected('colorGreen_checkbox', false);
                    SetCheckboxSelected('colorBlue_checkbox', false);
                    SetCheckboxSelected('colorYellow_checkbox', false);
                    SetCheckboxSelected('colorOrange_checkbox', false);
                    SetCheckboxSelected('colorBrown_checkbox', false);
                    SetCheckboxSelected('colorLightRed_checkbox', false);
                    SetCheckboxSelected('colorDarkGrey_checkbox', false);
                    SetCheckboxSelected('colorGrey_checkbox', false);
                    SetCheckboxSelected('colorLightGreen_checkbox', false);
                    SetCheckboxSelected('colorLightBlue_checkbox', false);
                    SetCheckboxSelected('colorLightGrey_checkbox', false);
                    
                    for (var i=0; i<data["selectedForegroundColors"].length; i++) {
                        var selectedColor = data["selectedForegroundColors"][i];
                        switch (selectedColor) {
                            case C64_COLOR_CODE_BLACK:
                                SetCheckboxSelected('colorBlack_checkbox', true);
                                break;
                            case C64_COLOR_CODE_WHITE:
                                SetCheckboxSelected('colorWhite_checkbox', true);
                                break;
                            case C64_COLOR_CODE_RED:
                                SetCheckboxSelected('colorRed_checkbox', true);
                                break;
                            case C64_COLOR_CODE_CYAN:
                                SetCheckboxSelected('colorCyan_checkbox', true);
                                break;
                            case C64_COLOR_CODE_PURPLE:
                                SetCheckboxSelected('colorPurple_checkbox', true);
                                break;
                            case C64_COLOR_CODE_GREEN:
                                SetCheckboxSelected('colorGreen_checkbox', true);
                                break;
                            case C64_COLOR_CODE_BLUE:
                                SetCheckboxSelected('colorBlue_checkbox', true);
                                break;
                            case C64_COLOR_CODE_YELLOW:
                                SetCheckboxSelected('colorYellow_checkbox', true);
                                break;
                            case C64_COLOR_CODE_ORANGE:
                                SetCheckboxSelected('colorOrange_checkbox', true);
                                break;
                            case C64_COLOR_CODE_BROWN:
                                SetCheckboxSelected('colorBrown_checkbox', true);
                                break;
                            case C64_COLOR_CODE_LIGHTRED:
                                SetCheckboxSelected('colorLightRed_checkbox', true);
                                break;
                            case C64_COLOR_CODE_DARKGREY:
                                SetCheckboxSelected('colorDarkGrey_checkbox', true);
                                break;
                            case C64_COLOR_CODE_GREY:
                                SetCheckboxSelected('colorGrey_checkbox', true);
                                break;
                            case C64_COLOR_CODE_LIGHTGREEN:
                                SetCheckboxSelected('colorLightGreen_checkbox', true);
                                break;
                            case C64_COLOR_CODE_LIGHTBLUE:
                                SetCheckboxSelected('colorLightBlue_checkbox', true);
                                break;
                            case C64_COLOR_CODE_LIGHTGREY:
                                SetCheckboxSelected('colorLightGrey_checkbox', true);
                                break;
                        }
                    }

                    if (data["characterSetUpper256"]) {
                        Click_characterSetUpper256_checkbox();
                    }
                    if (data["characterSetUpperLower256"]) {
                        Click_characterSetUpperLower256_checkbox();
                    }
                    if (data["characterSetExtendedGraphic64"]) {
                        Click_characterSetExtendedGraphic64_checkbox();
                    }
                    if (data["characterSetExtendedAlphaNum64"]) {
                        Click_characterSetExtendedAlphaNum64_checkbox();
                    }
                    if (data["characterSetCustom"]) {
                        Click_characterSetCustom_checkbox();
                        SetInputValue('characterSetDirectory_text', data["characterSetDirectory"]);
                        SetInputValue('characterSetSize_number', data["characterSetSize"]);
                    }

                    SetCheckboxSelected('matchExactColorAlgorithm_checkbox', false);
                    if (data["matchExactColorAlgorithm"]) {
                        SetCheckboxSelected('matchExactColorAlgorithm_checkbox', true);
                        Click_matchExactColorAlgorithm_checkbox();
                    }
                    SetCheckboxSelected('minimizeColorDifferencesLinearAlgorithm_checkbox', false);
                    if (data["minimizeColorDifferencesLinearAlgorithm"]) {
                        SetCheckboxSelected('minimizeColorDifferencesLinearAlgorithm_checkbox', true);
                        Click_minimizeColorDifferencesLinearAlgorithm_checkbox();
                    }
                    SetCheckboxSelected('minimizeColorDifferencesExponentialAlgorithm_checkbox', false);
                    if (data["minimizeColorDifferencesExponentialAlgorithm"]) {
                        SetCheckboxSelected('minimizeColorDifferencesExponentialAlgorithm_checkbox', true);
                        Click_minimizeColorDifferencesExponentialAlgorithm_checkbox();
                    }

                    SetCheckboxSelected('blackAndWhiteDither_checkbox', false);
                    if (data["blackAndWhiteDither"]) {
                        SetCheckboxSelected('blackAndWhiteDither_checkbox', true);
                        Click_blackAndWhiteDither_checkbox();
                    }
                    SetCheckboxSelected('greyscaleConversion_checkbox', false);
                    if (data["greyscaleConversion"]) {
                        SetCheckboxSelected('greyscaleConversion_checkbox', true);
                        Click_greyscaleConversion_checkbox();
                    }
                    SetCheckboxSelected('selectedColorDither_checkbox', false);
                    if (data["selectedColorDither"]) {
                        SetCheckboxSelected('selectedColorDither_checkbox', true);
                        Click_selectedColorDither_checkbox();
                    }
                    SetCheckboxSelected('propogateDitheringError_checkbox', false);
                    if (data["propogateDitheringError"]) {
                        SetCheckboxSelected('propogateDitheringError_checkbox', true);
                        Click_propogateDitheringError_checkbox();
                    }
                    SetCheckboxSelected('imageNegative_checkbox', false);
                    if (data["imageNegative"]) {
                        SetCheckboxSelected('imageNegative_checkbox', true);
                        Click_imageNegative_checkbox();
                    }

                    SetInputValue('imageContrast_number', data["imageContrast"]);
                    SetInputValue('imageBrightness_number', data["imageBrightness"]);

                    SetCheckboxSelected('useGraphicsCharactersOnly_checkbox', false);
                    if (data["useGraphicsCharactersOnly"]) {
                        SetCheckboxSelected('useGraphicsCharactersOnly_checkbox', true);
                        Click_useGraphicsCharactersOnly_checkbox();
                    }
                    SetInputValue('colorSubstitutions_text', data["colorSubstitutions"]);
                })
            }

            function RenderWorkingImage() {
                var sourceImage = document.getElementById('sourceImage');

                var workingImageCanvas = document.getElementById('workingImageCanvas');
                var workingImageCanvasContext = workingImageCanvas.getContext("2d", { willReadFrequently: true });
                workingImageCanvasContext.drawImage(sourceImage,0,0,WIDTH,HEIGHT);

                var blackAndWhiteDither_checkbox = document.getElementById('blackAndWhiteDither_checkbox');
                var skipBlackAndWhiteDithering = blackAndWhiteDither_checkbox.checked ? false:true;
                var selectedColorDither_checkbox = document.getElementById('selectedColorDither_checkbox');
                var skipSelectedColorDithering = selectedColorDither_checkbox.checked ? false:true;
                var propogateDitheringError_checkbox = document.getElementById('propogateDitheringError_checkbox');
                var propogateDitheringError = propogateDitheringError_checkbox.checked ? true:false;
                var greyscaleConversion_checkbox = document.getElementById('greyscaleConversion_checkbox');
                var greyscaleConversion = greyscaleConversion_checkbox.checked ? true:false;
                srcdata = CreateWorkingImage(workingImageCanvasContext, WIDTH, HEIGHT, skipBlackAndWhiteDithering, greyscaleConversion, skipSelectedColorDithering, propogateDitheringError, false, false, false); //Adjust contrast, Adjust brightness, Process negative
            }

            function RenderCharacterSets() {
                var formatCharacterSets_checkbox = document.getElementById('formatCharacterSets_checkbox');
                var formatCharacterSets = formatCharacterSets_checkbox.checked ? true:false;

                var character = document.getElementById("character");
                characterContainer = document.getElementById("charsetContainer");

                //clean up character elements from last run (if any)
                while (characterContainer.hasChildNodes()) {
                    characterContainer.removeChild(characterContainer.firstChild);
                }

                var characterSetSize_number = document.getElementById('characterSetSize_number');
                CHARACTERS = parseInt(characterSetSize_number.value);

                characterCanvas = [];
                var j = 0;
                for (var selectedBackgroundColorIndex=0; selectedBackgroundColorIndex<C64_SELECTED_BACKGROUND_RGB_COLORS.length; selectedBackgroundColorIndex++) {
                    for (var selectedForegroundColorIndex=0; selectedForegroundColorIndex<C64_SELECTED_FOREGROUND_RGB_COLORS.length; selectedForegroundColorIndex++) {
                        for(var i=0;i<CHARACTERS;i++) {
                            var charCanvas = document.createElement("canvas");
                            charCanvas.setAttribute("width", CWIDTH);
                            charCanvas.setAttribute("height",CHEIGHT);
                            
                            charCanvas.style.width       = CWIDTH  + "px";
                            charCanvas.style.height      = CHEIGHT + "px";
                            charCanvas.style.marginRight = "2px";
                            
                            characterContainer.appendChild(charCanvas);
                            characterCanvas.push(charCanvas);

                            if (formatCharacterSets) {
                                if((i + 1) % 32 == 0) {
                                    characterContainer.appendChild(document.createElement("br"));
                                }
                            }

                        }
                        characterContainer.appendChild(document.createElement("br"));
                        
                        character.onload = function() {
                            var charCanvas  = characterCanvas[j];
                            var charContext = charCanvas.getContext("2d", { willReadFrequently: true });
                            var calculatedBackgroundColorIndex = Math.floor(j/(CHARACTERS*C64_SELECTED_FOREGROUND_RGB_COLORS.length));
                            var calculatedForegroundColorIndex = Math.floor((j%(CHARACTERS*C64_SELECTED_FOREGROUND_RGB_COLORS.length))/CHARACTERS);
                            
                            charContext.drawImage(character, 0, 0);
                            pxbuf = CreateWorkingImage(charContext, CWIDTH, CHEIGHT, true, true, true, false, true, true, true); //Skip black&white dithering, Perform greyscale conversion, Skip selected color dithering, Propogate dithering error, Skip contrast, Skip brightness, Skip negative

                            // create C64 character set bytes (in C64 ROM format) for saving with C64OS format (later).
                            //If the user selects foreground == background color it will be impossible to make this later as original font color information will be overwritten (below).
                            if (j<CHARACTERS) {
                                for(var px=0; px<pxbuf.length; px+=8) {
                                    var c64CustomCharacterByte = 0x00;
                                    if(pxbuf[px  ][0] >= 128) { //because font is single color white and RGB components are equal after greyscale conversion (above) we only need to compare one color component
                                        c64CustomCharacterByte += 1;
                                    }
                                    if(pxbuf[px+1][0] >= 128) {
                                        c64CustomCharacterByte += 2;
                                    }
                                    if(pxbuf[px+2][0] >= 128) {
                                        c64CustomCharacterByte += 4;
                                    }
                                    if(pxbuf[px+3][0] >= 128) {
                                        c64CustomCharacterByte += 8;
                                    }
                                    if(pxbuf[px+4][0] >= 128) {
                                        c64CustomCharacterByte += 16;
                                    }
                                    if(pxbuf[px+5][0] >= 128) {
                                        c64CustomCharacterByte += 32;
                                    }
                                    if(pxbuf[px+6][0] >= 128) {
                                        c64CustomCharacterByte += 64;
                                    }
                                    if(pxbuf[px+7][0] >= 128) {
                                        c64CustomCharacterByte += 128;
                                    }
                                    c64CustomCharacterSetBytes[j*8 + Math.trunc(px/8)] = c64CustomCharacterByte;
                                }
                            }

                            // change character data color
                            for(var px=0; px<pxbuf.length; px++) {
                                // dithering, for a single color white font this won't change anything. set to desired color
                                if(pxbuf[px][0] < 128) { //because font is single color white and RGB components are equal after greyscale conversion (above) we only need to compare one color component
                                    pxbuf[px][0] = C64_SELECTED_BACKGROUND_RGB_COLORS[calculatedBackgroundColorIndex][0];
                                    pxbuf[px][1] = C64_SELECTED_BACKGROUND_RGB_COLORS[calculatedBackgroundColorIndex][1];
                                    pxbuf[px][2] = C64_SELECTED_BACKGROUND_RGB_COLORS[calculatedBackgroundColorIndex][2];
                                } else {
                                    pxbuf[px][0] = C64_SELECTED_FOREGROUND_RGB_COLORS[calculatedForegroundColorIndex][0];
                                    pxbuf[px][1] = C64_SELECTED_FOREGROUND_RGB_COLORS[calculatedForegroundColorIndex][1];
                                    pxbuf[px][2] = C64_SELECTED_FOREGROUND_RGB_COLORS[calculatedForegroundColorIndex][2];
                                }
                            }
                            chardata[j] = pxbuf;

                            var imageWidth = charContext.canvas.clientWidth;
                            var imageHeight = charContext.canvas.clientHeight;
                            var imageData = charContext.getImageData(0, 0, imageWidth, imageHeight);
                            var imagePixels = imageData.data;
                            // change character image color
                            for(var k=0; k<imagePixels.length; k+=4) {
                                // dithering, for a single color white font this won't change anything. set to desired color
                                if (imagePixels[k  ] < 128) { //because font is single color white and RGB components are equal after greyscale conversion (above) we only need to compare one color component
                                    imagePixels[k  ] = C64_SELECTED_BACKGROUND_RGB_COLORS[calculatedBackgroundColorIndex][0];
                                    imagePixels[k+1] = C64_SELECTED_BACKGROUND_RGB_COLORS[calculatedBackgroundColorIndex][1];
                                    imagePixels[k+2] = C64_SELECTED_BACKGROUND_RGB_COLORS[calculatedBackgroundColorIndex][2];
                                } else {
                                    imagePixels[k  ] = C64_SELECTED_FOREGROUND_RGB_COLORS[calculatedForegroundColorIndex][0];
                                    imagePixels[k+1] = C64_SELECTED_FOREGROUND_RGB_COLORS[calculatedForegroundColorIndex][1];
                                    imagePixels[k+2] = C64_SELECTED_FOREGROUND_RGB_COLORS[calculatedForegroundColorIndex][2];
                                }
                                imagePixels[k+3] = 255;
                            }
                            charContext.putImageData(imageData, 0, 0);

                            j++;
                            loadCharacter();
                        };

                        var loadCharacter = function() {
                            if(j >= (CHARACTERS*C64_SELECTED_FOREGROUND_RGB_COLORS.length*C64_SELECTED_BACKGROUND_RGB_COLORS.length)) {
                                return;
                            }
                            var characterSetDirectory_text = document.getElementById('characterSetDirectory_text');
                            character.src = characterSetDirectory_text.value + "/" + (j%CHARACTERS) + ".gif";
                            //character.crossOrigin = null;
                            //character.crossOrigin = "Anonymous";
                            
                        };
                        
                        loadCharacter();
                    }
                }
            }

            function RenderPetsciiImage() {
                var colorSubstitutions = null;
                var colorSubstitutions_text = GetInputValue('colorSubstitutions_text');
                if (colorSubstitutions_text.length > 0) {
                    colorSubstitutions = colorSubstitutions_text.split(/\s+/);
                }
                var minimizeColorDifferencesLinearAlgorithm_checkbox = document.getElementById('minimizeColorDifferencesLinearAlgorithm_checkbox');
                var minimizeColorDifferencesLinearAlgorithm = minimizeColorDifferencesLinearAlgorithm_checkbox.checked ? true:false;
                var minimizeColorDifferencesExponentialAlgorithm_checkbox = document.getElementById('minimizeColorDifferencesExponentialAlgorithm_checkbox');
                var minimizeColorDifferencesExponentialAlgorithm = minimizeColorDifferencesExponentialAlgorithm_checkbox.checked ? true:false;
                var useGraphicsCharactersOnly_checkbox = document.getElementById('useGraphicsCharactersOnly_checkbox');
                var useGraphicsCharactersOnly_enabled = useGraphicsCharactersOnly_checkbox.checked ? true:false;

                var canvas = document.getElementById('canvas');
                var canvasContext = canvas.getContext("2d", { willReadFrequently: true });
                Render(canvasContext, minimizeColorDifferencesLinearAlgorithm, minimizeColorDifferencesExponentialAlgorithm, useGraphicsCharactersOnly_enabled, colorSubstitutions);
            }
            
            function WeightAlphaChannel(color, alpha) {
                //Weight the alpha channel. --Thanks to Chris Roy!
                var aDiff = 256 - alpha;
                var gDiff = 256 - color;
                var newColor = (gDiff * aDiff / 256) + color;
                return newColor;
            }

            function CreateWorkingImage(context, w, h, skipBlackAndWhiteDithering, greyscaleConversion, skipSelectedColorDithering, propogateDitheringError, skipContrast, skipBrightness, skipNegative) {
                var imgd = context.getImageData(0, 0, w,h);

                if (!skipContrast) {
                    var imageContrast_number = document.getElementById('imageContrast_number');
                    contrast = parseInt(imageContrast_number.value);
                    if (contrast != 0) {
                        imgd = ContrastImage(imgd, contrast);
                    } 
                }

                if (!skipBrightness) {
                    var imageBrightness_number = document.getElementById('imageBrightness_number');
                    brightness = parseInt(imageBrightness_number.value);
                    if (brightness != 0) {
                        imgd = BrightnessImage(imgd, brightness);
                    }
                }

                if (!skipNegative) {
                    var imageNegative_checkbox = document.getElementById('imageNegative_checkbox');
                    negative_selected = imageNegative_checkbox.checked;
                    if (negative_selected) {
                        imgd = NegativeImage(imgd);
                    }
                }

                var pix  = imgd.data;
                
                var x = 0;
                var y = 0;
                
                var id = context.createImageData(1,1);
                var d  = id.data;
                
                var ebBuf = [];
                
                for(var i=0,il=pix.length;i<il;i+=4) {
                    var newRed;
                    var newGreen;
                    var newBlue;

                    if (greyscaleConversion) {
                        newRed   = pix[i  ] * .3 + 
                                   pix[i+1] * .59 + 
                                   pix[i+2] * .11;
                        newGreen = newRed;
                        newBlue  = newRed;
                    } else {
                        newRed   = pix[i  ]; 
                        newGreen = pix[i+1];
                        newBlue  = pix[i+2];
                    }
                    newColor = [newRed, newGreen, newBlue];
                    ebBuf.push(newColor);
                }
                
                if (!skipBlackAndWhiteDithering) {
                    BlackAndWhiteDither(ebBuf, w, h, propogateDitheringError);
                }
                
                if (!skipSelectedColorDithering) {
                    SelectedColorDither(ebBuf, w, h, propogateDitheringError);
                }
                
                for(var i=0;i<ebBuf.length;i++) {
                    d[0] = ebBuf[i][0];
                    d[1] = ebBuf[i][1];
                    d[2] = ebBuf[i][2];
                    d[3] = 255;
                    context.putImageData(id,x,y);                

                    x++;
                    if(x >= WIDTH) {
                        x = 0;
                        y++;
                    }
                }
                
                return ebBuf;
            }

            // refer to: https://stackoverflow.com/questions/10521978/html5-canvas-image-contrast
            function ContrastImage(imageData, contrast) {  //input range [-100..200]
                var data = imageData.data;
                contrast = (contrast/100) + 1; //convert to decimal and shift range: [0..3]
                var intercept = 259 * (1 - contrast);
                for(var i=0; i<data.length; i+=4) {   //r,g,b,a
                    data[i  ] = Math.min(Math.trunc(data[i  ] * contrast + intercept), 255);
                    data[i+1] = Math.min(Math.trunc(data[i+1] * contrast + intercept), 255);
                    data[i+2] = Math.min(Math.trunc(data[i+2] * contrast + intercept), 255);
                }
                return imageData;
            }

            // refer to: https://hackernoon.com/image-processing-algorithms-adjusting-contrast-and-image-brightness-0y4y318a
            function BrightnessImage(imageData, brightness) {  //input range [-100..400]
                var data = imageData.data;
                brightness = brightness / 100; //shift range: [-1..4]
                for(var i=0; i<data.length; i+=4) {   //r,g,b,a
                    data[i  ] = Math.trunc(data[i  ] * (1 + brightness));
                    data[i+1] = Math.trunc(data[i+1] * (1 + brightness));
                    data[i+2] = Math.trunc(data[i+2] * (1 + brightness));
                }
                return imageData;
            };

            function NegativeImage(imageData) {
                var data = imageData.data;
                for(var i=0; i<data.length; i+=4) {   //r,g,b,a
                    data[i  ] = 255 - data[i  ];
                    data[i+1] = 255 - data[i+1];
                    data[i+2] = 255 - data[i+2];
                }
                return imageData;
            };

            // dithering (with Floyd-Steinberg error diffusion) from greyscale to a two-color image (black/white)
            function BlackAndWhiteDither(sb, w, h, propogateError) {   // source buffer, width, height
                for(var y=0; y<h; y++) {
                    for(var x=0; x<w; x++) {
                        var ci = y*w+x;               // current buffer index
                        var cc = sb[ci][0];           // current color (red, red component is same as green and blue since its a greyscale image)
                        var rc = (cc<128?0:255);      // real (rounded) color
                        var err = cc-rc;              // error amount

                        sb[ci][0] = rc;                  // saving real color (red)
                        sb[ci][1] = rc;                  // saving real color (green, since image is greyscale color is the same as red)
                        sb[ci][2] = rc;                  // saving real color (blue, since image is greyscale color is the same as red)

                        if (propogateError) {
                            if(x+1 < w) {
                                sb[ci+1][0] += (err*7)>>4;  // if right neighbour exists (red)
                                sb[ci+1][1] += (err*7)>>4;  // if right neighbour exists (green)
                                sb[ci+1][2] += (err*7)>>4;  // if right neighbour exists (blue)
                            }
        
                            // if there is another line below our current image line then use it for rounding error
                            if(y+1 < h) {
                                if(x > 0) {
                                    sb[ci+w-1][0] += (err*3)>>4;  // bottom left neighbour (red)
                                    sb[ci+w-1][1] += (err*3)>>4;  // bottom left neighbour (green)
                                    sb[ci+w-1][2] += (err*3)>>4;  // bottom left neighbour (blue)
                                }

                                sb[ci+w][0] += (err*5)>>4;  // bottom neighbour (red)
                                sb[ci+w][1] += (err*5)>>4;  // bottom neighbour (green)
                                sb[ci+w][2] += (err*5)>>4;  // bottom neighbour (blue)

                                if(x+1 < w) {
                                    sb[ci+w+1][0] += (err*1)>>4;  // bottom right neighbour (red)
                                    sb[ci+w+1][1] += (err*1)>>4;  // bottom right neighbour (green)
                                    sb[ci+w+1][2] += (err*1)>>4;  // bottom right neighbour (blue)
                                }
                            }
                        }
                    }
                }
            }
            
            // dithering (with Floyd-Steinberg error diffusion) from original color image to selected C64 color image
            function SelectedColorDither(sb, w, h, propogateError) {   // source buffer, width, height
                for(var y=0; y<h; y++) {
                    for(var x=0; x<w; x++) {
                        var ci = y*w+x;               // current buffer index
                        var cc = sb[ci];              // current color
                        var rc = [0,0,0];             // real (dithered) color
                        var err = [255, 255, 255];    // error amount

                        for (var selectedBackgroundColorIndex=0; selectedBackgroundColorIndex<C64_SELECTED_BACKGROUND_RGB_COLORS.length; selectedBackgroundColorIndex++) {
                            tmpErr = (Math.abs(cc[0] - C64_SELECTED_BACKGROUND_RGB_COLORS[selectedBackgroundColorIndex][0])) +
                                     (Math.abs(cc[1] - C64_SELECTED_BACKGROUND_RGB_COLORS[selectedBackgroundColorIndex][1])) +
                                     (Math.abs(cc[2] - C64_SELECTED_BACKGROUND_RGB_COLORS[selectedBackgroundColorIndex][2]));
                            if (tmpErr < (Math.abs(err[0]) + Math.abs(err[1]) + Math.abs(err[2])))
                            {
                                rc[0] = C64_SELECTED_BACKGROUND_RGB_COLORS[selectedBackgroundColorIndex][0];
                                rc[1] = C64_SELECTED_BACKGROUND_RGB_COLORS[selectedBackgroundColorIndex][1];
                                rc[2] = C64_SELECTED_BACKGROUND_RGB_COLORS[selectedBackgroundColorIndex][2];
                                err[0] = cc[0] - C64_SELECTED_BACKGROUND_RGB_COLORS[selectedBackgroundColorIndex][0];
                                err[1] = cc[1] - C64_SELECTED_BACKGROUND_RGB_COLORS[selectedBackgroundColorIndex][1];
                                err[2] = cc[2] - C64_SELECTED_BACKGROUND_RGB_COLORS[selectedBackgroundColorIndex][2];
                            }
                        }
                        for (var selectedForegroundColorIndex=0; selectedForegroundColorIndex<C64_SELECTED_FOREGROUND_RGB_COLORS.length; selectedForegroundColorIndex++) {
                            tmpErr = (Math.abs(cc[0] - C64_SELECTED_FOREGROUND_RGB_COLORS[selectedForegroundColorIndex][0])) +
                                     (Math.abs(cc[1] - C64_SELECTED_FOREGROUND_RGB_COLORS[selectedForegroundColorIndex][1])) +
                                     (Math.abs(cc[2] - C64_SELECTED_FOREGROUND_RGB_COLORS[selectedForegroundColorIndex][2]));
                            if (tmpErr < (Math.abs(err[0]) + Math.abs(err[1]) + Math.abs(err[2])))
                            {
                                rc[0] = C64_SELECTED_FOREGROUND_RGB_COLORS[selectedForegroundColorIndex][0];
                                rc[1] = C64_SELECTED_FOREGROUND_RGB_COLORS[selectedForegroundColorIndex][1];
                                rc[2] = C64_SELECTED_FOREGROUND_RGB_COLORS[selectedForegroundColorIndex][2];
                                err[0] = cc[0] - C64_SELECTED_FOREGROUND_RGB_COLORS[selectedForegroundColorIndex][0];
                                err[1] = cc[1] - C64_SELECTED_FOREGROUND_RGB_COLORS[selectedForegroundColorIndex][1];
                                err[2] = cc[2] - C64_SELECTED_FOREGROUND_RGB_COLORS[selectedForegroundColorIndex][2];
                            }
                        }

                        sb[ci][0] = rc[0];            // saving real color (red)
                        sb[ci][1] = rc[1];            // saving real color (green, since image is greyscale color is the same as red)
                        sb[ci][2] = rc[2];            // saving real color (blue, since image is greyscale color is the same as red)

                        if (propogateError) {
                            if(x+1 < w) {
                                sb[ci+1][0] += (err[0]*7)>>4;  // if right neighbour exists (red)
                                sb[ci+1][1] += (err[1]*7)>>4;  // if right neighbour exists (green)
                                sb[ci+1][2] += (err[2]*7)>>4;  // if right neighbour exists (blue)
                            }
        
                            // if there is another line below our current image line then use it for rounding error
                            if(y+1 < h) {
                                if(x > 0) {
                                    sb[ci+w-1][0] += (err[0]*3)>>4;  // bottom left neighbour (red)
                                    sb[ci+w-1][1] += (err[1]*3)>>4;  // bottom left neighbour (green)
                                    sb[ci+w-1][2] += (err[2]*3)>>4;  // bottom left neighbour (blue)
                                }

                                sb[ci+w][0] += (err[0]*5)>>4;  // bottom neighbour (red)
                                sb[ci+w][1] += (err[1]*5)>>4;  // bottom neighbour (green)
                                sb[ci+w][2] += (err[2]*5)>>4;  // bottom neighbour (blue)

                                if(x+1 < w) {
                                    sb[ci+w+1][0] += (err[0]*1)>>4;  // bottom right neighbour (red)
                                    sb[ci+w+1][1] += (err[1]*1)>>4;  // bottom right neighbour (green)
                                    sb[ci+w+1][2] += (err[2]*1)>>4;  // bottom right neighbour (blue)
                                }
                            }
                        }
                    }
                }
            }

            function ProcessColorSubstitutions(originalCharacterColor, isForegroundColor, colorSubstitutions) {
                if (colorSubstitutions != null) {
                    for (var i=0; i<colorSubstitutions.length; i++) {
                        var colorSubstitution = colorSubstitutions[i];
                        var sourceAndDestinationColors = colorSubstitution.split("=");
                        var sourceColor = sourceAndDestinationColors[0];
                        var destinationColor = sourceAndDestinationColors[1];
                        if (sourceColor[0] == "F") {
                            if (isForegroundColor) {
                                if (destinationColor[0] != "F") {
                                    console.log("Invalid color substitution, cannot substitute foreground for background color: " + colorSubstitution);
                                } else {
                                    var src_foregroundColor = sourceColor.slice(1);
                                    var dst_foregroundColor = destinationColor.slice(1);
                                    if (originalCharacterColor == src_foregroundColor) {
                                        return dst_foregroundColor;
                                    }
                                }
                            }
                        } else if (sourceColor[0] == "B") {
                            if (!isForegroundColor) {
                                if (destinationColor[0] != "B") {
                                    console.log("Invalid color substitution, cannot substitute background for foreground color: " + colorSubstitution);
                                } else {
                                    var src_backgroundColor = sourceColor.slice(1);
                                    var dst_backgroundColor = destinationColor.slice(1);
                                    if (originalCharacterColor == src_backgroundColor) {
                                        return dst_backgroundColor;
                                    }
                                }
                            }
                        } else {
                            if (destinationColor[0] == "F") {
                                console.log("Invalid color substitution, cannot substitute foreground for both color: " + colorSubstitution);
                            } else if (destinationColor[0] == 'B') {
                                console.log("Invalid color substitution, cannot substitute background for both color: " + colorSubstitution);
                            } else {
                                if (originalCharacterColor == sourceColor) {
                                    return destinationColor;
                                }
                            }
                        }
                    }
                }
                return originalCharacterColor;
            }
            
            function Render(canvasContext, minimizeColorDifferencesLinearAlgorithm, minimizeColorDifferencesExponentialAlgorithm, useGraphicsCharactersOnly, colorSubstitutions) {
                var charsWide = WIDTH  / CWIDTH;
                var charsHigh = HEIGHT / CHEIGHT;
                
                var charCount = charsWide * charsHigh;
                
                var characterIndex = 0;
                for(var y=0;y<charsHigh;y++) {
                    for(var x=0;x<charsWide;x++) {
                        var imageBuf  = GetCharacterSizedPartOfSourceImage(characterIndex);
                        var matchValues = FindMatch(imageBuf, minimizeColorDifferencesLinearAlgorithm, minimizeColorDifferencesExponentialAlgorithm, useGraphicsCharactersOnly);

                        var characterForegroundColor = GetC64ColorCode(C64_SELECTED_FOREGROUND_RGB_COLORS[matchValues.selectedForegroundColorIndex]);
                        c64CharacterForegroundColors[characterIndex] = characterForegroundColor;

                        var characterBackgroundColor = GetC64ColorCode(C64_SELECTED_BACKGROUND_RGB_COLORS[matchValues.selectedBackgroundColorIndex]);
                        c64CharacterBackgroundColors[characterIndex] = characterBackgroundColor;

                        var characterSetOffset = matchValues.selectedBackgroundColorIndex*C64_SELECTED_FOREGROUND_RGB_COLORS.length*CHARACTERS + matchValues.selectedForegroundColorIndex*CHARACTERS;
                        var petsciiCharacterCode = matchValues.characterOffset - characterSetOffset;

                        canvasContext.drawImage(characterCanvas[matchValues.characterOffset], x*CWIDTH, y*CHEIGHT);
                        petsciiCharacterCodes[characterIndex] = petsciiCharacterCode;
                        characterIndex++;
                    }
                }
            }
            
            function GetCharacterSizedPartOfSourceImage(characterIndex) {
                var charsWide = (WIDTH  / CWIDTH); // 320 / 8 = 40
                
                var bytesPerRastRow = CWIDTH  * charsWide; // 8 * 40 = 320
                var bytesPerCharRow = CHEIGHT * bytesPerRastRow; // 8 * 320 = 2560
                
                var startByte = 0;
                while(characterIndex > charsWide) {
                    startByte += bytesPerCharRow;
                    characterIndex -= charsWide;
                }
                
                while(characterIndex) {
                    startByte += CWIDTH;
                    characterIndex--;
                }
                
                var charBuf = [];
                for(var y=0;y<CHEIGHT;y++) {
                    for(var x=0;x<CWIDTH;x++) {
                        charBuf.push(srcdata[startByte+x]);
                    }
                    startByte += bytesPerRastRow;
                }
                
                return charBuf;
            }
            
            function FindMatch(imageBuf, minimizeColorDifferencesLinearAlgorithm, minimizeColorDifferencesExponentialAlgorithm, useGraphicsCharactersOnly) {
                var maximumDifference = (CWIDTH * CHEIGHT);
                if (minimizeColorDifferencesLinearAlgorithm) {
                    maximumDifference *= 3*255;
                } else if (minimizeColorDifferencesExponentialAlgorithm) {
                    maximumDifference *= 3*(255**2);
                }
                maximumDifference++;
                var smallestDifference = maximumDifference;
                var bestMatch = {characterOffset: 0, selectedForegroundColorIndex: 0, selectedBackgroundColorIndex: 0};
                
                // check the current character against all available colors for the best match.
                for(var i=0; i<CHARACTERS*C64_SELECTED_FOREGROUND_RGB_COLORS.length*C64_SELECTED_BACKGROUND_RGB_COLORS.length; i++) {
                    if ( (!useGraphicsCharactersOnly) || ((i%128) >= 64) ) {
                        var currentDifference = Diff(imageBuf, chardata[i], minimizeColorDifferencesLinearAlgorithm, minimizeColorDifferencesExponentialAlgorithm);
                        if(currentDifference < smallestDifference) {
                            bestMatch.characterOffset = i;
                            bestMatch.selectedBackgroundColorIndex = Math.floor(i/(CHARACTERS*C64_SELECTED_FOREGROUND_RGB_COLORS.length));
                            bestMatch.selectedForegroundColorIndex = Math.floor((i%(CHARACTERS*C64_SELECTED_FOREGROUND_RGB_COLORS.length))/CHARACTERS);
                            smallestDifference = currentDifference;
                            if(currentDifference == 0) {
                                break; //Perfect Match.
                            }
                        }
                    }
                }
                
                return bestMatch;
            }
            
            function Diff(bufa, bufb, minimizeColorDifferencesLinearAlgorithm, minimizeColorDifferencesExponentialAlgorithm) {
                var difference = 0;
                for(var i=0; i<bufa.length; i++) {
                    if (minimizeColorDifferencesLinearAlgorithm) {
                            difference += Math.abs(bufa[i][0] - bufb[i][0]) + Math.abs(bufa[i][1] - bufb[i][1]) + Math.abs(bufa[i][2] - bufb[i][2]);
                    } else if (minimizeColorDifferencesExponentialAlgorithm) {
                        difference += (bufa[i][0] - bufb[i][0])**2 + (bufa[i][1] - bufb[i][1])**2 + (bufa[i][2] - bufb[i][2])**2;
                    } else { //matchExactColorAlgorithm
                        if ( (bufa[i][0] != bufb[i][0]) || (bufa[i][1] != bufb[i][1]) || (bufa[i][2] != bufb[i][2]) ) {
                            difference++;
                        }
                    }
                }
                return difference;
            }
        </script>

        <h2><center>C64 PETSCII Art Generator v7</center></h2>

        <center>Originally written by Gregory Nacu, <a href="https://c64os.com">C64OS.com</a></center></b>
        <center>Enhancements by Warren Wilbur</center>

        <h3>1. Select any image or project file in the 'Sample Images' directory</h3>

        <small><i>Loading local source image and character set image files requires support for cross origin file loading. To do this:
        <small>
        <small>
        <ul>
            <li>On Windows: Start Chrome from the command prompt using "C:\Program Files (x86)\Google\Chrome\Application\chrome.exe" --allow-file-access-from-files file:///D:/petsciirender/petscii_converter.html</li>
            <li>On Mac OSX: Start Safari, in menu select Safari / Settings / Advanced and click to select 'Show features for web developers', then change to the Developers tab and click to select 'Security: Disable local file restrictions'.</li>
            <li>Any OS: Start Firefox, type about:config in the browsers address bar, then enter security.fileuri.strict_origin_policy as the Search preference name, finally toggle the setting to false.</li>
        </ul>
        </small>
        </small>
        </small></i>
        <input type="file" class="button" value='Sample Images/s_classic.png' id="loadFileName_file" />
        <input type="button" class="button" value='Load File' id='loadFile_button'>
        <br>

        <h3>Original Image</h3>
        <img src='Sample Images/s_classic.png' id='sourceImage' style='width:320px;height:200px;'>

        <h3>2. Choose colors and click to Render Character Sets</h3>

        <h5>2.1. Choose VIC-II character graphics mode</h3>

        <input type="checkbox" id="vic2StandardMode_checkbox" checked class="checkbox" />
        <label for="colorBlack_checkbox">Standard Character Mode (256 characters, 16 foreground colors, 1 background color)</label>
        <br>
        <input type="checkbox" id="vic2ExtendedMode_checkbox" class="checkbox" />
        <label for="colorBlack_checkbox">Extended (Background) Color Mode (64 characters, 16 foreground colors, 4 background colors)</label>
        <br>
        <br>
        Color presets:
        <input type="button" class="button" id="colorPresetBlackAndWhite_button" class="styled" value="Black/White"/>
        <input type="button" class="button" id="colorPresetGreyscale_button" class="styled" value="Greyscales"/>
        <input type="button" class="button" id="colorPresetBlues_button" class="styled" value="Blues"/>
        <input type="button" class="button" id="colorPresetBrowns_button" class="styled" value="Browns"/>
        <input type="button" class="button" id="colorPresetReds_button" class="styled" value="Reds"/>
        <input type="button" class="button" id="colorPresetGreens_button" class="styled" value="Greens"/>

        <h5>2.2. Choose character set foreground colors</h3>

        <input type="checkbox" id="colorBlack_checkbox" checked class="checkbox" />
        <label for="colorBlack_checkbox">Black(0)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorWhite_checkbox" checked class="checkbox" />
        <label for="colorWhite_checkbox">White(1)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorRed_checkbox" checked class="checkbox" />
        <label for="colorRed_checkbox">Red(2)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorCyan_checkbox" checked class="checkbox" />
        <label for="colorCyan_checkbox">Cyan(3)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorPurple_checkbox" checked class="checkbox" />
        <label for="colorPurple_checkbox">Purple(4)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorGreen_checkbox" checked class="checkbox" />
        <label for="colorGreen_checkbox">Green(5)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorBlue_checkbox" checked class="checkbox" />
        <label for="colorBlue_checkbox">Blue(6)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorYellow_checkbox" checked class="checkbox" />
        <label for="colorYellow_checkbox">Yellow(7)</label>&nbsp;&nbsp;&nbsp;<br>
        <input type="checkbox" id="colorOrange_checkbox" checked class="checkbox" />
        <label for="colorOrange_checkbox">Orange(8)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorBrown_checkbox" checked class="checkbox" />
        <label for="colorBrown_checkbox">Brown(9)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorLightRed_checkbox" checked class="checkbox" />
        <label for="colorLightRed_checkbox">Light Red(10)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorDarkGrey_checkbox" checked class="checkbox" />
        <label for="colorDarkGrey_checkbox">Dark Grey(11)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorGrey_checkbox" checked class="checkbox" />
        <label for="colorGrey_checkbox">Grey(12)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorLightGreen_checkbox" checked class="checkbox" />
        <label for="colorLightGreen_checkbox">Light Green(13)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorLightBlue_checkbox" checked class="checkbox" />
        <label for="colorLightBlue_checkbox">Light Blue(14)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorLightGrey_checkbox" checked class="checkbox" />
        <label for="colorLightGrey_checkbox">Light Grey(15)</label>&nbsp;&nbsp;&nbsp;

        <h5>2.3. Choose character set background color(s)</h3>
        <label for="backgroundColor1_number">Background color1 (between 0 and 15):</label>&nbsp;&nbsp;&nbsp;
        <input type="number" id="backgroundColor1_number" value="0" name="backgroundColor1_number" min="0" max="15">
        <br>
        <label for="backgroundColor2_number">Background color2 (between 0 and 15):</label>&nbsp;&nbsp;&nbsp;
        <input type="number" id="backgroundColor2_number" value="0" name="backgroundColor2_number" disabled min="0" max="15">
        <br>
        <label for="backgroundColor3_number">Background color3 (between 0 and 15):</label>&nbsp;&nbsp;&nbsp;
        <input type="number" id="backgroundColor3_number" value="0" name="backgroundColor3_number" disabled min="0" max="15">
        <br>
        <label for="backgroundColor4_number">Background color4 (between 0 and 15):</label>&nbsp;&nbsp;&nbsp;
        <input type="number" id="backgroundColor4_number" value="0" name="backgroundColor4_number" disabled min="0" max="15">
        <br>
        <p><small>When creating a multi-color PETSCII rendering the single most important choice that determines the quality of your output is the
        background color. Try several colors and aim to use the color which has the most (color) transitions (i.e. borders with other colors) in the
        image. Your best case (in Standard Character Mode) will occur when a single background color has all the color transitions in the image.</small></p>

        <h5>2.4. Choose your character set</h3>

        <h6>2.4.1. Standard Character Mode</h6>

        <input type="checkbox" id="characterSetUpper256_checkbox" checked class="checkbox" />
        <label for="characterSetUpper256_checkbox">C64 US upper case standard (256 characters)</label>&nbsp;&nbsp;&nbsp;
        <br>
        <input type="checkbox" id="characterSetUpperLower256_checkbox" class="checkbox" />
        <label for="characterSetUpperLower256_checkbox">C64 US lower case standard (256 characters)</label>&nbsp;&nbsp;&nbsp;

        <h6>2.4.2. Extended (Background) Color Mode</h6>

        <input type="checkbox" id="characterSetExtendedGraphic64_checkbox" disabled class="checkbox" />
        <label for="characterSetExtendedGraphic64_checkbox">C64 US upper case extended graphic (64 characters, numbers 64-127 of the standard upper case set)</label>&nbsp;&nbsp;&nbsp;
        <br>
        <input type="checkbox" id="characterSetExtendedAlphaNum64_checkbox" disabled class="checkbox" />
        <label for="characterSetExtendedAlphaNum64_checkbox">C64 US upper case extended alpha-numeric (64 characters, numbers 0-63 of the standard upper case set)</label>&nbsp;&nbsp;&nbsp;

        <h6>2.4.3. Custom Settings (use breakout-charset.py to prepare your own custom character sets)</h6>
        <input type="checkbox" id="characterSetCustom_checkbox" class="checkbox" />
        <label for="characterSetCustom_checkbox">Custom</label>
        <br>
        <label for="characterSetDirectory_text">Enter the directory containing your character set</label>
        <input type="text" value="standard256-upper" id="characterSetDirectory_text" disabled />
        <br>
        <label for="characterSetSize_number">Enter the number of characters in your character set</label>
        <input type="number" id="characterSetSize_number" value="256" min="1" max="256" disabled />
        <br>
        <br>
        <input type="checkbox" id="formatCharacterSets_checkbox" class="checkbox" />
        <label for="colorLightGrey_checkbox">Format rendering of character sets into 32 characters per row</label>
        <br>
        <br>
        <input type="button" class="button" value='Render Character Sets' id='renderCharacterSets_button'>

        <h3>Character Sets for PETSCII Rendering</h3>
        <div id='charsetContainer'></div>
        <img src='' id='character' style='display:none;'>

        <h3>3. Make image adjustments and click to Render Working Image</h3>

        <h5>3.1. Select algorithm for rendering the PETSCII image</h5>
        <input type="checkbox" id="matchExactColorAlgorithm_checkbox" class="checkbox" />
        <label for="matchExactColorAlgorithm_checkbox">Use 'match exact color' algorithm</label>&nbsp;&nbsp;&nbsp;

        <input type="checkbox" id="minimizeColorDifferencesLinearAlgorithm_checkbox" class="checkbox" />
        <label for="minimizeColorDifferencesLinearAlgorithm_checkbox">Use 'minimize absolute color differences (linear)' algorithm</label>&nbsp;&nbsp;&nbsp;

        <input type="checkbox" id="minimizeColorDifferencesExponentialAlgorithm_checkbox" checked class="checkbox" />
        <label for="minimizeColorDifferencesExponentialAlgorithm_checkbox">Use 'minimize absolute color differences (exponential)' algorithm</label>

        <h5>3.2. Select working image adjustments to enhance output</h5>
        <input type="checkbox" id="blackAndWhiteDither_checkbox" class="checkbox" />
        <label for="blackAndWhiteDither_checkbox">Dither to a two-color image (black/white)</label>&nbsp;&nbsp;&nbsp;

        <input type="checkbox" id="greyscaleConversion_checkbox" class="checkbox" />
        <label for="greyscaleConversion_checkbox">Convert to greyscale image</label>&nbsp;&nbsp;&nbsp;

        <input type="checkbox" id="selectedColorDither_checkbox" class="checkbox" />
        <label for="selectedColorDither_checkbox">Dither to the selected colors for image</label>&nbsp;&nbsp;&nbsp;

        <input type="checkbox" id="propogateDitheringError_checkbox" class="checkbox" />
        <label for="propogateDitheringError_checkbox">Propogate dithering error to neighboring pixels (reduces contrast)</label>&nbsp;&nbsp;&nbsp;

        <input type="checkbox" id="imageNegative_checkbox" name="imageNegative_checkbox" />
        <label id="imageNegative_label" for="imageNegative_checkbox">Image negative</label>
        <br>
        <br>
        <label id="imageContrast_label" for="imageContrast_number">Image Contrast (-100..200 percent):</label><br>
        <input type="range" id="imageContrast_range" name="imageContrast_range" min="-100" max="200" value="0" style="width:80%" />
        <input type="number" id="imageContrast_number" name="imageContrast_number" min="-100" max="200" value="0" style="width:60px" />
        <br>
        <label id="imageBrightness_label" for="imageBrightness_number">Image Brightness (-100..400 percent):</label><br>
        <input type="range" id="imageBrightness_range" name="imageBrightness_range" min="-100" max="400" value="0" style="width:80%" />
        <input type="number" id="imageBrightness_number" name="imageBrightness_number" min="-100" max="400" value="0" style="width:60px" />
        <br>
        <input type="button" class="button" value='Render Working Image' id='renderWorkingImage_button'>
        <br>
        <br>
        Working Image<br>
        <canvas width=320 height=200 style='width:320px;height:200px;' id='workingImageCanvas'></canvas>

        <h3>4. Click to render PETSCII image</h3>
        <input type="checkbox" id="useGraphicsCharactersOnly_checkbox" class="checkbox" />
        <label for="useGraphicsCharactersOnly_checkbox">Only use graphics characters (from the C64 upper case character set)</label>&nbsp;&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="lockImage_checkbox" class="checkbox" />
        <label for="lockImage_checkbox">Auto-rendering (automatically update when working image changes)</label>&nbsp;&nbsp;&nbsp;
        <br>
        <label for="colorSubstitutions_text">Enter color substitutions for output (to substitute foreground color 2 for foreground color 1 use F1=F2, to substitute background color 2 for background color 1 use B1=B2, to substitute foreground and background color 2 for foreground and background color 1 use 1=2, separate entries should be separated by a spaces, e.g. 1=2 F1=F2 B1=B2). Substitutions will only appear in saved output files.</label>
        <input type="text" value="" id="colorSubstitutions_text" />
        <br>
        <input type="button" class="button" value="Render PETSCII" id="renderPetscii_button">
        <br>
        <br>
        PETSCII Rendered Image<br>
        <canvas width=320 height=200 style='width:320px;height:200px;' id='canvas'></canvas>

        <h3>5. Enter filename and click to save PETSCII mosaic to file</h3>
        <input type="checkbox" id="projectJsonOutput_checkbox" class="checkbox" />
        <label for="projectJsonOutput_checkbox">Save as (text) .project output format (to save project settings)</label>&nbsp;&nbsp;&nbsp;
        <br>
        <input type="checkbox" id="binaryCharactersOnlyOutput_checkbox" class="checkbox" />
        <label for="binaryCharactersOnlyOutput_checkbox">Save as (binary) stream of 1000 PETSCII character codes</label>&nbsp;&nbsp;&nbsp;
        <br>
        <input type="checkbox" id="binaryCharactersAndColorsOutput_checkbox" class="checkbox" />
        <label for="binaryCharactersAndColorsOutput_checkbox">Save as (binary) stream of 1000 PETSCII character codes followed by 1000 character foreground color codes (for import into C64 Studio)</label>&nbsp;&nbsp;&nbsp;
        <br>
        <input type="checkbox" id="cLanguageTextOutput_checkbox" checked class="checkbox" />
        <label for="cLanguageTextOutput_checkbox">Save as (text) .c output format (for import into Marq's PETSCII editor, not compatible when custom character set or Extended Background Color Mode are selected)</label>&nbsp;&nbsp;&nbsp;
        <br>
        <input type="checkbox" id="asmLanguageTextOutput_checkbox" class="checkbox" />
        <label for="asmLanguageTextOutput_checkbox">Save as (text) .asm output format (for import into C64 Studio)</label>&nbsp;&nbsp;&nbsp;
        <br>
        <input type="checkbox" id="c64OsOutput_checkbox" class="checkbox" />
        <label for="c64OsOutput_checkbox">Save as (binary) stream in C64OS output format</label>&nbsp;&nbsp;&nbsp;
        <br>
        File Header Fields (C64OS format only):<br>
        <label for="c64OsOutputTitle_text">Enter title (16 chars)</label>
        <input type="text" id="c64OsOutputTitle_text" value="UNKNOWN" maxlength="16" disabled />
        <br>
        <label for="c64OsOutputArtist_text">Enter artist name (16 chars)</label>
        <input type="text" id="c64OsOutputArtist_text" value="ANONYMOUS" maxlength="16" disabled />
        <br>
        <label for="c64OsOutputCopyright_text">Copyright string (16 chars)</label>
        <input type="text" id="c64OsOutputCopyright_text" value="NOT SPECIFIED" maxlength="16" disabled />
        <br>
        <br>
        <input type="text" value="petsciiart.c" id="saveFileName">
        <input type="button" class="button" value="Save File" id="saveFile_button">
        <br>
        <br>
    </body>
</html>

