<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>
            C64 PETSCII Art Generator v5
        </title>
        <style type='text/css'>
        
        </style>
    </head>
    <body onload='Init();'>
        <script type='text/javascript'>
            // v1: Originally written by Gregory Nacu.
            //     Add black/white support, dithering, and color matching algorithm.
            //     Visit http://c64os.com and https://c64os.com/post/petsciiartrenderer
            //     for more information.
            //
            // v2: Enhancement by Warren Wilbur.
            //     Add grayscale working image support (when dithering is disabled) and
            //     render using addition of absolute color differences (better results
            //     for photographic source images).
            //
            // v3: Enhancement by Warren Wilbur.
            //     Add grayscale (multiple color support) and render character sets
            //     (in each selected color) to support grayscale PETSCII output.
            //     Cleanup interface to support incremental processing (top-to-bottom).
            //     Add contrast and brightness adjustment.
            //
            // v4: Enhancement by Warren Wilbur.
            //     Add support for all sixteen C64 colors. Add support for changing
            //     background color.
            //
            // v5: Enhancement by Warren Wilbur.
            //     Add color negative support. Add shortcut buttons for black/white,
            //     grayscale, blues, greens, browns, and reds color sets. Add support
            //     for custom character sets. Add support for C64 extended (background)
            //     color mode (implement multiple background color register values for
            //     VIC-II and color ram, to accurately represent the color limitations
            //     of the VIC-II standard and extended modes). Add C64 US upper-case
            //     character set. Add C64OS output format.
            //
            var CHARACTERS = 256;
            var WIDTH      = 320;
            var HEIGHT     = 200;
            var CWIDTH     = 8;
            var CHEIGHT    = 8;

            var C64_COLOR_CODE_BLACK =       0;
            var C64_COLOR_CODE_WHITE =       1;
            var C64_COLOR_CODE_RED =         2;
            var C64_COLOR_CODE_CYAN =        3;
            var C64_COLOR_CODE_PURPLE =      4;
            var C64_COLOR_CODE_GREEN =       5;
            var C64_COLOR_CODE_BLUE =        6;
            var C64_COLOR_CODE_YELLOW =      7;
            var C64_COLOR_CODE_ORANGE =      8;
            var C64_COLOR_CODE_BROWN =       9;
            var C64_COLOR_CODE_LIGHTRED =   10;
            var C64_COLOR_CODE_DARKGREY =   11;
            var C64_COLOR_CODE_GREY =       12;
            var C64_COLOR_CODE_LIGHTGREEN = 13;
            var C64_COLOR_CODE_LIGHTBLUE =  14;
            var C64_COLOR_CODE_LIGHTGREY =  15;

            // refer to https://www.c64-wiki.com/wiki/Color
            var C64_RGB_COLOR_BLACK =      [  0,  0,  0];
            var C64_RGB_COLOR_WHITE =      [255,255,255];
            var C64_RGB_COLOR_RED =        [136,  0,  0];
            var C64_RGB_COLOR_CYAN =       [170,255,238];
            var C64_RGB_COLOR_PURPLE =     [204, 68,204];
            var C64_RGB_COLOR_GREEN =      [  0,204, 85];
            var C64_RGB_COLOR_BLUE =       [  0,  0,170];
            var C64_RGB_COLOR_YELLOW =     [238,238,119];
            var C64_RGB_COLOR_ORANGE =     [221,136, 85];
            var C64_RGB_COLOR_BROWN =      [102, 68,  0];
            var C64_RGB_COLOR_LIGHTRED =   [255,119,119];
            var C64_RGB_COLOR_DARKGREY =   [ 51, 51, 51];
            var C64_RGB_COLOR_GREY =       [119,119,119];
            var C64_RGB_COLOR_LIGHTGREEN = [170,255,102];
            var C64_RGB_COLOR_LIGHTBLUE =  [  0,136,255];
            var C64_RGB_COLOR_LIGHTGREY =  [187,187,187];

            var C64_SELECTED_FOREGROUND_RGB_COLORS = [];
            var C64_SELECTED_BACKGROUND_RGB_COLORS = [];
 
            var contrast = 0;
            var brightness = 0;
            
            // compares each color component of RGB color and returns TRUE on match, FALSE otherwise.
            function MatchRgbColors(rgbColor1, rgbColor2) {
                match = false;
                if ( (rgbColor1[0] == rgbColor2[0]) &&
                     (rgbColor1[1] == rgbColor2[1]) &&
                     (rgbColor1[2] == rgbColor2[2]) ) {
                    match = true;
                }
                return match;
            }

            // find specified RGB color in C64_SELECTED_RGB_COLORS array and return it's index, return undefined if not found.
            function FindIndexOfSelectedColor(rgbColor, C64_SELECTED_RGB_COLORS) {
                var colorIndex = -1;
                for (var i=0; i<C64_SELECTED_RGB_COLORS.length; i++) {
                    if (MatchRgbColors(C64_SELECTED_RGB_COLORS[i], rgbColor)) {
                        colorIndex = i;
                        break;
                    }
                }
                return colorIndex;
            }

            // Find matching C64 RGB color and return VIC-II (C64) color code, undefined if no match
            function GetC64ColorCode(rgbColor) {
                var colorCode = undefined;
                if (MatchRgbColors(rgbColor, C64_RGB_COLOR_BLACK)) {
                    colorCode = C64_COLOR_CODE_BLACK;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_WHITE)) {
                    colorCode = C64_COLOR_CODE_WHITE;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_RED)) {
                    colorCode = C64_COLOR_CODE_RED;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_CYAN)) {
                    colorCode = C64_COLOR_CODE_CYAN;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_PURPLE)) {
                    colorCode = C64_COLOR_CODE_PURPLE;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_GREEN)) {
                    colorCode = C64_COLOR_CODE_GREEN;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_BLUE)) {
                    colorCode = C64_COLOR_CODE_BLUE;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_YELLOW)) {
                    colorCode = C64_COLOR_CODE_YELLOW;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_ORANGE)) {
                    colorCode = C64_COLOR_CODE_ORANGE;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_BROWN)) {
                    colorCode = C64_COLOR_CODE_BROWN;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_LIGHTRED)) {
                    colorCode = C64_COLOR_CODE_LIGHTRED;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_DARKGREY)) {
                    colorCode = C64_COLOR_CODE_DARKGREY;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_GREY)) {
                    colorCode = C64_COLOR_CODE_GREY;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_LIGHTGREEN)) {
                    colorCode = C64_COLOR_CODE_LIGHTGREEN;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_LIGHTBLUE)) {
                    colorCode = C64_COLOR_CODE_LIGHTBLUE;
                } else if (MatchRgbColors(rgbColor, C64_RGB_COLOR_LIGHTGREY)) {
                    colorCode = C64_COLOR_CODE_LIGHTGREY;
                }
                return colorCode;
            }

            // Find matching C64 color code and return matching RGB color ([r, g, b]), undefined if no match
            function GetRgbColor(c64ColorCode) {
                var rgbColor = undefined;
                switch (c64ColorCode) {
                    case C64_COLOR_CODE_BLACK:
                        rgbColor = C64_RGB_COLOR_BLACK;
                        break;
                    case C64_COLOR_CODE_WHITE:
                        rgbColor = C64_RGB_COLOR_WHITE;
                        break;
                    case C64_COLOR_CODE_RED:
                        rgbColor = C64_RGB_COLOR_RED;
                        break;
                    case C64_COLOR_CODE_CYAN:
                        rgbColor = C64_RGB_COLOR_CYAN;
                        break;
                    case C64_COLOR_CODE_PURPLE:
                        rgbColor = C64_RGB_COLOR_PURPLE;
                        break;
                    case C64_COLOR_CODE_GREEN:
                        rgbColor = C64_RGB_COLOR_GREEN;
                        break;
                    case C64_COLOR_CODE_BLUE:
                        rgbColor = C64_RGB_COLOR_BLUE;
                        break;
                    case C64_COLOR_CODE_YELLOW:
                        rgbColor = C64_RGB_COLOR_YELLOW;
                        break;
                    case C64_COLOR_CODE_ORANGE:
                        rgbColor = C64_RGB_COLOR_ORANGE;
                        break;
                    case C64_COLOR_CODE_BROWN:
                        rgbColor = C64_RGB_COLOR_BROWN;
                        break;
                    case C64_COLOR_CODE_LIGHTRED:
                        rgbColor = C64_RGB_COLOR_LIGHTRED;
                        break;
                    case C64_COLOR_CODE_DARKGREY:
                        rgbColor = C64_RGB_COLOR_DARKGREY;
                        break;
                    case C64_COLOR_CODE_GREY:
                        rgbColor = C64_RGB_COLOR_GREY;
                        break;
                    case C64_COLOR_CODE_LIGHTGREEN:
                        rgbColor = C64_RGB_COLOR_LIGHTGREEN;
                        break;
                    case C64_COLOR_CODE_LIGHTBLUE:
                        rgbColor = C64_RGB_COLOR_LIGHTBLUE;
                        break;
                    case C64_COLOR_CODE_LIGHTGREY:
                        rgbColor = C64_RGB_COLOR_LIGHTGREY;
                        break;
                }
                return rgbColor;
            }

            var chardata = [];
            var srcdata  = [];
            var petsciiCharacterCodes        = new Uint8Array((WIDTH/CWIDTH) * (HEIGHT/CHEIGHT));
            var c64CharacterForegroundColors = new Uint8Array((WIDTH/CWIDTH) * (HEIGHT/CHEIGHT));
            var c64CharacterBackgroundColors = new Uint8Array((WIDTH/CWIDTH) * (HEIGHT/CHEIGHT));
            var c64CustomCharacterSetBytes   = new Uint8Array(CHARACTERS*8);
            
            var characterContainer;
            var characterCanvas = [];

            // format number between 0-255 into a three column string (padding with leading zeros as necessary, i.e. 1 -> 001)
            function FormatNumberStr(colorCode) {
                var colorCodeStr = colorCode.toString();
                while (colorCodeStr.length < 3) {
                    colorCodeStr = "0" + colorCodeStr;
                }
                return colorCodeStr;
            }

            function GetUint8Array(inputArray) {
                var outputArray = new Uint8Array(inputArray.length);
                for (var i=0; i<inputArray.length; i++) {
                    outputArray[i] = inputArray[i];
                }
                return outputArray;
            }

            // convert A-Z and 0-9 into array of hex PETSCII character codes
            function ConvertAsciiStrToPetsciiBytes(asciiStr) {
                var petsciiBytes = [];
                var upperCaseAsciiStr = asciiStr.toUpperCase();
                for (var i=0; i<upperCaseAsciiStr.length; i++) {
                    var asciiCode = upperCaseAsciiStr.charCodeAt(i);
                    var petsciiCode = undefined;
                    if ( (asciiCode >= 65) && (asciiCode <= 90) ) {
                        petsciiCode = asciiCode - 65 + 1; // ASCII 'A' = 65, PETSCII 'A' (or 'a') = 01
                    } else if ( (asciiCode >= 48) && (asciiCode <= 57) ) {
                        // ASCII '0' = 48, PETSCII '0' = 48. Do nothing for 0-9
                        petsciiCode = asciiCode;
                    } else {
                        console.log("no match - replace with ' '. char:" + upperCaseAsciiStr.charAt(i) + " ascii:" + upperCaseAsciiStr.charCodeAt(i));
                        petsciiCode = 32; // replace anything not in A-Z0-9 with blank
                    }
                    petsciiBytes.push(petsciiCode);
                }
                return petsciiBytes;
            }

            function PadBytes(inputBytes, maximumLength) {
                while (inputBytes.length < maximumLength) {
                    inputBytes.push(0);
                }
                return inputBytes;
            }

            // convert to PETSCII, truncate to maximumLength, terminate with 0x00, pad with 0x00;
            function PrepareTextField(asciiStr, maximumLength)
            {
                var petsciiBytes = ConvertAsciiStrToPetsciiBytes(asciiStr);
                petsciiBytes = PadBytes(petsciiBytes, maximumLength);
                if (petsciiBytes.length > maximumLength) {
                    petsciiBytes = petsciiBytes.slice(0, maximumLength-1);
                }
                petsciiBytes[maximumLength-1] = 0x00;
                return petsciiBytes;
            }

			var SaveByteArray = (function () {
                var a = document.createElement("a");
                document.body.appendChild(a);
                a.style = "display: none";
                
                return function (characterCodes, characterForegroundColors, characterBackgroundColors, inputFileName, outputFileName, compatibleOutputEnabled, c64OsOutputEnabled) {
                    // original output format by default
                    var blob = new Blob([characterCodes], {type: "application/octet-stream"});
                    if (compatibleOutputEnabled) {
                        var bufStr =      "// generated by petscii_converter.html\n" +
                                          "//    imagefile: " + inputFileName + "\n" +
                                          "//     contrast: " + contrast + "\n" +
                                          "//   brightness: " + brightness + "\n";

                        var vic2ExtendedMode_switch = document.getElementById('vic2ExtendedMode_switch');
                        var vic2ExtendedMode_enabled = vic2ExtendedMode_switch.checked ? true:false;
                        if (vic2ExtendedMode_enabled) {
                            bufStr = bufStr + "unsigned char frame0000[]={// 1 byte border color, 1 byte background color1, 1 byte background color2, 1 byte background color3, " +
                                              "1 byte background color4, 1000 bytes PETSCII character codes (bits 7-8 background color), 1000 bytes character colors\n" +
                                              FormatNumberStr(C64_SELECTED_BACKGROUND_RGB_COLORS[0]) + "," + FormatNumberStr(C64_SELECTED_BACKGROUND_RGB_COLORS[0]) + "," +
                                              FormatNumberStr(C64_SELECTED_BACKGROUND_RGB_COLORS[1]) + "," + FormatNumberStr(C64_SELECTED_BACKGROUND_RGB_COLORS[2]) + "," +
                                              FormatNumberStr(C64_SELECTED_BACKGROUND_RGB_COLORS[3]) + ",\n";
                        } else {
                            bufStr = bufStr + "unsigned char frame0000[]={// 1 byte border color, 1 byte background color, 1000 bytes PETSCII character codes, 1000 bytes character colors\n" +
                                              FormatNumberStr(C64_SELECTED_BACKGROUND_RGB_COLORS[0]) + "," + FormatNumberStr(C64_SELECTED_BACKGROUND_RGB_COLORS[0]) + ",\n";
                        }

                        for (var i=0;i<characterCodes.length;i++) {
                            characterCode = characterCodes[i];
                            if (vic2ExtendedMode_enabled) {
                                backgroundColorIndex = FindIndexOfSelectedColor(characterBackgroundColors[i], C64_SELECTED_BACKGROUND_RGB_COLORS);
                                switch (backgroundColorIndex) {
                                    case 0:
                                        characterCode = (characterCode & 0b00111111) | 0b00000000;
                                        break;
                                    case 1:
                                        characterCode = (characterCode & 0b00111111) | 0b01000000;
                                        break;
                                    case 2:
                                        characterCode = (characterCode & 0b00111111) | 0b10000000;
                                        break;
                                    case 3:
                                        characterCode = (characterCode & 0b00111111) | 0b11000000;
                                        break;
                                }
                            }
                            bufStr = bufStr + FormatNumberStr(characterCode) + ",";
                            if ((i+1) % (WIDTH/CWIDTH) == 0) {
                                bufStr = bufStr + "\n";
                            }
                        }

                        for (var i=0; i<characterForegroundColors.length; i++) {
                            bufStr = bufStr + FormatNumberStr(characterForegroundColors[i]) + ",";
                            if ((i+1) % (WIDTH/CWIDTH) == 0) {
                                bufStr = bufStr + "\n";
                            }
                        }

                        bufStr = bufStr + "};\n";
                        bufStr = bufStr + "// META: 40 25 C64 upper";
                        blob = new Blob([bufStr], {type: "text/plain"});
                    } else if (c64OsOutputEnabled) {
                        var characterSetUpper256_switch = document.getElementById('characterSetUpper256_switch');
                        var characterSetUpper256_switch_enabled = characterSetUpper256_switch.checked;
                        var characterSetUpperLower256_switch = document.getElementById('characterSetUpperLower256_switch');
                        var characterSetUpperLower256_switch_enabled = characterSetUpperLower256_switch.checked;
                        var characterSetCustom_switch = document.getElementById('characterSetCustom_switch');
                        var characterSetCustom_switch_enabled = characterSetCustom_switch.checked;

                        var c64OsOutputTitle_text = document.getElementById('c64OsOutputTitle_text');
                        var title_value = c64OsOutputTitle_text.value;
                        if (title_value == undefined) {
                            title_value = "";
                        }
                        var c64OsOutputArtist_text = document.getElementById('c64OsOutputArtist_text');
                        var artist_value = c64OsOutputArtist_text.value;
                        if (artist_value == undefined) {
                            artist_value = "";
                        }
                        var c64OsOutputCopyright_text = document.getElementById('c64OsOutputCopyright_text');
                        var copyright_value = c64OsOutputCopyright_text.value;
                        if (copyright_value == undefined) {
                            copyright_value = "";
                        }

                        var saveFields = [];
                        if (characterSetUpper256_switch_enabled) {
                            //refer to https://c64os.com/post/imageformats
                            //
                            // Version 0 implies the Uppercase/Graphics character set (from the standard C64 Char ROM.)
                            //
                            // The Version 0 Format:
                            //
                            // MAGIC         3 ("PET", $D0 $C5 $D4)
                            // VERSION       1 ("0", $30)
                            // SOURCE       17 (Title,     String in PETSCII, $00 padded and terminated)
                            // AUTHOR       17 (Artist,    String in PETSCII, $00 padded and terminated)
                            // RELEASE      17 (Copyright, String in PETSCII, $00 padded and terminated)
                            // SCREEN     1000 (Screencodes for screen matrix memory, not PETSCII codes.)
                            // COLOR      1000 (VIC-II colorcodes for color memory, not PETSCII codes.)
                            // BORDER        1 (Border color, value stored to VIC+$20)
                            // BACKGRND      1 (Background color, value stored to VIC+$21)

                            saveFields.push(GetUint8Array([0xD0, 0xC5, 0xD4, 0x30]));
                            saveFields.push(GetUint8Array(PrepareTextField(title_value, 17)));
                            saveFields.push(GetUint8Array(PrepareTextField(artist_value, 17)));
                            saveFields.push(GetUint8Array(PrepareTextField(copyright_value, 17)));
                            saveFields.push(characterCodes);
                            saveFields.push(characterForegroundColors);
                            saveFields.push(GetUint8Array([characterBackgroundColors[0]]));
                            saveFields.push(GetUint8Array([characterBackgroundColors[0]]));
                        } else if (characterSetUpperLower256_switch_enabled) {
                            //refer to https://c64os.com/post/imageformats
                            //
                            // Version 1 is identical to Version 0, but implies the Lowercase/Uppercase character set.
                            //
                            // The Version 1 Format:
                            //
                            // MAGIC         3 ("PET", $D0 $C5 $D4)
                            // VERSION       1 ("1", $31)
                            // SOURCE       17 (Title,     String in PETSCII, $00 padded and terminated)
                            // AUTHOR       17 (Artist,    String in PETSCII, $00 padded and terminated)
                            // RELEASE      17 (Copyright, String in PETSCII, $00 padded and terminated)
                            // SCREEN     1000 (Screencodes for screen matrix memory, not PETSCII codes.)
                            // COLOR      1000 (VIC-II colorcodes for color memory, not PETSCII codes.)
                            // BORDER        1 (Border color, value stored to VIC+$20)
                            // BACKGRND      1 (Background color, value stored to VIC+$21)

                            saveFields.push(GetUint8Array([0xD0, 0xC5, 0xD4, 0x31]));
                            saveFields.push(GetUint8Array(PrepareTextField(title_value, 17)));
                            saveFields.push(GetUint8Array(PrepareTextField(artist_value, 17)));
                            saveFields.push(GetUint8Array(PrepareTextField(copyright_value, 17)));
                            saveFields.push(characterCodes);
                            saveFields.push(characterForegroundColors);
                            saveFields.push(GetUint8Array([characterBackgroundColors[0]]));
                            saveFields.push(GetUint8Array([characterBackgroundColors[0]]));
                        } else if (characterSetCustom_switch_enabled) {
                            //refer to https://c64os.com/post/imageformats
                            //
                            // version 2 adds the 2KB character set at the end. The character set is in the same format as a 2KB charset in the ROM. 
                            //
                            // The Version 2 Format:
                            //
                            // MAGIC         3 ("PET", $D0 $C5 $D4)
                            // VERSION       1 ("2", $32)
                            // SOURCE       17 (Title,     String in PETSCII, $00 padded and terminated)
                            // AUTHOR       17 (Artist,    String in PETSCII, $00 padded and terminated)
                            // RELEASE      17 (Copyright, String in PETSCII, $00 padded and terminated)
                            // SCREEN     1000 (Screencodes for screen matrix memory, not PETSCII codes.)
                            // COLOR      1000 (VIC-II colorcodes for color memory, not PETSCII codes.)
                            // BORDER        1 (Border color, value stored to VIC+$20)
                            // BACKGRND      1 (Background color, value stored to VIC+$21)
                            // CHARSET    2048 (2KB character set)

                            saveFields.push(GetUint8Array([0xD0, 0xC5, 0xD4, 0x32]));
                            saveFields.push(GetUint8Array(PrepareTextField(title_value, 17)));
                            saveFields.push(GetUint8Array(PrepareTextField(artist_value, 17)));
                            saveFields.push(GetUint8Array(PrepareTextField(copyright_value, 17)));
                            saveFields.push(characterCodes);
                            saveFields.push(characterForegroundColors);
                            saveFields.push(GetUint8Array([characterBackgroundColors[0]]));
                            saveFields.push(GetUint8Array([characterBackgroundColors[0]]));
                            saveFields.push(c64CustomCharacterSetBytes);
                        }
                        blob = new Blob(saveFields, {type: "application/octet-stream"});
                    }
                    var url  = window.URL.createObjectURL(blob);
                    
                    a.href = url;
                    a.download = outputFileName;
                    a.click();
                    
                    window.URL.revokeObjectURL(url);
                };
			}());
            
            // read the value of the color switch and update the selected colors array accordingly
            function ManageSelectedColorsSwitch(switchId, rgbColor, C64_SELECTED_RGB_COLORS) {
                var color_switch = document.getElementById(switchId);
                var color_enabled = color_switch.checked ? true:false;
                var color_index = FindIndexOfSelectedColor(rgbColor, C64_SELECTED_RGB_COLORS);
                if (color_enabled)
                {
                    if (color_index == -1)
                    {
                        C64_SELECTED_RGB_COLORS.push(rgbColor);
                    }
                }
            }

            // read the value of the color number and update the selected colors array accordingly
            function ManageSelectedColorsNumber(numberId, C64_SELECTED_RGB_COLORS) {
                var color_number = document.getElementById(numberId);
                var colorCode = parseInt(color_number.value);
                var rgbColor = GetRgbColor(colorCode);
                var color_index = FindIndexOfSelectedColor(rgbColor, C64_SELECTED_RGB_COLORS);
                if (color_index == -1)
                {
                    C64_SELECTED_RGB_COLORS.push(rgbColor);
                }
            }

            // Set switch enable status
            function ManageInputEnabled(switchId,enable) {
                var switch_manage = document.getElementById(switchId);
                switch_manage.disabled = enable ? false:true;
            }

            // Set switch checked status
            function ManageSwitchSelected(switchId,select) {
                var switch_manage = document.getElementById(switchId);
                switch_manage.checked = select ? true:false;
            }

            function UpdateOutputFileName()
            {
                var compatibleOutput_switch = document.getElementById('compatibleOutput_switch');
                var compatibleOutputEnabled = compatibleOutput_switch.checked ? true:false;

                var c64OsOutput_switch = document.getElementById('c64OsOutput_switch');
                var c64OsOutputEnabled = c64OsOutput_switch.checked ? true:false;

                var savePetscii_element = document.getElementById('savePetsciiFileName');
                var savePetsciiFileName = savePetscii_element.value;
                if (savePetsciiFileName.length == 0)
                {
                    savePetsciiFileName = document.getElementById('loadImageFileName_file').value;
                }
                if (savePetsciiFileName.length == 0)
                {
                    savePetsciiFileName = "petsciiart";
                }
                if (compatibleOutputEnabled) {
                    savePetscii_element.value = savePetsciiFileName.split('.')[0] + ".c"
                } else if (c64OsOutputEnabled) {
                    savePetscii_element.value = savePetsciiFileName.split('.')[0] + ".bin"
                } else {
                    savePetscii_element.value = savePetsciiFileName.split('.')[0] + ".pet"
                }
            }

            function Init() {
                document.getElementById('loadImageFile_button').onclick = function() {
                    LoadImageFile(document.getElementById('loadImageFileName_file').value);
                    UpdateOutputFileName();
                };

                document.getElementById('renderWorkingImage_button').onclick = function() {
                    RenderWorkingImage();
                };
                
                function SetupMatchExactColorAlgorithm() {
                    var matchExactColorAlgorithm_switch = document.getElementById('matchExactColorAlgorithm_switch');
                    var matchExactColorAlgorithm = matchExactColorAlgorithm_switch.checked ? true:false;
                    if (matchExactColorAlgorithm)
                    {
                        ManageSwitchSelected('minimizeColorDifferencesAlgorithm_switch', false);

                        ManageInputEnabled('blackAndWhiteDither_switch', false);
                        ManageSwitchSelected('blackAndWhiteDither_switch', true);
                        SetupBlackAndWhiteDithering();

                        ManageInputEnabled('colorBlack_switch', false);
                        ManageSwitchSelected('colorBlack_switch', false);
                        ManageInputEnabled('colorWhite_switch', false);
                        ManageSwitchSelected('colorWhite_switch', true);
                        ManageInputEnabled('colorRed_switch', false);
                        ManageSwitchSelected('colorRed_switch', false);
                        ManageInputEnabled('colorCyan_switch', false);
                        ManageSwitchSelected('colorCyan_switch', false);
                        ManageInputEnabled('colorPurple_switch', false);
                        ManageSwitchSelected('colorPurple_switch', false);
                        ManageInputEnabled('colorGreen_switch', false);
                        ManageSwitchSelected('colorGreen_switch', false);
                        ManageInputEnabled('colorBlue_switch', false);
                        ManageSwitchSelected('colorBlue_switch', false);
                        ManageInputEnabled('colorYellow_switch', false);
                        ManageSwitchSelected('colorYellow_switch', false);
                        ManageInputEnabled('colorOrange_switch', false);
                        ManageSwitchSelected('colorOrange_switch', false);
                        ManageInputEnabled('colorBrown_switch', false);
                        ManageSwitchSelected('colorBrown_switch', false);
                        ManageInputEnabled('colorLightRed_switch', false);
                        ManageSwitchSelected('colorLightRed_switch', false);
                        ManageInputEnabled('colorDarkGrey_switch', false);
                        ManageSwitchSelected('colorDarkGrey_switch', false);
                        ManageInputEnabled('colorGrey_switch', false);
                        ManageSwitchSelected('colorGrey_switch', false);
                        ManageInputEnabled('colorLightGreen_switch', false);
                        ManageSwitchSelected('colorLightGreen_switch', false);
                        ManageInputEnabled('colorLightBlue_switch', false);
                        ManageSwitchSelected('colorLightBlue_switch', false);
                        ManageInputEnabled('colorLightGrey_switch', false);
                        ManageSwitchSelected('colorLightGrey_switch', false);

                        ManageInputEnabled('backgroundColor_number', false);
                        var backgroundColor_number = document.getElementById('backgroundColor_number');
                        backgroundColor_number.value = 0;

                    } else {
                        ManageSwitchSelected('minimizeColorDifferencesAlgorithm_switch', true);

                        ManageInputEnabled('blackAndWhiteDither_switch', true);

                        ManageInputEnabled('colorBlack_switch', true);
                        ManageInputEnabled('colorWhite_switch', true);
                        ManageInputEnabled('colorRed_switch', true);
                        ManageInputEnabled('colorCyan_switch', true);
                        ManageInputEnabled('colorPurple_switch', true);
                        ManageInputEnabled('colorGreen_switch', true);
                        ManageInputEnabled('colorBlue_switch', true);
                        ManageInputEnabled('colorYellow_switch', true);
                        ManageInputEnabled('colorOrange_switch', true);
                        ManageInputEnabled('colorBrown_switch', true);
                        ManageInputEnabled('colorLightRed_switch', true);
                        ManageInputEnabled('colorDarkGrey_switch', true);
                        ManageInputEnabled('colorGrey_switch', true);
                        ManageInputEnabled('colorLightGreen_switch', true);
                        ManageInputEnabled('colorLightBlue_switch', true);
                        ManageInputEnabled('colorLightGrey_switch', true);

                        ManageInputEnabled('backgroundColor_number', true);
                    }
                }

                document.getElementById('matchExactColorAlgorithm_switch').onclick = function() {
                    SetupMatchExactColorAlgorithm();
                    SetupMinimizeColorDifferencesAlgorithm();
                };

                function SetupMinimizeColorDifferencesAlgorithm() {
                    var minimizeColorDifferencesAlgorithm_switch = document.getElementById('minimizeColorDifferencesAlgorithm_switch');
                    var minimizeColorDifferencesAlgorithm = minimizeColorDifferencesAlgorithm_switch.checked ? true:false;
                    if (minimizeColorDifferencesAlgorithm) {
                        ManageSwitchSelected('matchExactColorAlgorithm_switch', false);
                    } else {
                        ManageSwitchSelected('matchExactColorAlgorithm_switch', true);
                    }
                }

                document.getElementById('minimizeColorDifferencesAlgorithm_switch').onclick = function() {
                    SetupMinimizeColorDifferencesAlgorithm();
                    SetupMatchExactColorAlgorithm();
                };

                function SetupBlackAndWhiteDithering()
                {
                    var blackAndWhiteDither_switch = document.getElementById('blackAndWhiteDither_switch');
                    var blackAndWhiteDither_enabled = blackAndWhiteDither_switch.checked ? true:false;
                    if (blackAndWhiteDither_enabled)
                    {
                        // when dithering also perform greyscale conversion
                        ManageInputEnabled('greyscaleConversion_switch', false);
                        ManageSwitchSelected('greyscaleConversion_switch', true);
                    } else {
                        ManageInputEnabled('greyscaleConversion_switch', true);
                    }
                }

                document.getElementById('blackAndWhiteDither_switch').onclick = function() {
                    SetupBlackAndWhiteDithering();
                }

                document.getElementById('imageContrast_range').onclick = function() {
                    var imageContrast_range = document.getElementById('imageContrast_range');
                    var imageContrast_number = document.getElementById('imageContrast_number');
                    imageContrast_number.value = imageContrast_range.value;
                }

                document.getElementById('imageContrast_number').onchange = function() {
                    var imageContrast_number = document.getElementById('imageContrast_number');
                    if (imageContrast_number.value > 200) {
                        imageContrast_number.value = 200;
                    }
                    if (imageContrast_number.value < -100) {
                        imageContrast_number.value = -100;
                    }
                    var imageContrast_range = document.getElementById('imageContrast_range');
                    imageContrast_range.value = imageContrast_number.value;
                }

                document.getElementById('imageBrightness_range').onclick = function() {
                    var imageBrightness_range = document.getElementById('imageBrightness_range');
                    var imageBrightness_number = document.getElementById('imageBrightness_number');
                    imageBrightness_number.value = imageBrightness_range.value;
                }

                document.getElementById('imageBrightness_number').onchange = function() {
                    var imageBrightness_number = document.getElementById('imageBrightness_number');
                    if (imageBrightness_number.value > 400) {
                        imageBrightness_number.value = 400;
                    }
                    if (imageBrightness_number.value < -100) {
                        imageBrightness_number.value = -100;
                    }
                    var imageBrightness_range = document.getElementById('imageBrightness_range');
                    imageBrightness_range.value = imageBrightness_number.value;
                }

                document.getElementById('vic2StandardMode_switch').onclick = function() {
                    ManageSwitchSelected('vic2StandardMode_switch', true);
                    ManageSwitchSelected('vic2ExtendedMode_switch', false);
                    ManageInputEnabled('backgroundColor2_number', false);
                    ManageInputEnabled('backgroundColor3_number', false);
                    ManageInputEnabled('backgroundColor4_number', false);

                    ManageInputEnabled('characterSetExtendedGraphic64_switch', false);
                    ManageSwitchSelected('characterSetExtendedGraphic64_switch', false);
                    ManageInputEnabled('characterSetExtendedAlphaNum64_switch', false);
                    ManageSwitchSelected('characterSetExtendedAlphaNum64_switch', false);

                    ManageInputEnabled('characterSetUpper256_switch', true);
                    ManageInputEnabled('characterSetUpperLower256_switch', true);
                    ManageInputEnabled('c64OsOutput_switch', true);
                }

                document.getElementById('vic2ExtendedMode_switch').onclick = function() {
                    ManageSwitchSelected('vic2StandardMode_switch', false);
                    ManageSwitchSelected('vic2ExtendedMode_switch', true);
                    ManageInputEnabled('backgroundColor2_number', true);
                    ManageInputEnabled('backgroundColor3_number', true);
                    ManageInputEnabled('backgroundColor4_number', true);

                    ManageInputEnabled('characterSetUpper256_switch', false);
                    ManageSwitchSelected('characterSetUpper256_switch', false);
                    ManageInputEnabled('characterSetUpperLower256_switch', false);
                    ManageSwitchSelected('characterSetUpperLower256_switch', false);

                    ManageInputEnabled('characterSetExtendedGraphic64_switch', true);
                    ManageInputEnabled('characterSetExtendedAlphaNum64_switch', true);
                    ManageInputEnabled('c64OsOutput_switch', false);
                    ManageSwitchSelected('c64OsOutput_switch', false);
                    var compatibleOutput_switch = document.getElementById('compatibleOutput_switch');
                    var compatibleOutputEnabled = compatibleOutput_switch.checked ? true:false;
                    var originalOutput_switch = document.getElementById('originalOutput_switch');
                    var originalOutputEnabled = originalOutput_switch.checked ? true:false;
                    if ( (!originalOutputEnabled) && (!compatibleOutputEnabled) )
                    {
                        ManageSwitchSelected('compatibleOutput_switch', true);
                    }
                }

                document.getElementById('colorPresetBlackAndWhite_button').onclick = function() {
                    ManageSwitchSelected('colorBlack_switch', false);
                    ManageSwitchSelected('colorWhite_switch', true);
                    ManageSwitchSelected('colorRed_switch', false);
                    ManageSwitchSelected('colorCyan_switch', false);
                    ManageSwitchSelected('colorPurple_switch', false);
                    ManageSwitchSelected('colorGreen_switch', false);
                    ManageSwitchSelected('colorBlue_switch', false);
                    ManageSwitchSelected('colorYellow_switch', false);
                    ManageSwitchSelected('colorOrange_switch', false);
                    ManageSwitchSelected('colorBrown_switch', false);
                    ManageSwitchSelected('colorLightRed_switch', false);
                    ManageSwitchSelected('colorDarkGrey_switch', false);
                    ManageSwitchSelected('colorGrey_switch', false);
                    ManageSwitchSelected('colorLightGreen_switch', false);
                    ManageSwitchSelected('colorLightBlue_switch', false);
                    ManageSwitchSelected('colorLightGrey_switch', false);

                    var backgroundColor1_number = document.getElementById('backgroundColor1_number');
                    backgroundColor1_number.value = 0;
                    var vic2ExtendedMode_switch = document.getElementById('vic2ExtendedMode_switch');
                    var vic2ExtendedMode_enabled = vic2ExtendedMode_switch.checked;
                    if (vic2ExtendedMode_enabled) {
                        ManageSwitchSelected('colorBlack_switch', true);
                        var backgroundColor2_number = document.getElementById('backgroundColor2_number');
                        backgroundColor2_number.value = 1;
                        var backgroundColor3_number = document.getElementById('backgroundColor3_number');
                        backgroundColor3_number.value = 0;
                        var backgroundColor4_number = document.getElementById('backgroundColor4_number');
                        backgroundColor4_number.value = 0;
                    }
                }

                document.getElementById('colorPresetGreyscale_button').onclick = function() {
                    ManageSwitchSelected('colorBlack_switch', true);
                    ManageSwitchSelected('colorWhite_switch', true);
                    ManageSwitchSelected('colorRed_switch', false);
                    ManageSwitchSelected('colorCyan_switch', false);
                    ManageSwitchSelected('colorPurple_switch', false);
                    ManageSwitchSelected('colorGreen_switch', false);
                    ManageSwitchSelected('colorBlue_switch', false);
                    ManageSwitchSelected('colorYellow_switch', false);
                    ManageSwitchSelected('colorOrange_switch', false);
                    ManageSwitchSelected('colorBrown_switch', false);
                    ManageSwitchSelected('colorLightRed_switch', false);
                    ManageSwitchSelected('colorDarkGrey_switch', true);
                    ManageSwitchSelected('colorGrey_switch', true);
                    ManageSwitchSelected('colorLightGreen_switch', false);
                    ManageSwitchSelected('colorLightBlue_switch', false);
                    ManageSwitchSelected('colorLightGrey_switch', true);

                    var backgroundColor1_number = document.getElementById('backgroundColor1_number');
                    backgroundColor1_number.value = 12;
                    var vic2ExtendedMode_switch = document.getElementById('vic2ExtendedMode_switch');
                    var vic2ExtendedMode_enabled = vic2ExtendedMode_switch.checked;
                    if (vic2ExtendedMode_enabled) {
                        var backgroundColor2_number = document.getElementById('backgroundColor2_number');
                        backgroundColor2_number.value = 11;
                        var backgroundColor3_number = document.getElementById('backgroundColor3_number');
                        backgroundColor3_number.value = 15;
                        var backgroundColor4_number = document.getElementById('backgroundColor4_number');
                        backgroundColor4_number.value = 0;
                    }
                }

                document.getElementById('colorPresetBlues_button').onclick = function() {
                    ManageSwitchSelected('colorBlack_switch', false);
                    ManageSwitchSelected('colorWhite_switch', true);
                    ManageSwitchSelected('colorRed_switch', false);
                    ManageSwitchSelected('colorCyan_switch', true);
                    ManageSwitchSelected('colorPurple_switch', false);
                    ManageSwitchSelected('colorGreen_switch', false);
                    ManageSwitchSelected('colorBlue_switch', true);
                    ManageSwitchSelected('colorYellow_switch', false);
                    ManageSwitchSelected('colorOrange_switch', false);
                    ManageSwitchSelected('colorBrown_switch', false);
                    ManageSwitchSelected('colorLightRed_switch', false);
                    ManageSwitchSelected('colorDarkGrey_switch', false);
                    ManageSwitchSelected('colorGrey_switch', false);
                    ManageSwitchSelected('colorLightGreen_switch', false);
                    ManageSwitchSelected('colorLightBlue_switch', true);
                    ManageSwitchSelected('colorLightGrey_switch', false);

                    var backgroundColor1_number = document.getElementById('backgroundColor1_number');
                    backgroundColor1_number.value = 3;
                    var vic2ExtendedMode_switch = document.getElementById('vic2ExtendedMode_switch');
                    var vic2ExtendedMode_enabled = vic2ExtendedMode_switch.checked;
                    if (vic2ExtendedMode_enabled) {
                        var backgroundColor2_number = document.getElementById('backgroundColor2_number');
                        backgroundColor2_number.value = 6;
                        var backgroundColor3_number = document.getElementById('backgroundColor3_number');
                        backgroundColor3_number.value = 14;
                        var backgroundColor4_number = document.getElementById('backgroundColor4_number');
                        backgroundColor4_number.value = 1;
                    }
                }

                document.getElementById('colorPresetBrowns_button').onclick = function() {
                    ManageSwitchSelected('colorBlack_switch', true);
                    ManageSwitchSelected('colorWhite_switch', false);
                    ManageSwitchSelected('colorRed_switch', false);
                    ManageSwitchSelected('colorCyan_switch', false);
                    ManageSwitchSelected('colorPurple_switch', false);
                    ManageSwitchSelected('colorGreen_switch', false);
                    ManageSwitchSelected('colorBlue_switch', false);
                    ManageSwitchSelected('colorYellow_switch', false);
                    ManageSwitchSelected('colorOrange_switch', true);
                    ManageSwitchSelected('colorBrown_switch', true);
                    ManageSwitchSelected('colorLightRed_switch', false);
                    ManageSwitchSelected('colorDarkGrey_switch', true);
                    ManageSwitchSelected('colorGrey_switch', false);
                    ManageSwitchSelected('colorLightGreen_switch', false);
                    ManageSwitchSelected('colorLightBlue_switch', false);
                    ManageSwitchSelected('colorLightGrey_switch', false);

                    var backgroundColor1_number = document.getElementById('backgroundColor1_number');
                    backgroundColor1_number.value = 9;
                    var vic2ExtendedMode_switch = document.getElementById('vic2ExtendedMode_switch');
                    var vic2ExtendedMode_enabled = vic2ExtendedMode_switch.checked;
                    if (vic2ExtendedMode_enabled) {
                        var backgroundColor2_number = document.getElementById('backgroundColor2_number');
                        backgroundColor2_number.value = 8;
                        var backgroundColor3_number = document.getElementById('backgroundColor3_number');
                        backgroundColor3_number.value = 11;
                        var backgroundColor4_number = document.getElementById('backgroundColor4_number');
                        backgroundColor4_number.value = 0;
                    }
                }

                document.getElementById('colorPresetReds_button').onclick = function() {
                    ManageSwitchSelected('colorBlack_switch', false);
                    ManageSwitchSelected('colorWhite_switch', false);
                    ManageSwitchSelected('colorRed_switch', true);
                    ManageSwitchSelected('colorCyan_switch', false);
                    ManageSwitchSelected('colorPurple_switch', false);
                    ManageSwitchSelected('colorGreen_switch', false);
                    ManageSwitchSelected('colorBlue_switch', false);
                    ManageSwitchSelected('colorYellow_switch', false);
                    ManageSwitchSelected('colorOrange_switch', true);
                    ManageSwitchSelected('colorBrown_switch', true);
                    ManageSwitchSelected('colorLightRed_switch', true);
                    ManageSwitchSelected('colorDarkGrey_switch', false);
                    ManageSwitchSelected('colorGrey_switch', false);
                    ManageSwitchSelected('colorLightGreen_switch', false);
                    ManageSwitchSelected('colorLightBlue_switch', false);
                    ManageSwitchSelected('colorLightGrey_switch', false);

                    var backgroundColor1_number = document.getElementById('backgroundColor1_number');
                    backgroundColor1_number.value = 2;
                    var vic2ExtendedMode_switch = document.getElementById('vic2ExtendedMode_switch');
                    var vic2ExtendedMode_enabled = vic2ExtendedMode_switch.checked;
                    if (vic2ExtendedMode_enabled) {
                        var backgroundColor2_number = document.getElementById('backgroundColor2_number');
                        backgroundColor2_number.value = 9;
                        var backgroundColor3_number = document.getElementById('backgroundColor3_number');
                        backgroundColor3_number.value = 8;
                        var backgroundColor4_number = document.getElementById('backgroundColor4_number');
                        backgroundColor4_number.value = 10;
                    }
                }

                document.getElementById('colorPresetGreens_button').onclick = function() {
                    ManageSwitchSelected('colorBlack_switch', false);
                    ManageSwitchSelected('colorWhite_switch', false);
                    ManageSwitchSelected('colorRed_switch', false);
                    ManageSwitchSelected('colorCyan_switch', true);
                    ManageSwitchSelected('colorPurple_switch', false);
                    ManageSwitchSelected('colorGreen_switch', true);
                    ManageSwitchSelected('colorBlue_switch', false);
                    ManageSwitchSelected('colorYellow_switch', true);
                    ManageSwitchSelected('colorOrange_switch', false);
                    ManageSwitchSelected('colorBrown_switch', false);
                    ManageSwitchSelected('colorLightRed_switch', false);
                    ManageSwitchSelected('colorDarkGrey_switch', false);
                    ManageSwitchSelected('colorGrey_switch', false);
                    ManageSwitchSelected('colorLightGreen_switch', true);
                    ManageSwitchSelected('colorLightBlue_switch', false);
                    ManageSwitchSelected('colorLightGrey_switch', false);

                    var backgroundColor1_number = document.getElementById('backgroundColor1_number');
                    backgroundColor1_number.value = 5;
                    var vic2ExtendedMode_switch = document.getElementById('vic2ExtendedMode_switch');
                    var vic2ExtendedMode_enabled = vic2ExtendedMode_switch.checked;
                    if (vic2ExtendedMode_enabled) {
                        var backgroundColor2_number = document.getElementById('backgroundColor2_number');
                        backgroundColor2_number.value = 13;
                        var backgroundColor3_number = document.getElementById('backgroundColor3_number');
                        backgroundColor3_number.value = 3;
                        var backgroundColor4_number = document.getElementById('backgroundColor4_number');
                        backgroundColor4_number.value = 7;
                    }
                }

                document.getElementById('characterSetUpper256_switch').onclick = function() {
                    ManageSwitchSelected('characterSetUpper256_switch', true);
                    ManageSwitchSelected('characterSetUpperLower256_switch', false);
                    ManageSwitchSelected('characterSetExtendedGraphic64_switch', false);
                    ManageSwitchSelected('characterSetExtendedAlphaNum64_switch', false);
                    ManageSwitchSelected('characterSetCustom_switch', false);
                    ManageInputEnabled('characterSetDirectory_text', false);
                    ManageInputEnabled('characterSetSize_number', false);

                    var characterSetDirectory_text = document.getElementById('characterSetDirectory_text');
                    characterSetDirectory_text.value = "standard256-upper";
                    var characterSetSize_number = document.getElementById('characterSetSize_number');
                    characterSetSize_number.value = "256";
                };

                document.getElementById('characterSetUpperLower256_switch').onclick = function() {
                    ManageSwitchSelected('characterSetUpper256_switch', false);
                    ManageSwitchSelected('characterSetUpperLower256_switch', true);
                    ManageSwitchSelected('characterSetExtendedGraphic64_switch', false);
                    ManageSwitchSelected('characterSetExtendedAlphaNum64_switch', false);
                    ManageSwitchSelected('characterSetCustom_switch', false);
                    ManageInputEnabled('characterSetDirectory_text', false);
                    ManageInputEnabled('characterSetSize_number', false);

                    var characterSetDirectory_text = document.getElementById('characterSetDirectory_text');
                    characterSetDirectory_text.value = "standard256-upperlower";
                    var characterSetSize_number = document.getElementById('characterSetSize_number');
                    characterSetSize_number.value = "256";
                };

                document.getElementById('characterSetExtendedGraphic64_switch').onclick = function() {
                    ManageSwitchSelected('characterSetUpper256_switch', false);
                    ManageSwitchSelected('characterSetUpperLower256_switch', false);
                    ManageSwitchSelected('characterSetExtendedGraphic64_switch', true);
                    ManageSwitchSelected('characterSetExtendedAlphaNum64_switch', false);
                    ManageSwitchSelected('characterSetCustom_switch', false);
                    ManageInputEnabled('characterSetDirectory_text', false);
                    ManageInputEnabled('characterSetSize_number', false);

                    var characterSetDirectory_text = document.getElementById('characterSetDirectory_text');
                    characterSetDirectory_text.value = "extended64-graphic";
                    var characterSetSize_number = document.getElementById('characterSetSize_number');
                    characterSetSize_number.value = "64";
                };

                document.getElementById('characterSetExtendedAlphaNum64_switch').onclick = function() {
                    ManageSwitchSelected('characterSetUpper256_switch', false);
                    ManageSwitchSelected('characterSetUpperLower256_switch', false);
                    ManageSwitchSelected('characterSetExtendedGraphic64_switch', false);
                    ManageSwitchSelected('characterSetExtendedAlphaNum64_switch', true);
                    ManageSwitchSelected('characterSetCustom_switch', false);
                    ManageInputEnabled('characterSetDirectory_text', false);
                    ManageInputEnabled('characterSetSize_number', false);

                    var characterSetDirectory_text = document.getElementById('characterSetDirectory_text');
                    characterSetDirectory_text.value = "extended64-alphanum";
                    var characterSetSize_number = document.getElementById('characterSetSize_number');
                    characterSetSize_number.value = "64";
                };

                document.getElementById('characterSetCustom_switch').onclick = function() {
                    ManageSwitchSelected('characterSetUpper256_switch', false);
                    ManageSwitchSelected('characterSetUpperLower256_switch', false);
                    ManageSwitchSelected('characterSetExtendedGraphic64_switch', false);
                    ManageSwitchSelected('characterSetExtendedAlphaNum64_switch', false);
                    ManageSwitchSelected('characterSetCustom_switch', true);
                    ManageInputEnabled('characterSetDirectory_text', true);
                    ManageInputEnabled('characterSetSize_number', true);
                };

                document.getElementById('renderCharacterSets_button').onclick = function() {
                    C64_SELECTED_FOREGROUND_RGB_COLORS = [];
                    ManageSelectedColorsSwitch('colorBlack_switch', C64_RGB_COLOR_BLACK, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    ManageSelectedColorsSwitch('colorWhite_switch',  C64_RGB_COLOR_WHITE, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    ManageSelectedColorsSwitch('colorRed_switch', C64_RGB_COLOR_RED, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    ManageSelectedColorsSwitch('colorCyan_switch', C64_RGB_COLOR_CYAN, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    ManageSelectedColorsSwitch('colorPurple_switch', C64_RGB_COLOR_PURPLE, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    ManageSelectedColorsSwitch('colorGreen_switch', C64_RGB_COLOR_GREEN, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    ManageSelectedColorsSwitch('colorBlue_switch', C64_RGB_COLOR_BLUE, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    ManageSelectedColorsSwitch('colorYellow_switch', C64_RGB_COLOR_YELLOW, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    ManageSelectedColorsSwitch('colorOrange_switch', C64_RGB_COLOR_ORANGE, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    ManageSelectedColorsSwitch('colorBrown_switch', C64_RGB_COLOR_BROWN, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    ManageSelectedColorsSwitch('colorLightRed_switch', C64_RGB_COLOR_LIGHTRED, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    ManageSelectedColorsSwitch('colorDarkGrey_switch', C64_RGB_COLOR_DARKGREY, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    ManageSelectedColorsSwitch('colorGrey_switch', C64_RGB_COLOR_GREY, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    ManageSelectedColorsSwitch('colorLightGreen_switch', C64_RGB_COLOR_LIGHTGREEN, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    ManageSelectedColorsSwitch('colorLightBlue_switch', C64_RGB_COLOR_LIGHTBLUE, C64_SELECTED_FOREGROUND_RGB_COLORS);
                    ManageSelectedColorsSwitch('colorLightGrey_switch', C64_RGB_COLOR_LIGHTGREY, C64_SELECTED_FOREGROUND_RGB_COLORS);

                    C64_SELECTED_BACKGROUND_RGB_COLORS = [];
                    ManageSelectedColorsNumber('backgroundColor1_number', C64_SELECTED_BACKGROUND_RGB_COLORS);

                    // The C64 standard character mode limits accuracy of color
                    // transitions because the background color is always set to a
                    // single color (thus color transitions cannot be accurate unless
                    // they are a transition TO the background color). i.e. the
                    // white character set cannot smoothly transition to lightgrey
                    // because the background cannot be lightgrey (if it is already
                    // set to black for the screen). Thus the characters cannot share
                    // both white and lightgrey and thus be used to smooth a transition
                    // from white to lightgrey. Supporting extended (background) color
                    // mode will provide some relief as 4 separate background colors
                    // would then be supported per character. In standard character mode
                    // using monochrome (i.e. a single foreground color) will result in
                    // the most accurate transitions to/from the background color.
                    var vic2ExtendedMode_switch = document.getElementById('vic2ExtendedMode_switch');
                    var vic2ExtendedMode_enabled = vic2ExtendedMode_switch.checked;
                    if (vic2ExtendedMode_enabled) {
                        ManageSelectedColorsNumber('backgroundColor2_number', C64_SELECTED_BACKGROUND_RGB_COLORS);
                        ManageSelectedColorsNumber('backgroundColor3_number', C64_SELECTED_BACKGROUND_RGB_COLORS);
                        ManageSelectedColorsNumber('backgroundColor4_number', C64_SELECTED_BACKGROUND_RGB_COLORS);
                    }

                    RenderCharacterSets();
                }

                document.getElementById('renderPetscii_button').onclick = function() {
                    RenderPetsciiImage();
                };

                document.getElementById('savePetsciiFile_button').onclick = function() {
                    var compatibleOutput_switch = document.getElementById('compatibleOutput_switch');
                    var compatibleOutputEnabled = compatibleOutput_switch.checked ? true:false;

                    var c64OsOutput_switch = document.getElementById('c64OsOutput_switch');
                    var c64OsOutputEnabled = c64OsOutput_switch.checked ? true:false;

                    var inputFileName_file = document.getElementById('loadImageFileName_file');
                    var inputFileName = inputFileName_file.value.split('\\').pop().split('/').pop();
                    SaveByteArray(petsciiCharacterCodes, c64CharacterForegroundColors, c64CharacterBackgroundColors, inputFileName, document.getElementById('savePetsciiFileName').value, compatibleOutputEnabled, c64OsOutputEnabled);
                };

                document.getElementById('originalOutput_switch').onclick = function() {
                    ManageSwitchSelected('originalOutput_switch', true);
                    ManageSwitchSelected('compatibleOutput_switch', false);
                    ManageSwitchSelected('c64OsOutput_switch', false);
                    UpdateOutputFileName();
                    ManageInputEnabled('c64OsOutputTitle_text', false);
                    ManageInputEnabled('c64OsOutputArtist_text', false);
                    ManageInputEnabled('c64OsOutputCopyright_text', false);
                };

                document.getElementById('compatibleOutput_switch').onclick = function() {
                    ManageSwitchSelected('originalOutput_switch', false);
                    ManageSwitchSelected('compatibleOutput_switch', true);
                    ManageSwitchSelected('c64OsOutput_switch', false);
                    UpdateOutputFileName();
                    ManageInputEnabled('c64OsOutputTitle_text', false);
                    ManageInputEnabled('c64OsOutputArtist_text', false);
                    ManageInputEnabled('c64OsOutputCopyright_text', false);
                };

                document.getElementById('c64OsOutput_switch').onclick = function() {
                    ManageSwitchSelected('originalOutput_switch', false);
                    ManageSwitchSelected('compatibleOutput_switch', false);
                    ManageSwitchSelected('c64OsOutput_switch', true);
                    UpdateOutputFileName();
                    ManageInputEnabled('c64OsOutputTitle_text', true);
                    ManageInputEnabled('c64OsOutputArtist_text', true);
                    ManageInputEnabled('c64OsOutputCopyright_text', true);
                };
            }

            function LoadImageFile(inputFilePath) {
                var inputFileName = inputFilePath.split('\\').pop().split('/').pop();
                var sourceImage = document.getElementById('sourceImage');
                sourceImage.crossOrigin = "anonymous";
                sourceImage.title = inputFileName;
                sourceImage.src = inputFileName;

                var savePetscii_element = document.getElementById('savePetsciiFileName');
                savePetscii_element.value = inputFileName.split('.')[0] + ".pet"
                var c64OsOutputTitle_text = document.getElementById('c64OsOutputTitle_text');
                c64OsOutputTitle_text.value = inputFileName.split('.')[0]
            }

            function RenderWorkingImage() {
                var sourceImage = document.getElementById('sourceImage');

                var workingImageCanvas = document.getElementById('workingImageCanvas');
                var workingImageCanvasContext = workingImageCanvas.getContext("2d", { willReadFrequently: true });
                workingImageCanvasContext.drawImage(sourceImage,0,0,WIDTH,HEIGHT);

                var blackAndWhiteDither_switch = document.getElementById('blackAndWhiteDither_switch');
                var skipDithering = blackAndWhiteDither_switch.checked ? false:true;
                var greyscaleConversion_switch = document.getElementById('greyscaleConversion_switch');
                var greyscaleConversion = greyscaleConversion_switch.checked ? true:false;
                srcdata = CreateWorkingImage(workingImageCanvasContext, WIDTH, HEIGHT, skipDithering, greyscaleConversion, false, false, false); //Adjust contrast, Adjust brightness, Process negative
            }

            function RenderCharacterSets() {
                var formatCharacterSets_switch = document.getElementById('formatCharacterSets_switch');
                var formatCharacterSets = formatCharacterSets_switch.checked ? true:false;

                var character = document.getElementById("character");
                characterContainer = document.getElementById("charsetContainer");

                //clean up character elements from last run (if any)
                while (characterContainer.hasChildNodes()) {
                    characterContainer.removeChild(characterContainer.firstChild);
                }

                var characterSetSize_number = document.getElementById('characterSetSize_number');
                CHARACTERS = parseInt(characterSetSize_number.value);

                characterCanvas = [];
                var j = 0;
                for (var selectedBackgroundColorIndex=0; selectedBackgroundColorIndex<C64_SELECTED_BACKGROUND_RGB_COLORS.length; selectedBackgroundColorIndex++) {
                    for (var selectedForegroundColorIndex=0; selectedForegroundColorIndex<C64_SELECTED_FOREGROUND_RGB_COLORS.length; selectedForegroundColorIndex++) {
                        for(var i=0;i<CHARACTERS;i++) {
                            var charCanvas = document.createElement("canvas");
                            charCanvas.setAttribute("width", CWIDTH);
                            charCanvas.setAttribute("height",CHEIGHT);
                            
                            charCanvas.style.width       = CWIDTH  + "px";
                            charCanvas.style.height      = CHEIGHT + "px";
                            charCanvas.style.marginRight = "2px";
                            
                            characterContainer.appendChild(charCanvas);
                            characterCanvas.push(charCanvas);

                            if (formatCharacterSets) {
                                if((i + 1) % 32 == 0) {
                                    characterContainer.appendChild(document.createElement("br"));
                                }
                            }

                        }
                        characterContainer.appendChild(document.createElement("br"));
                        
                        character.onload = function() {
                            var charCanvas  = characterCanvas[j];
                            var charContext = charCanvas.getContext("2d", { willReadFrequently: true });
                            var calculatedBackgroundColorIndex = Math.floor(j/(CHARACTERS*C64_SELECTED_FOREGROUND_RGB_COLORS.length));
                            var calculatedForegroundColorIndex = Math.floor((j%(CHARACTERS*C64_SELECTED_FOREGROUND_RGB_COLORS.length))/CHARACTERS);
                            
                            charContext.drawImage(character, 0, 0);
                            pxbuf = CreateWorkingImage(charContext, CWIDTH, CHEIGHT, true, true, true, true, true); //Skip dithering, Perform greyscale conversion, Skip contrast, Skip brightness, Skip negative

                            // create C64 character set bytes (in C64 ROM format) for saving with C64OS format (later).
                            //If the user selects foreground == background color it will be impossible to make this later as original font color information will be overwritten (below).
                            if (j<CHARACTERS) {
                                for(var px=0; px<pxbuf.length; px+=8) {
                                    var c64CustomCharacterByte = 0x00;
                                    if(pxbuf[px  ][0] >= 128) { //because font is single color white and RGB components are equal after greyscale conversion (above) we only need to compare one color component
                                        c64CustomCharacterByte += 1;
                                    }
                                    if(pxbuf[px+1][0] >= 128) {
                                        c64CustomCharacterByte += 2;
                                    }
                                    if(pxbuf[px+2][0] >= 128) {
                                        c64CustomCharacterByte += 4;
                                    }
                                    if(pxbuf[px+3][0] >= 128) {
                                        c64CustomCharacterByte += 8;
                                    }
                                    if(pxbuf[px+4][0] >= 128) {
                                        c64CustomCharacterByte += 16;
                                    }
                                    if(pxbuf[px+5][0] >= 128) {
                                        c64CustomCharacterByte += 32;
                                    }
                                    if(pxbuf[px+6][0] >= 128) {
                                        c64CustomCharacterByte += 64;
                                    }
                                    if(pxbuf[px+7][0] >= 128) {
                                        c64CustomCharacterByte += 128;
                                    }
                                    c64CustomCharacterSetBytes[j*8 + Math.trunc(px/8)] = c64CustomCharacterByte;
                                }
                            }

                            // change character data color
                            for(var px=0; px<pxbuf.length; px++) {
                                // dithering, for a single color white font this won't change anything. set to desired color
                                if(pxbuf[px][0] < 128) { //because font is single color white and RGB components are equal after greyscale conversion (above) we only need to compare one color component
                                    pxbuf[px][0] = C64_SELECTED_BACKGROUND_RGB_COLORS[calculatedBackgroundColorIndex][0];
                                    pxbuf[px][1] = C64_SELECTED_BACKGROUND_RGB_COLORS[calculatedBackgroundColorIndex][1];
                                    pxbuf[px][2] = C64_SELECTED_BACKGROUND_RGB_COLORS[calculatedBackgroundColorIndex][2];
                                } else {
                                    pxbuf[px][0] = C64_SELECTED_FOREGROUND_RGB_COLORS[calculatedForegroundColorIndex][0];
                                    pxbuf[px][1] = C64_SELECTED_FOREGROUND_RGB_COLORS[calculatedForegroundColorIndex][1];
                                    pxbuf[px][2] = C64_SELECTED_FOREGROUND_RGB_COLORS[calculatedForegroundColorIndex][2];
                                }
                            }
                            chardata[j] = pxbuf;

                            var imageWidth = charContext.canvas.clientWidth;
                            var imageHeight = charContext.canvas.clientHeight;
                            var imageData = charContext.getImageData(0, 0, imageWidth, imageHeight);
                            var imagePixels = imageData.data;
                            // change character image color
                            for(var k=0; k<imagePixels.length; k+=4)
                            {
                                // dithering, for a single color white font this won't change anything. set to desired color
                                if (imagePixels[k  ] < 128) //because font is single color white and RGB components are equal after greyscale conversion (above) we only need to compare one color component
                                {
                                    imagePixels[k  ] = C64_SELECTED_BACKGROUND_RGB_COLORS[calculatedBackgroundColorIndex][0];
                                    imagePixels[k+1] = C64_SELECTED_BACKGROUND_RGB_COLORS[calculatedBackgroundColorIndex][1];
                                    imagePixels[k+2] = C64_SELECTED_BACKGROUND_RGB_COLORS[calculatedBackgroundColorIndex][2];
                                } else {
                                    imagePixels[k  ] = C64_SELECTED_FOREGROUND_RGB_COLORS[calculatedForegroundColorIndex][0];
                                    imagePixels[k+1] = C64_SELECTED_FOREGROUND_RGB_COLORS[calculatedForegroundColorIndex][1];
                                    imagePixels[k+2] = C64_SELECTED_FOREGROUND_RGB_COLORS[calculatedForegroundColorIndex][2];
                                }
                                imagePixels[k+3] = 255;
                            }
                            charContext.putImageData(imageData, 0, 0);

                            j++;
                            loadCharacter();
                        };

                        var loadCharacter = function() {
                            if(j >= (CHARACTERS*C64_SELECTED_FOREGROUND_RGB_COLORS.length*C64_SELECTED_BACKGROUND_RGB_COLORS.length)) {
                                return;
                            }
                            var characterSetDirectory_text = document.getElementById('characterSetDirectory_text');
                            character.src = characterSetDirectory_text.value + "/" + (j%CHARACTERS) + ".gif";
                        };
                        
                        loadCharacter();
                    }
                }
            }

            function RenderPetsciiImage() {
                var minimizeColorDifferencesAlgorithm_switch = document.getElementById('minimizeColorDifferencesAlgorithm_switch');
                var minimizeColorDifferencesAlgorithm = minimizeColorDifferencesAlgorithm_switch.checked ? true:false;
                var useGraphicsCharactersOnly_switch = document.getElementById('useGraphicsCharactersOnly_switch');
                var useGraphicsCharactersOnly = useGraphicsCharactersOnly_switch.checked ? true:false;

                var canvas = document.getElementById('canvas');
                var canvasContext = canvas.getContext("2d", { willReadFrequently: true });
                Render(canvasContext,minimizeColorDifferencesAlgorithm,useGraphicsCharactersOnly);
            }
            
            function WeightAlphaChannel(color, alpha) {
                //Weight the alpha channel. --Thanks to Chris Roy!
                var aDiff = 256 - alpha;
                var gDiff = 256 - color;
                var newColor = (gDiff * aDiff / 256) + color;
                return newColor;
            }

            function CreateWorkingImage(context,w,h,skipDithering,greyscaleConversion, skipContrast, skipBrightness, skipNegative) {
                var imgd = context.getImageData(0, 0, w,h);

                if (!skipContrast) {
                    var imageContrast_number = document.getElementById('imageContrast_number');
                    contrast = parseInt(imageContrast_number.value);
                    if (contrast != 0) {
                        imgd = ContrastImage(imgd, contrast);
                    } 
                }

                if (!skipBrightness) {
                    var imageBrightness_number = document.getElementById('imageBrightness_number');
                    brightness = parseInt(imageBrightness_number.value);
                    if (brightness != 0) {
                        imgd = BrightnessImage(imgd, brightness);
                    }
                }

                if (!skipNegative) {
                    var imageNegative_switch = document.getElementById('imageNegative_switch');
                    negative_selected = imageNegative_switch.checked;
                    if (negative_selected) {
                        imgd = NegativeImage(imgd);
                    }
                }

                var pix  = imgd.data;
                
                var x = 0;
                var y = 0;
                
                var id = context.createImageData(1,1);
                var d  = id.data;
                
                var ebBuf = [];
                
                for(var i=0,il=pix.length;i<il;i+=4) {
                    var newRed;
                    var newGreen;
                    var newBlue;

                    if (greyscaleConversion)
                    {
                        newRed   = pix[i  ] * .3 + 
                                   pix[i+1] * .59 + 
                                   pix[i+2] * .11;
                        newGreen = newRed;
                        newBlue  = newRed;
                    } else {
                        newRed   = pix[i  ]; 
                        newGreen = pix[i+1];
                        newBlue  = pix[i+2];
                    }
                    newColor = [newRed, newGreen, newBlue];
                    ebBuf.push(newColor);
                }
                
                if (!skipDithering) {
                    Dither(ebBuf,w,h);
                }
                
                for(var i=0;i<ebBuf.length;i++) {
                    d[0] = ebBuf[i][0];
                    d[1] = ebBuf[i][1];
                    d[2] = ebBuf[i][2];
                    d[3] = 255;
                    context.putImageData(id,x,y);                

                    x++;
                    if(x >= WIDTH) {
                        x = 0;
                        y++;
                    }
                }
                
                return ebBuf;
            }

            // refer to: https://stackoverflow.com/questions/10521978/html5-canvas-image-contrast
            function ContrastImage(imageData, contrast) {  //input range [-100..200]
                var data = imageData.data;
                contrast = (contrast/100) + 1; //convert to decimal and shift range: [0..3]
                var intercept = 259 * (1 - contrast);
                for(var i=0; i<data.length; i+=4) {   //r,g,b,a
                    data[i  ] = Math.min(Math.trunc(data[i  ] * contrast + intercept), 255);
                    data[i+1] = Math.min(Math.trunc(data[i+1] * contrast + intercept), 255);
                    data[i+2] = Math.min(Math.trunc(data[i+2] * contrast + intercept), 255);
                }
                return imageData;
            }

            // refer to: https://hackernoon.com/image-processing-algorithms-adjusting-contrast-and-image-brightness-0y4y318a
            function BrightnessImage(imageData, brightness) {  //input range [-100..400]
                var data = imageData.data;
                brightness = brightness / 100; //shift range: [-1..4]
                for(var i=0; i<data.length; i+=4) {   //r,g,b,a
                    data[i  ] = Math.trunc(data[i  ] * (1 + brightness));
                    data[i+1] = Math.trunc(data[i+1] * (1 + brightness));
                    data[i+2] = Math.trunc(data[i+2] * (1 + brightness));
                }
                return imageData;
            };

            function NegativeImage(imageData) {
                var data = imageData.data;
                for(var i=0; i<data.length; i+=4) {   //r,g,b,a
                    data[i  ] = 255 - data[i  ];
                    data[i+1] = 255 - data[i+1];
                    data[i+2] = 255 - data[i+2];
                }
                return imageData;
            };

            // dithering from greyscale to a two-color image (black/white)
            function Dither(sb, w, h) {   // source buffer, width, height
                for(var y=0; y<h; y++) {
                    for(var x=0; x<w; x++) {
                        var ci = y*w+x;               // current buffer index
                        var cc = sb[ci][0];           // current color (red, red component is same as green and blue since its a greyscale image)
                        var rc = (cc<128?0:255);      // real (rounded) color
                        var err = cc-rc;              // error amount

                        sb[ci][0] = rc;                  // saving real color (red)
                        sb[ci][1] = rc;                  // saving real color (green, since image is greyscale color is the same as red)
                        sb[ci][2] = rc;                  // saving real color (blue, since image is greyscale color is the same as red)

                        if(x+1 < w) {
                            sb[ci+1][0] += (err*7)>>4;  // if right neighbour exists (red)
                            sb[ci+1][1] += (err*7)>>4;  // if right neighbour exists (green)
                            sb[ci+1][2] += (err*7)>>4;  // if right neighbour exists (blue)
                        }
    
                        // if there is another line below our current image line then use it for rounding error
                        if(y+1 < h) {
                            if(x > 0) {
                                sb[ci+w-1][0] += (err*3)>>4;  // bottom left neighbour (red)
                                sb[ci+w-1][1] += (err*3)>>4;  // bottom left neighbour (green)
                                sb[ci+w-1][2] += (err*3)>>4;  // bottom left neighbour (blue)
                            }

                            sb[ci+w][0] += (err*5)>>4;  // bottom neighbour (red)
                            sb[ci+w][1] += (err*5)>>4;  // bottom neighbour (green)
                            sb[ci+w][2] += (err*5)>>4;  // bottom neighbour (blue)

                            if(x+1 < w) {
                                sb[ci+w+1][0] += (err*1)>>4;  // bottom right neighbour (red)
                                sb[ci+w+1][1] += (err*1)>>4;  // bottom right neighbour (green)
                                sb[ci+w+1][2] += (err*1)>>4;  // bottom right neighbour (blue)
                            }
                        }
                    }
                }
            }
            
            function Render(canvasContext,minimizeColorDifferencesAlgorithm,useGraphicsCharactersOnly) {
                var charsWide = WIDTH  / CWIDTH;
                var charsHigh = HEIGHT / CHEIGHT;
                
                var charCount = charsWide * charsHigh;
                
                var characterIndex = 0;
                for(var y=0;y<charsHigh;y++) {
                    for(var x=0;x<charsWide;x++) {
                        var imageBuf  = GetCharacterSizedPartOfSourceImage(characterIndex);
                        var matchValues = FindMatch(imageBuf,minimizeColorDifferencesAlgorithm,useGraphicsCharactersOnly);
                        c64CharacterForegroundColors[characterIndex] = GetC64ColorCode(C64_SELECTED_FOREGROUND_RGB_COLORS[matchValues.selectedForegroundColorIndex]);
                        c64CharacterBackgroundColors[characterIndex] = GetC64ColorCode(C64_SELECTED_BACKGROUND_RGB_COLORS[matchValues.selectedBackgroundColorIndex]);
                        var characterSetOffset = matchValues.selectedForegroundColorIndex*CHARACTERS + matchValues.selectedBackgroundColorIndex*C64_SELECTED_FOREGROUND_RGB_COLORS.length;
                        canvasContext.drawImage(characterCanvas[matchValues.characterOffset], x*CWIDTH, y*CHEIGHT);
                        petsciiCharacterCodes[characterIndex] = matchValues.characterOffset - characterSetOffset;
                        characterIndex++;
                    }
                }
            }
            
            function GetCharacterSizedPartOfSourceImage(characterIndex) {
                var charsWide = (WIDTH  / CWIDTH); // 320 / 8 = 40
                
                var bytesPerRastRow = CWIDTH  * charsWide; // 8 * 40 = 320
                var bytesPerCharRow = CHEIGHT * bytesPerRastRow; // 8 * 320 = 2560
                
                var startByte = 0;
                while(characterIndex > charsWide) {
                    startByte += bytesPerCharRow;
                    characterIndex -= charsWide;
                }
                
                while(characterIndex) {
                    startByte += CWIDTH;
                    characterIndex--;
                }
                
                var charBuf = [];
                for(var y=0;y<CHEIGHT;y++) {
                    for(var x=0;x<CWIDTH;x++) {
                        charBuf.push(srcdata[startByte+x]);
                    }
                    startByte += bytesPerRastRow;
                }
                
                return charBuf;
            }
            
            function FindMatch(imageBuf, minimizeColorDifferencesAlgorithm, useGraphicsCharactersOnly) {
                var maximumDifference = (CWIDTH * CHEIGHT);
                if (minimizeColorDifferencesAlgorithm) {
                    maximumDifference *= 3*255;
                }
                maximumDifference++;
                var smallestDifference = maximumDifference;
                var bestMatch = {characterOffset: 0, selectedForegroundColorIndex: 0, selectedBackgroundColorIndex: 0};
                
                // check the current character against all available colors for the best match.
                for(var i=0; i<CHARACTERS*C64_SELECTED_FOREGROUND_RGB_COLORS.length*C64_SELECTED_BACKGROUND_RGB_COLORS.length; i++) {
                    if ( (!useGraphicsCharactersOnly) || ((i%128) >= 64) ) {
                        var currentDifference = Diff(imageBuf, chardata[i], minimizeColorDifferencesAlgorithm);
                        if(currentDifference < smallestDifference) {
                            bestMatch.characterOffset = i;
                            bestMatch.selectedBackgroundColorIndex = Math.floor(i/(CHARACTERS*C64_SELECTED_FOREGROUND_RGB_COLORS.length));
                            bestMatch.selectedForegroundColorIndex = Math.floor((i%(CHARACTERS*C64_SELECTED_FOREGROUND_RGB_COLORS.length))/CHARACTERS);
                            smallestDifference = currentDifference;
                            if(currentDifference == 0) {
                                break; //Perfect Match.
                            }
                        }
                    }
                }
                
                return bestMatch;
            }
            
            function Diff(bufa, bufb, minimizeColorDifferencesAlgorithm) {
                var difference = 0;
                for(var i=0; i<bufa.length; i++) {
                    if (minimizeColorDifferencesAlgorithm) {
                        difference += Math.abs(bufa[i][0] - bufb[i][0]) + Math.abs(bufa[i][1] - bufb[i][1]) + Math.abs(bufa[i][2] - bufb[i][2]);
                    } else { //matchExactColorAlgorithm
                        if ( (bufa[i][0] != bufb[i][0]) || (bufa[i][1] != bufb[i][1]) || (bufa[i][2] != bufb[i][2]) ) {
                            difference++;
                        }
                    }
                }
                return difference;
            }
        </script>

        <h2><center>C64 PETSCII Art Generator v5</center></h2>
        <center>Originally written by Gregory Nacu, <a href="https://c64os.com">C64OS.com</a></center></b>
        <center>Enhancements by Warren Wilbur</center>

        <h3>1. Select any image file in the same directory as petscii_converter.html</h3>

        <i>Loading source images and character set images requires support for cross origin file loading. To do this start chrome on the command line with the --allow-file-access-from-files option. e.g. "D:\Program Files (x86)\Google\Chrome\Application\chrome.exe" --allow-file-access-from-files file:///D:/petsciirender/petscii_converter.html</i><br><br>
        <input type="file" value='Sample Images/s_classic.png' id="loadImageFileName_file" />
        <input type='button' value='Load Image File' id='loadImageFile_button'>
        <br>

        <h3>Original Image</h3>
        <img src='Sample Images/s_classic.png' id='sourceImage' style='width:320px;height:200px;'>

        <h3>2. Make image adjustments and click to Render Working Image</h3>

        <h5>2.1. Select algorithm for rendering the PETSCII image</h5>
        <input type="checkbox" id="matchExactColorAlgorithm_switch" class="checkbox" />
        <label for="matchExactColorAlgorithm_switch">Use 'match exact color' algorithm</label>&nbsp;&nbsp;&nbsp;

        <input type="checkbox" id="minimizeColorDifferencesAlgorithm_switch" checked class="checkbox" />
        <label for="minimizeColorDifferencesAlgorithm_switch">Use 'minimize absolute color differences' algorithm</label><br>

        <h5>2.2. Select working image adjustments to enhance output</h5>
        <input type="checkbox" id="blackAndWhiteDither_switch" class="checkbox" />
        <label for="blackAndWhiteDither_switch">Dither to a two-color image (black/white)</label>&nbsp;&nbsp;&nbsp;

        <input type="checkbox" id="greyscaleConversion_switch" class="checkbox" />
        <label for="greyscaleConversion_switch">Convert to greyscale image</label>&nbsp;&nbsp;&nbsp;

        <input type="checkbox" id="imageNegative_switch" name="imageNegative_switch" />
        <label id="imageNegative_label" for="imageNegative_switch">Image negative</label>
        <br><br>

        <label id="imageContrast_label" for="imageContrast_number">Image Contrast (-100..200 percent):</label><br>
        <input type="range" id="imageContrast_range" name="imageContrast_range" min="-100" max="200" value="0" style="width:80%" />
        <input type="number" id="imageContrast_number" name="imageContrast_number" min="-100" max="200" value="0" style="width:60px" />
        <br>
        <label id="imageBrightness_label" for="imageBrightness_number">Image Brightness (-100..400 percent):</label><br>
        <input type="range" id="imageBrightness_range" name="imageBrightness_range" min="-100" max="400" value="0" style="width:80%" />
        <input type="number" id="imageBrightness_number" name="imageBrightness_number" min="-100" max="400" value="0" style="width:60px" />
        <br><br>

        <input type='button' value='Render Working Image' id='renderWorkingImage_button'>

        <h3>Working Image</h3>
        <canvas width=320 height=200 style='width:320px;height:200px;' id='workingImageCanvas'></canvas>

        <h3>3. Choose colors and click to Render Character Sets</h3>
        <h5>3.1. Choose VIC-II character graphics mode</h3>
        <input type="checkbox" id="vic2StandardMode_switch" checked class="checkbox" />
        <label for="colorBlack_switch">Standard Character Mode (256 characters, 16 foreground colors, 1 background color)</label>
        <br>

        <input type="checkbox" id="vic2ExtendedMode_switch" class="checkbox" />
        <label for="colorBlack_switch">Extended (Background) Color Mode (64 characters, 16 foreground colors, 4 background colors)</label>
        <br><br>

        Color presets:
        <input type="button" id="colorPresetBlackAndWhite_button" class="styled" value="Black/White"/>
        <input type="button" id="colorPresetGreyscale_button" class="styled" value="Greyscales"/>
        <input type="button" id="colorPresetBlues_button" class="styled" value="Blues"/>
        <input type="button" id="colorPresetBrowns_button" class="styled" value="Browns"/>
        <input type="button" id="colorPresetReds_button" class="styled" value="Reds"/>
        <input type="button" id="colorPresetGreens_button" class="styled" value="Greens"/>

        <h5>3.2. Choose character set foreground colors</h3>
        <input type="checkbox" id="colorBlack_switch" checked class="checkbox" />
        <label for="colorBlack_switch">Black(0)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorWhite_switch" checked class="checkbox" />
        <label for="colorWhite_switch">White(1)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorRed_switch" checked class="checkbox" />
        <label for="colorRed_switch">Red(2)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorCyan_switch" checked class="checkbox" />
        <label for="colorCyan_switch">Cyan(3)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorPurple_switch" checked class="checkbox" />
        <label for="colorPurple_switch">Purple(4)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorGreen_switch" checked class="checkbox" />
        <label for="colorGreen_switch">Green(5)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorBlue_switch" checked class="checkbox" />
        <label for="colorBlue_switch">Blue(6)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorYellow_switch" checked class="checkbox" />
        <label for="colorYellow_switch">Yellow(7)</label>&nbsp;&nbsp;&nbsp;<br>
        <input type="checkbox" id="colorOrange_switch" checked class="checkbox" />
        <label for="colorOrange_switch">Orange(8)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorBrown_switch" checked class="checkbox" />
        <label for="colorBrown_switch">Brown(9)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorLightRed_switch" checked class="checkbox" />
        <label for="colorLightRed_switch">Light Red(10)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorDarkGrey_switch" checked class="checkbox" />
        <label for="colorDarkGrey_switch">Dark Grey(11)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorGrey_switch" checked class="checkbox" />
        <label for="colorGrey_switch">Grey(12)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorLightGreen_switch" checked class="checkbox" />
        <label for="colorLightGreen_switch">Light Green(13)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorLightBlue_switch" checked class="checkbox" />
        <label for="colorLightBlue_switch">Light Blue(14)</label>&nbsp;&nbsp;&nbsp;
        <input type="checkbox" id="colorLightGrey_switch" checked class="checkbox" />
        <label for="colorLightGrey_switch">Light Grey(15)</label>&nbsp;&nbsp;&nbsp;

        <h5>3.3. Choose character set background color</h3>
        <label for="backgroundColor1_number">Background color1 (between 0 and 15):</label>&nbsp;&nbsp;&nbsp;
        <input type="number" id="backgroundColor1_number" value="0" name="backgroundColor1_number" min="0" max="15">
        <br>
        <label for="backgroundColor2_number">Background color2 (between 0 and 15):</label>&nbsp;&nbsp;&nbsp;
        <input type="number" id="backgroundColor2_number" value="0" name="backgroundColor2_number" disabled min="0" max="15">
        <br>
        <label for="backgroundColor3_number">Background color3 (between 0 and 15):</label>&nbsp;&nbsp;&nbsp;
        <input type="number" id="backgroundColor3_number" value="0" name="backgroundColor3_number" disabled min="0" max="15">
        <br>
        <label for="backgroundColor4_number">Background color4 (between 0 and 15):</label>&nbsp;&nbsp;&nbsp;
        <input type="number" id="backgroundColor4_number" value="0" name="backgroundColor4_number" disabled min="0" max="15">
        <br>
        <p><small>When creating a multi-color PETSCII rendering the single most
        important choice that determines the quality of your output is the
        background color. Try several colors and try to use the color which has
        the most (color) transitions in the image. Your best case will occur
        when a single (background) color has nearly all the color transitions
        (i.e. borders with other colors) in the image.</small></p>

        <h5>3.4. Choose your character set</h3>

        <h6>3.4.1. Standard Character Mode</h6>
        <input type="checkbox" id="characterSetUpper256_switch" checked class="checkbox" />
        <label for="characterSetUpper256_switch">C64 US upper case standard (256 characters)</label>&nbsp;&nbsp;&nbsp;
        <br>
        <input type="checkbox" id="characterSetUpperLower256_switch" class="checkbox" />
        <label for="characterSetUpperLower256_switch">C64 US lower case standard (256 characters)</label>&nbsp;&nbsp;&nbsp;

        <h6>3.4.2. Extended (Background) Color Mode</h6>
        <input type="checkbox" id="characterSetExtendedGraphic64_switch" disabled class="checkbox" />
        <label for="characterSetExtendedGraphic64_switch">C64 US upper case extended graphic (64 characters, numbers 64-127 of the standard upper case set)</label>&nbsp;&nbsp;&nbsp;
        <br>
        <input type="checkbox" id="characterSetExtendedAlphaNum64_switch" disabled class="checkbox" />
        <label for="characterSetExtendedAlphaNum64_switch">C64 US upper case extended alpha-numeric (64 characters, numbers 0-63 of the standard upper case set)</label>&nbsp;&nbsp;&nbsp;

        <h6>3.4.3. Custom Settings (use breakout-charset.py to prepare your own custom character sets)</h6>
        <input type="checkbox" id="characterSetCustom_switch" class="checkbox" />
        <label for="characterSetCustom_switch">Custom</label>
        <br>
        <label for="characterSetDirectory_text">Enter the directory containing your character set</label>
        <input type="text" value="standard256-upper" id="characterSetDirectory_text" disabled />
        <br>
        <label for="characterSetSize_number">Enter the number of characters in your character set</label>
        <input type="number" id="characterSetSize_number" value="256" min="1" max="256" disabled />
        <br><br>

        <input type="checkbox" id="formatCharacterSets_switch" class="checkbox" />
        <label for="colorLightGrey_switch">Format rendering of character sets into 32 characters per row</label>
        <br><br>

        <input type='button' value='Render Character Sets' id='renderCharacterSets_button'>

        <h3>Character Sets for PETSCII Rendering</h3>
        <div id='charsetContainer'></div>
        <img src='' id='character' style='display:none;'>

        <h3>4. After generating Character Sets, click to render PETSCII image</h3>
        <input type="checkbox" id="useGraphicsCharactersOnly_switch" class="checkbox" />
        <label for="useGraphicsCharactersOnly_switch">Only use graphics characters (from the C64 upper case character set)</label>
        <br><br>
        <input type='button' value='Render PETSCII' id='renderPetscii_button'>

        <h3>PETSCII Rendered Image</h3>
        <canvas width=320 height=200 style='width:320px;height:200px;' id='canvas'></canvas>

        <h3>5. After rendering Canvas image, enter filename and click to save PETSCII mosaic to file</h3>
        <input type="checkbox" id="originalOutput_switch" class="checkbox" />
        <label for="originalOutput_switch">Enable original output format (binary)</label>&nbsp;&nbsp;&nbsp;
        <br>
        <input type="checkbox" id="compatibleOutput_switch" checked class="checkbox" />
        <label for="compatibleOutput_switch">Enable .C output format (text)</label>&nbsp;&nbsp;&nbsp;
        <br>
        <input type="checkbox" id="c64OsOutput_switch" class="checkbox" />
        <label for="c64OsOutput_switch">Enable C64OS output format (binary)</label>&nbsp;&nbsp;&nbsp;
        <br>
        <label for="c64OsOutputTitle_text">Enter title (16 chars)</label>
        <input type="text" id="c64OsOutputTitle_text" value="UNKNOWN" maxlength="16" disabled />
        <br>
        <label for="c64OsOutputArtist_text">Enter artist name (16 chars)</label>
        <input type="text" id="c64OsOutputArtist_text" value="ANONYMOUS" maxlength="16" disabled />
        <br>
        <label for="c64OsOutputCopyright_text">Copyright string (16 chars)</label>
        <input type="text" id="c64OsOutputCopyright_text" value="NOT SPECIFIED" maxlength="16" disabled />
        <br><br>

        <input type='text' value='petsciiart.pet' id='savePetsciiFileName'>
        <input type='button' value='Save PETSCII File' id='savePetsciiFile_button'>
        <br><br>
    </body>
</html>
